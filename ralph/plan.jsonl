{"t": "spec", "spec": "debug-dashboard-validation.md"}
{"t": "task", "id": "t-o25v", "spec": "debug-dashboard-validation.md", "name": "Create test_sse_dashboard.c with Test 1.1 (SSE lifecycle)", "s": "p", "notes": "File: test/test_sse_dashboard.c. Test SSE connection lifecycle: connect, receive full diagnostics event, receive diagnostics-delta events, disconnect cleanly. Verify on-close callback fires, timer stops after close. Look at existing test/unit/test_metrics_delta.c for test patterns.", "accept": "make test passes with new test, test verifies first event is diagnostics (full), subsequent are diagnostics-delta"}
{"t": "task", "id": "t-ptwl", "spec": "debug-dashboard-validation.md", "name": "Add Test 1.2 to test_sse_dashboard.c (delta accuracy)", "s": "p", "notes": "Add test to test/test_sse_dashboard.c. Increment counter 100 times between events, verify sum of delta increments = 100, verify no negative deltas. Use existing metrics_v2 API to increment counters.", "accept": "Test verifies delta accuracy: sum of increments matches expected, no negative values", "deps": ["t-o25v"]}
{"t": "task", "id": "t-ag3c", "spec": "debug-dashboard-validation.md", "name": "Add Test 1.3 to test_sse_dashboard.c (fresh state endpoint)", "s": "p", "notes": "Add test for /debug/metrics/state endpoint. Verify: JSON valid with metrics and memory keys, response time < 100ms. May need to add aio/diagnostics-state-json builtin first if not present.", "accept": "Test verifies /debug/metrics/state returns valid JSON with correct structure", "deps": ["t-o25v"]}
{"t": "task", "id": "t-vbtd", "spec": "debug-dashboard-validation.md", "name": "Add Test 1.4 to test_sse_dashboard.c (Prometheus endpoint)", "s": "p", "notes": "Add test for /metrics endpoint. Verify: all metric names valid (no spaces, valid chars), all values parseable as numbers. Use existing Prometheus format code in metrics_delta.c.", "accept": "Test verifies /metrics returns valid Prometheus exposition format", "deps": ["t-o25v"]}
{"t": "task", "id": "t-d1xy", "spec": "debug-dashboard-validation.md", "name": "Create test_sse_concurrent.c with Test 2.1 (10 concurrent connections)", "s": "p", "notes": "File: test/stress/test_sse_concurrent.c. Connect 10 SSE clients simultaneously, verify all receive events within 500ms, measure CPU usage. Target: <2x single connection when global timer implemented. Look at test/stress/ for stress test patterns.", "accept": "make test passes, stress test connects 10 clients and verifies all receive events", "deps": ["t-o25v"]}
{"t": "task", "id": "t-z59a", "spec": "debug-dashboard-validation.md", "name": "Add Test 2.2 to test_sse_concurrent.c (connection churn)", "s": "p", "notes": "Add test to test/stress/test_sse_concurrent.c. Connect/disconnect 10 clients per second for 60 seconds. Verify: no memory leaks (valgrind clean), no zombie timers, active connection count accurate throughout.", "accept": "Stress test passes, valgrind shows no leaks, connection counts stay accurate", "deps": ["t-d1xy"]}
{"t": "task", "id": "t-vahh", "spec": "debug-dashboard-validation.md", "name": "Add Test 2.3 to test_sse_concurrent.c (concurrent metric updates)", "s": "p", "notes": "Add test to test/stress/test_sse_concurrent.c. Spawn worker thread updating metrics rapidly while SSE collecting. Verify: snapshots are consistent (no torn reads), counter monotonicity preserved.", "accept": "Test passes under TSAN, no data races detected, counters always monotonic", "deps": ["t-d1xy"]}
{"t": "task", "id": "t-l6u0", "spec": "debug-dashboard-validation.md", "name": "Add Test 2.4 to test_sse_concurrent.c (delta baseline isolation)", "s": "p", "notes": "Add test to test/stress/test_sse_concurrent.c. Two connections (A, B) active. Connection A receives delta, connection B receives delta 50ms later. Verify both deltas correct for their own baseline (not cross-contaminated). Tests per-connection baseline in valk_delta_snapshot_collect_stateless().", "accept": "Test verifies each connection gets correct deltas based on its own baseline", "deps": ["t-d1xy"]}
{"t": "task", "id": "t-m1le", "spec": "debug-dashboard-validation.md", "name": "Create aio_sse_stream_registry.h header", "s": "p", "notes": "File: src/aio/aio_sse_stream_registry.h. Define valk_sse_stream_registry_t (doubly-linked list of streams, single timer), valk_sse_stream_entry_t (per-stream state with baseline). Subscribe/unsubscribe API. See docs/plan-sse-stream-metrics.md for detailed design.", "accept": "Header compiles, defines registry struct, entry struct, and all public API functions"}
{"t": "task", "id": "t-mpdm", "spec": "debug-dashboard-validation.md", "name": "Implement aio_sse_stream_registry.c", "s": "p", "notes": "File: src/aio/aio_sse_stream_registry.c. Implement valk_sse_registry_init(), valk_sse_registry_subscribe(), valk_sse_registry_unsubscribe(). Timer callback: collect once, push to all streams. Start timer if first subscriber, stop if last. See docs/plan-sse-stream-metrics.md.", "accept": "Implementation compiles, unit tests for subscribe/unsubscribe pass", "deps": ["t-m1le"]}
{"t": "task", "id": "t-gqe1", "spec": "debug-dashboard-validation.md", "name": "Integrate SSE registry into AIO system", "s": "p", "notes": "Modify src/aio/aio_uv.c and src/aio/aio.h. Add registry to valk_aio_system_t, init in valk_aio_start_with_config(), cleanup in shutdown path. Hook connection close to unsubscribe_connection(). Add valk_aio_get_sse_registry() accessor.", "accept": "make build passes, registry initialized on AIO start, cleaned up on stop", "deps": ["t-mpdm"]}
{"t": "task", "id": "t-761i", "spec": "debug-dashboard-validation.md", "name": "Add safe lifecycle management to SSE registry", "s": "p", "notes": "In aio_sse_stream_registry.c: Add atomic active flag on entries, timer callback checks: active, session valid, stream open. Add being_removed flag for double-remove guard. Build removal list before modifying (no mutation during iteration). See docs/plan-sse-stream-metrics.md lifetime management section.", "accept": "TSAN clean, no use-after-free, no double-free on connection close races", "deps": ["t-mpdm"]}
{"t": "task", "id": "t-rw6g", "spec": "debug-dashboard-validation.md", "name": "Update debug.valk to use SSE registry", "s": "p", "notes": "Modify src/modules/aio/debug.valk. Replace aio/interval with registry subscribe via new builtin (sse-registry/subscribe-deltas or similar). Remove per-connection timer logic. Verify backward compatibility with existing dashboard.", "accept": "Dashboard works with registry, single timer serves all connections, make test passes", "deps": ["t-gqe1"]}
{"t": "task", "id": "t-an3e", "spec": "debug-dashboard-validation.md", "name": "Track consecutive backpressure events in SSE registry", "s": "p", "notes": "In aio_sse_stream_registry.c: Add backpressure_count to stream entry. Increment when stream/writable? returns false. Reset on successful write.", "accept": "Backpressure count tracked per-stream, reset correctly on successful write", "deps": ["t-761i"]}
{"t": "task", "id": "t-szy6", "spec": "debug-dashboard-validation.md", "name": "Disconnect slow SSE clients exceeding backpressure threshold", "s": "p", "notes": "In aio_sse_stream_registry.c: Threshold 10 consecutive skipped events (1 second at 100ms). Close stream with appropriate error code. Log disconnection with client info.", "accept": "Slow clients auto-disconnected after threshold, logged appropriately", "deps": ["t-an3e"]}
{"t": "task", "id": "t-e66f", "spec": "debug-dashboard-validation.md", "name": "Add Test 4.3 for backpressure handling", "s": "p", "notes": "In test/stress/test_sse_concurrent.c or test/test_sse_dashboard.c: Create slow client (dont read from socket). Verify client disconnected after threshold. Verify fast clients unaffected.", "accept": "Test verifies slow client disconnected, fast clients still receive events", "deps": ["t-szy6"]}
