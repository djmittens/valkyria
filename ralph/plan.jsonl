{"t": "spec", "spec": "deprecate-atoms.md"}
{"t": "task", "id": "t-5tx6hx", "spec": "deprecate-atoms.md", "name": "Implement aio/semaphore builtin", "s": "p", "notes": "Add aio/semaphore functionality to src/aio/aio_combinators.c: 1) Define valk_semaphore_t struct with max_permits, available count, and queue for waiting handles, 2) Implement valk_builtin_aio_semaphore(aio, n) to create semaphore with n permits, 3) Implement valk_builtin_aio_semaphore_acquire(sem) returning future that completes when permit acquired, 4) Implement valk_builtin_aio_semaphore_release(sem) to release permit, 5) Register builtins in parser.c, 6) Handle queueing/completion for waiting handles when permits not available", "accept": "aio/semaphore creates semaphore, aio/semaphore-acquire blocks when no permits, aio/semaphore-release unblocks waiting handles"}
{"t": "task", "id": "t-5ywar0", "spec": "deprecate-atoms.md", "name": "Implement stream/closed builtin", "s": "p", "notes": "Add stream/closed functionality to src/aio/http2/stream/aio_stream_builtins.c: 1) Implement valk_builtin_stream_closed(stream) function that returns handle, 2) The handle should complete with :closed when the stream closes, 3) Hook into existing stream close events to complete waiting handles, 4) Register builtin in parser.c, 5) Follow pattern of other handle-returning async functions", "accept": "stream/closed returns handle that completes with :closed when stream closes"}
{"t": "task", "id": "t-6e05zz", "spec": "deprecate-atoms.md", "name": "Add tests for new aio functions", "s": "p", "notes": "Create comprehensive tests for new functionality: 1) Create test/test_aio_semaphore.valk with tests for acquire/release/blocking behavior, permit counting, concurrent access, 2) Add stream/closed tests to test/test_sse_builtins.valk showing handle completion when stream closes, 3) Test edge cases: zero permits, multiple waiters, release without acquire, closed stream behavior", "accept": "test/test_aio_semaphore.valk and test/test_sse_builtins.valk tests pass and demonstrate correct semaphore and stream/closed behavior", "deps": ["t-5tx6hx", "t-5ywar0"]}
{"t": "task", "id": "t-ly03eq", "spec": "deprecate-atoms.md", "name": "Refactor test framework to remove atoms", "s": "p", "notes": "Refactor src/modules/test.valk to replace all atom usage with functional patterns: 1) Remove 4 global atoms (*test-async-pending-atom*, *test-async-passed-atom*, *test-async-failed-atom*, *test-async-timed-out-atom*), 2) Replace polling loop (lines ~532-559) with aio/all to wait for test completion, 3) Replace per-test timeout atom with aio/race pattern, 4) Have each test return {:status :pass/:fail/:timeout} result, 5) Aggregate results after aio/all completes", "accept": "make test passes and grep -c atom src/modules/test.valk returns 0", "deps": ["t-5tx6hx"], "priority": "high"}
{"t": "task", "id": "t-l4x4yb", "spec": "deprecate-atoms.md", "name": "Refactor SSE stress tests to remove atoms", "s": "p", "notes": "Refactor test/stress/test_sse_concurrency_short.valk and test/stress/test_sse_concurrency.valk to replace 6 atoms each with functional patterns: 1) Replace counter atoms (connections-opened, connections-closed, events-received, errors-count) with aio/all to collect results from all connections, 2) Replace active-connections atom with aio/semaphore for rate limiting, 3) Replace test-running atom with aio/race for clean shutdown, 4) Return results from each connection and aggregate after aio/all", "accept": "All stress tests pass and grep -c atom for both files returns 0", "deps": ["t-ly03eq"], "priority": "high"}
{"t": "task", "id": "t-mbu8vo", "spec": "deprecate-atoms.md", "name": "Add deprecation warnings to atom builtins", "s": "p", "notes": "Add deprecation warnings to all atom builtin functions in src/parser.c: 1) Add VALK_WARN() calls to valk_builtin_atom, valk_builtin_atom_get, valk_builtin_atom_set, valk_builtin_atom_add, valk_builtin_atom_sub functions (lines ~4040-4100) with message \"atom is deprecated: use aio/semaphore or aio/then chains\", 2) Verify warnings appear when using atom builtins but do not break functionality, 3) Ensure make test still passes with warnings", "accept": "build/valk -e (atom 1) prints deprecation warning to stderr and make test passes with warnings", "deps": ["t-l4x4yb"]}
{"t": "task", "id": "t-miq4pp", "spec": "deprecate-atoms.md", "name": "Remove atom implementation and tests", "s": "p", "notes": "Phase 5 - Breaking change: 1) Remove valk_atom_t struct and all atom builtin functions from src/parser.c (lines ~4040-4100), 2) Remove atom builtin registrations from valk_lenv_put_builtins (lines ~5209-5213), 3) Delete test/test_atom_builtins.valk file, 4) Remove atom error tests from test/test_parser_errors.c (lines ~1195-1215), 5) Verify no atom usage remains in any .valk files", "accept": "(atom 1) returns Unknown function atom error and make test passes", "deps": ["t-mbu8vo"], "priority": "medium"}
{"t": "task", "id": "t-mq3h39", "spec": "deprecate-atoms.md", "name": "Verify all http2/client-request callers use aio/then", "s": "p", "notes": "Final verification that all http2/client-request usage follows handle pattern: 1) Run grep to confirm no callback-based patterns remain, 2) Run make test to verify all functionality works, 3) Test specific files that were updated to ensure they pass. Quick verification task.", "accept": "grep shows no callback patterns and make test passes", "deps": ["t-lrgyg8"]}
{"t": "task", "id": "t-ft5ubv", "spec": "deprecate-atoms.md", "name": "Verify http2/client-request handle return status", "s": "p", "notes": "Quick verification that http2/client-request functions actually return handles: 1) Read src/parser.c lines 4850-4876 to confirm builtin functions return valk_lval_handle(), 2) Read src/aio/http2/aio_http2_client.c to confirm implementation creates async handles, 3) Run single simple test: build/valk -e \"(http2/client-request (aio/new) \\\"example.com\\\" 443 \\\"/\\\")\" to verify it returns handle type", "accept": "Functions return handles and single test confirms handle type returned", "parent": "t-lrgyg8", "decompose_depth": 1}
{"t": "task", "id": "t-fyvahc", "spec": "deprecate-atoms.md", "name": "Test http2/client-request with aio/then integration", "s": "p", "notes": "Test that http2/client-request can be properly used with aio/then: 1) Create minimal test script that uses http2/client-request with aio/then, 2) Use localhost or mock endpoint to avoid external dependencies, 3) Run test with timeout to prevent hanging, 4) Verify the aio/then chain works correctly", "accept": "http2/client-request works correctly with aio/then pattern without hanging", "deps": ["t-ft5ubv"], "parent": "t-lrgyg8", "decompose_depth": 1}
{"t": "task", "id": "t-f22ptj", "spec": "deprecate-atoms.md", "name": "Check for any callback-based usage patterns", "s": "p", "notes": "Search for any remaining callback-based patterns in the codebase: 1) Grep for old callback usage with http2/client-request, 2) Check test files for patterns that might not use aio/then, 3) Look for any documentation that needs updating, 4) Quick scan to ensure no legacy callback patterns remain", "accept": "No callback-based patterns found for http2/client-request functions", "deps": ["t-fyvahc"], "parent": "t-lrgyg8", "decompose_depth": 1}
{"t": "task", "id": "t-f887xz", "spec": "deprecate-atoms.md", "name": "Run focused http2 tests to ensure functionality", "s": "p", "notes": "Run specific tests related to http2 functionality without full test suite: 1) Run build/test_http_builtins_unit, 2) Run build/valk test/test_http_request_builtins.valk with 30s timeout, 3) Run any other focused http2 tests, 4) Verify tests pass without hanging or timeouts", "accept": "All http2-related tests pass within reasonable time limits", "deps": ["t-f22ptj"], "parent": "t-lrgyg8", "decompose_depth": 1}
{"t": "accept", "id": "t-g6kd61", "done_at": "f391f6b", "reason": ""}
{"t": "reject", "id": "t-huv4b6", "done_at": "e947aab", "reason": "Not all http2/client-request usages follow the handle pattern with aio/then. Several files still use the legacy callback-based API instead of the new handle-based API. Found at least 3 test files (test/stress/test_large_download_stress.valk, test/test_sse_reconnect_minimal.valk, test/test_sse_diagnostics_endpoint.valk) that still use the old callback pattern instead of (aio/then (http2/client-request ...) callback)."}
{"t": "accept", "id": "t-u9ur69", "done_at": "50a9603", "reason": ""}
{"t": "accept", "id": "t-veg2v6", "done_at": "8db5cdf", "reason": ""}
{"t": "accept", "id": "t-2gi2zz", "done_at": "4804ce8", "reason": ""}
{"t": "accept", "id": "t-2m2v3z", "done_at": "45cb699", "reason": ""}
{"t": "accept", "id": "t-g3srfg", "done_at": "16b8d7a", "reason": ""}
