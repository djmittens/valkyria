{"t": "spec", "spec": "debug-dashboard-validation.md"}
{"t": "task", "id": "t-7h3x", "spec": "debug-dashboard-validation.md", "name": "Add make test-stress target", "s": "d", "notes": "Create Makefile target that runs all stress tests in test/stress/. Should include test_sse_concurrency.valk, test_delta_baseline_isolation.valk, test_checkpoint_timer_stress.valk", "accept": "make test-stress runs all stress/*.valk tests and exits 0", "done_at": "8b54b0c", "decompose": true, "kill": "timeout", "kill_log": "/home/xyzyx/src/valkyria/build/ralph-logs/ralph-20260119_172017-build.log", "priority": "high"}
{"t": "task", "id": "t-iyj5", "spec": "debug-dashboard-validation.md", "name": "Add make test-stress-tsan target", "s": "d", "notes": "Create Makefile target that runs stress tests under ThreadSanitizer. Must redirect TSAN output to file per AGENTS.md. Key tests: test_sse_concurrency.valk, test_delta_baseline_isolation.valk", "accept": "make test-stress-tsan runs stress tests with TSAN, output goes to build/tsan-stress.log, 0 data races", "deps": ["t-7h3x"], "done_at": "c068a04", "priority": "high"}
{"t": "task", "id": "t-xy8l", "spec": "debug-dashboard-validation.md", "name": "Add make test-stress-asan target", "s": "d", "notes": "Create Makefile target that runs stress tests under AddressSanitizer. Must redirect ASAN output to file per AGENTS.md. Key tests: test_sse_concurrency.valk, test_delta_baseline_isolation.valk", "accept": "make test-stress-asan runs stress tests with ASAN, output goes to build/asan-stress.log, 0 memory errors", "deps": ["t-7h3x"], "done_at": "941e33b", "decompose": true, "kill": "timeout", "kill_log": "/home/xyzyx/src/valkyria/build/ralph-logs/ralph-20260119_173246-build.log", "priority": "high"}
{"t": "task", "id": "t-j2v1", "spec": "debug-dashboard-validation.md", "name": "Run TSAN on existing stress tests", "s": "d", "notes": "Run test_sse_concurrency.valk and test_delta_baseline_isolation.valk under TSAN to identify any data races. Document findings. If races found, create follow-up fix tasks.", "accept": "TSAN report generated, any races documented", "deps": ["t-iyj5"], "done_at": "63d6036", "priority": "low"}
{"t": "task", "id": "t-5fzs", "spec": "debug-dashboard-validation.md", "name": "Run ASAN on existing stress tests", "s": "d", "notes": "Run test_sse_concurrency.valk and test_delta_baseline_isolation.valk under ASAN to identify any memory errors. Document findings. If errors found, create follow-up fix tasks.", "accept": "ASAN report generated, any errors documented", "deps": ["t-xy8l"], "done_at": "a4c4481", "priority": "low"}
{"t": "task", "id": "t-evd5", "spec": "debug-dashboard-validation.md", "name": "Add pthread-based close race test", "s": "d", "notes": "Existing close race tests in test_stream_body_integration.c are single-threaded. Add true concurrent test using pthreads: spawn 2 threads that both call valk_stream_body_close() simultaneously. Verify no crash, no double-free.", "accept": "New pthread test in test_stream_body_integration.c passes, no TSAN warnings", "done_at": "e1a1bee", "priority": "medium"}
{"t": "task", "id": "t-62cg", "spec": "debug-dashboard-validation.md", "name": "Verify stream body LCOV exclusions are justified", "s": "d", "notes": "Review LCOV exclusions in aio_stream_body.c and aio_stream_body_conn.c. Per AGENTS.md, only OOM/platform-failure paths should be excluded. Remove unjustified exclusions and add tests for excluded code that can be tested.", "accept": "All LCOV exclusions in stream body files are for OOM/platform paths only", "done_at": "3368bd4", "priority": "medium"}
{"t": "task", "id": "t-cwlz", "spec": "debug-dashboard-validation.md", "name": "Add debug handler header validation tests", "s": "d", "notes": "test_debug_handler.valk verifies response bodies but not headers. Add tests verifying: /debug/metrics/state returns Content-Type: application/json, Cache-Control: no-cache...; /metrics returns Content-Type: text/plain; version=0.0.4", "accept": "Tests verify correct Content-Type and Cache-Control headers for debug endpoints", "done_at": "e0da374", "priority": "medium"}
{"t": "task", "id": "t-p3w9", "spec": "debug-dashboard-validation.md", "name": "Add slab/buckets query param tests", "s": "d", "notes": "test_debug_handler.valk tests /debug/slab/buckets with default values only. Add tests with query params: slab=X, start=Y, end=Z, buckets=N to verify parsing works correctly.", "accept": "Tests verify /debug/slab/buckets correctly parses slab, start, end, buckets query params", "done_at": "dd9ec4c", "priority": "medium"}
{"t": "task", "id": "t-2vd4", "spec": "debug-dashboard-validation.md", "name": "Add debug/reset-state unit tests", "s": "d", "notes": "debug-broadcaster.valk has debug/reset-state for bulk cleanup on session ID change. No explicit unit tests exist. Add tests verifying: session ID increments, old subscribers get cleaned up, new subscribers work after reset.", "accept": "Tests verify debug/reset-state behavior in test_debug_handler.valk", "done_at": "31858f2", "priority": "low"}
{"t": "task", "id": "t-qpzl", "spec": "debug-dashboard-validation.md", "name": "Create test_sse_concurrency_short.valk file", "s": "d", "notes": "Copy test/stress/test_sse_concurrency.valk to test/test_sse_concurrency_short.valk. Change TEST_DURATION_MS from 60000 to 10000. Keep all other parameters the same.", "accept": "File exists at test/test_sse_concurrency_short.valk with 10s duration", "done_at": "e639217", "priority": "high"}
{"t": "task", "id": "t-jo4p", "spec": "debug-dashboard-validation.md", "name": "Investigate SSE test hang", "s": "d", "notes": "SSE concurrency tests hang immediately after startup. Server starts and binds to port but no client connections are made. Need to debug libuv event loop or http2/client-request. Check if simpler HTTP client/server tests also hang.", "accept": "Root cause of SSE test hang identified", "done_at": "d74621f", "priority": "high"}
{"t": "task", "id": "t-76lv", "spec": "debug-dashboard-validation.md", "name": "Add GC coordination integration test", "s": "d", "notes": "Create test/test_gc_aio.c that tests GC triggering after aio/start: 1) Start aio, 2) Trigger GC, 3) Verify no hang. Also test allocation after aio/start triggers auto-GC. Use timeout to catch hangs.", "accept": "Test passes: make build && build/test_gc_aio completes in <5 seconds with exit 0", "deps": ["t-txro"], "done_at": "26ea627", "priority": "medium"}
{"t": "task", "id": "t-joav", "spec": "debug-dashboard-validation.md", "name": "Run SSE short test to verify hang fix", "s": "d", "notes": "Run test/test_sse_concurrency_short.valk to verify the GC/aio hang is fixed. This test previously hung on startup. Should complete in <15s.", "accept": "build/valk test/test_sse_concurrency_short.valk exits 0 in under 15 seconds", "deps": ["t-txro"], "done_at": "3bc1d14", "priority": "high"}
{"t": "task", "id": "t-4ec8", "spec": "debug-dashboard-validation.md", "name": "Analyze GC-AIO coordination mechanism", "s": "d", "notes": "Research how GC coordinates with event loop thread. Focus on: (1) How main thread waits for event loop to pause, (2) How event loop signals it reached safe point, (3) What happens with libuv async coalescing. Output: detailed flow description and identify exact deadlock scenario.", "accept": "Written analysis in /tmp/gc_aio_analysis.md with specific code paths and deadlock explanation", "done_at": "1d7fdaf", "priority": "high"}
{"t": "task", "id": "t-hmqm", "spec": "debug-dashboard-validation.md", "name": "Verify make test passes after GC-AIO fix", "s": "p", "notes": "Run full test suite to ensure fix does not break anything. If timeouts occur, identify which specific test hangs.", "accept": "make test completes successfully within 5 minutes", "deps": ["t-88mw"], "priority": "high"}
{"t": "task", "id": "t-kaka", "spec": "debug-dashboard-validation.md", "name": "Fix GC mark_env2 to handle malloc-allocated environments", "s": "p", "notes": "The mark_env2() and mark_env2_parallel() functions incorrectly bail out when an environment is not in the GC heap. In mark_env2 (line ~3254) and mark_env2_parallel (line ~3616), the code uses `if (!mark_ptr_only(env, ctx)) return;` which causes immediate return when the root environment is malloc-allocated (because valk_thread_ctx.heap is NULL during environment creation in valk_lenv_empty()). This abandons traversal of all values in the environment, causing the sweep phase to free builtins like +, def, println. Fix: (1) Remove early-return when mark_ptr_only(env) fails - still traverse environment contents. (2) Track visited environments separately using worklist/visited-set pattern since we cannot rely on mark bitmap for cycle detection on malloc environments. (3) Only use mark_ptr_only for env struct to mark it if it IS in heap, but do not bail on failure.", "accept": "Run make test to verify all tests pass. After mem/gc/collect, builtins like +, def, println must remain bound. No infinite loops on cyclic environments.", "priority": "medium"}
{"t": "task", "id": "t-59lb", "spec": "debug-dashboard-validation.md", "name": "Commit gc.c debug output cleanup", "s": "p", "notes": "There are uncommitted changes to gc.c that remove debug fprintf statements. Commit these changes as a preparatory cleanup.", "accept": "Changes to gc.c are committed with appropriate message", "priority": "high"}
{"t": "task", "id": "t-10t0", "spec": "debug-dashboard-validation.md", "name": "Move GC thread registration to after uv_run is ready", "s": "p", "notes": "Per analysis in gc_aio_analysis.md: The deadlock happens because event loop thread registers with GC before entering uv_run(). Fix: In aio_uv.c __event_loop(), move valk_gc_thread_register() call to right before uv_run() starts, AFTER uv_sem_post. This ensures the thread is only counted for GC when it can respond to async signals.", "accept": "Event loop thread registers for GC immediately before uv_run(). Test: timeout 5 build/valk with (def {aio} (aio/start)) (sleep 0.1) (mem/gc/collect) (aio/stop aio) should not hang (may still error due to separate env corruption bug).", "deps": ["t-59lb"], "priority": "high"}
{"t": "task", "id": "t-mals", "spec": "debug-dashboard-validation.md", "name": "Create minimal GC-AIO hang test", "s": "p", "notes": "Create test/test_gc_aio_hang.c that verifies the GC-AIO coordination fix. Test should: 1) Start AIO, 2) Wait briefly for event loop to start, 3) Trigger GC, 4) Stop AIO. Should complete in <5s without hanging. Use alarm() as timeout. Do NOT check for correctness of values after GC (that is a separate bug in t-kaka).", "accept": "test/test_gc_aio_hang.c exists, make build succeeds, build/test_gc_aio_hang completes in <5 seconds with exit 0", "deps": ["t-10t0"], "priority": "high"}
