{"t": "spec", "spec": "deprecate-atoms.md"}
{"t": "task", "id": "t-hfr17p", "spec": "deprecate-atoms.md", "name": "Refactor test framework to remove atoms", "s": "p", "notes": "Refactor src/modules/test.valk to replace all atom usage with functional patterns: 1) Remove 4 global atoms (*test-async-pending-atom*, *test-async-passed-atom*, *test-async-failed-atom*, *test-async-timed-out-atom*), 2) Replace polling loop (lines ~532-559) with aio/all to wait for test completion, 3) Replace per-test timeout atom with aio/race pattern, 4) Have each test return {:status :pass/:fail/:timeout} result, 5) Aggregate results after aio/all completes", "accept": "make test passes and grep -c atom src/modules/test.valk returns 0", "deps": ["t-g6kd61"], "priority": "high"}
{"t": "task", "id": "t-hnzo57", "spec": "deprecate-atoms.md", "name": "Refactor SSE stress tests to remove atoms", "s": "p", "notes": "Refactor test/stress/test_sse_concurrency_short.valk and test/stress/test_sse_concurrency.valk to replace 6 atoms each with functional patterns: 1) Replace counter atoms (connections-opened, connections-closed, events-received, errors-count) with aio/all to collect results from all connections, 2) Replace active-connections atom with aio/semaphore for rate limiting, 3) Replace test-running atom with aio/race for clean shutdown, 4) Return results from each connection and aggregate after aio/all", "accept": "All stress tests pass and grep -c atom for both files returns 0", "deps": ["t-hfr17p"], "priority": "high"}
{"t": "task", "id": "t-vnjftv", "spec": "deprecate-atoms.md", "name": "Refactor http2/client-request to return handle", "s": "p", "notes": "Modify http2/client-request in src/aio/http2/aio_http2_client.c to return handle instead of callback: 1) Remove callback parameter from function signatures, 2) Create async handle with valk_async_handle_new, 3) Store handle in request context, 4) In response completion callback, call valk_async_handle_complete with response, 5) Return handle immediately to Lisp, 6) Update both http2/client-request and http2/client-request-with-headers", "accept": "http2/client-request returns handle and can be used with aio/then", "deps": ["t-u9ur69"], "priority": "high"}
{"t": "task", "id": "t-2m2v3z", "spec": "deprecate-atoms.md", "name": "Add atom deprecation warnings", "s": "d", "notes": "Add deprecation warnings to all atom builtin functions in src/parser.c: 1) Add VALK_WARN(\"atom is deprecated: use aio/semaphore or aio/then chains\") to valk_builtin_atom, valk_builtin_atom_get, valk_builtin_atom_set, valk_builtin_atom_add, valk_builtin_atom_sub functions, 2) Ensure warnings go to stderr and do not break tests, 3) Test with build/valk -e \"(atom 1)\" to verify warning appears", "accept": "build/valk -e (atom 1) prints deprecation warning to stderr and make test passes with warnings", "done_at": "45cb699"}
{"t": "task", "id": "t-21euhh", "spec": "deprecate-atoms.md", "name": "Remove atom implementation and tests", "s": "p", "notes": "Phase 5 - Breaking change: 1) Remove valk_atom_t struct and all atom builtin functions from src/parser.c (lines ~4040-4100), 2) Remove atom builtin registrations from valk_lenv_put_builtins (lines ~5209-5213), 3) Delete test/test_atom_builtins.valk file, 4) Remove atom error tests from test/test_parser_errors.c (lines ~1195-1215), 5) Verify no atom usage remains in any .valk files", "accept": "(atom 1) returns Unknown function atom error and make test passes", "deps": ["t-hnzo57", "t-2m2v3z"], "priority": "medium"}
{"t": "task", "id": "t-g3srfg", "spec": "deprecate-atoms.md", "name": "Fix test_sse_mini.valk to use aio/then pattern", "s": "p", "notes": "Update test_sse_mini.valk to replace http2/client-request callback pattern with aio/then: 1) On line 21, change (http2/client-request aio \"127.0.0.1\" port \"/test1\" callback) to (aio/then (http2/client-request aio \"127.0.0.1\" port \"/test1\") callback), 2) Same change on line 26 for /test2 endpoint, 3) Add proper closing parentheses. This fixes the Invalid argument count error.", "accept": "build/valk test_sse_mini.valk runs without argument count errors", "parent": "t-huv4b6", "decompose_depth": 1}
{"t": "task", "id": "t-g9zmrd", "spec": "deprecate-atoms.md", "name": "Verify all http2/client-request callers use aio/then", "s": "p", "notes": "Final verification that all http2/client-request usage follows handle pattern: 1) Run grep to confirm no callback-based patterns remain, 2) Run make test to verify all functionality works, 3) Test specific files that were updated to ensure they pass. Quick verification task.", "accept": "grep shows no callback patterns and make test passes", "deps": ["t-g3srfg"], "parent": "t-huv4b6", "decompose_depth": 1}
{"t": "task", "id": "t-5tx6hx", "spec": "deprecate-atoms.md", "name": "Implement aio/semaphore builtin", "s": "p", "notes": "Add aio/semaphore functionality to src/aio/aio_combinators.c: 1) Define valk_semaphore_t struct with max_permits, available count, and queue for waiting handles, 2) Implement valk_builtin_aio_semaphore(aio, n) to create semaphore with n permits, 3) Implement valk_builtin_aio_semaphore_acquire(sem) returning future that completes when permit acquired, 4) Implement valk_builtin_aio_semaphore_release(sem) to release permit, 5) Register builtins in parser.c, 6) Handle queueing/completion for waiting handles when permits not available", "accept": "aio/semaphore creates semaphore, aio/semaphore-acquire blocks when no permits, aio/semaphore-release unblocks waiting handles"}
{"t": "task", "id": "t-5ywar0", "spec": "deprecate-atoms.md", "name": "Implement stream/closed builtin", "s": "p", "notes": "Add stream/closed functionality to src/aio/http2/stream/aio_stream_builtins.c: 1) Implement valk_builtin_stream_closed(stream) function that returns handle, 2) The handle should complete with :closed when the stream closes, 3) Hook into existing stream close events to complete waiting handles, 4) Register builtin in parser.c, 5) Follow pattern of other handle-returning async functions", "accept": "stream/closed returns handle that completes with :closed when stream closes"}
{"t": "task", "id": "t-6e05zz", "spec": "deprecate-atoms.md", "name": "Add tests for new aio functions", "s": "p", "notes": "Create comprehensive tests for new functionality: 1) Create test/test_aio_semaphore.valk with tests for acquire/release/blocking behavior, permit counting, concurrent access, 2) Add stream/closed tests to test/test_sse_builtins.valk showing handle completion when stream closes, 3) Test edge cases: zero permits, multiple waiters, release without acquire, closed stream behavior", "accept": "test/test_aio_semaphore.valk and test/test_sse_builtins.valk tests pass and demonstrate correct semaphore and stream/closed behavior", "deps": ["t-5tx6hx", "t-5ywar0"]}
{"t": "accept", "id": "t-g6kd61", "done_at": "f391f6b", "reason": ""}
{"t": "reject", "id": "t-huv4b6", "done_at": "e947aab", "reason": "Not all http2/client-request usages follow the handle pattern with aio/then. Several files still use the legacy callback-based API instead of the new handle-based API. Found at least 3 test files (test/stress/test_large_download_stress.valk, test/test_sse_reconnect_minimal.valk, test/test_sse_diagnostics_endpoint.valk) that still use the old callback pattern instead of (aio/then (http2/client-request ...) callback)."}
{"t": "accept", "id": "t-u9ur69", "done_at": "50a9603", "reason": ""}
{"t": "accept", "id": "t-veg2v6", "done_at": "8db5cdf", "reason": ""}
{"t": "accept", "id": "t-2gi2zz", "done_at": "4804ce8", "reason": ""}
