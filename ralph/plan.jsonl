{"t": "spec", "spec": "debug-dashboard-validation.md"}
{"t": "task", "id": "t-1-1", "spec": "debug-dashboard-validation.md", "name": "Add stream body integration test", "s": "d", "notes": "File: test/test_stream_body_integration.c. Test actual data flow through nghttp2: write queues data, read callback dequeues, close triggers on-close callback, backpressure when queue full. Look at test/test_http2_streaming.c for patterns.", "accept": "Test verifies data flows correctly through stream body to nghttp2", "done_at": "17d0bf0"}
{"t": "task", "id": "t-1-2", "spec": "debug-dashboard-validation.md", "name": "Test stream/write under connection close race", "s": "d", "notes": "In test_stream_body_integration.c: Start write, close connection mid-write. Verify no crash, no use-after-free, error returned. Run under TSAN and ASAN.", "accept": "No crashes or memory errors when write races with close", "deps": ["t-1-1"], "done_at": "7a22fad"}
{"t": "task", "id": "t-1-3", "spec": "debug-dashboard-validation.md", "name": "Test concurrent writes to same stream", "s": "d", "notes": "In test_stream_body_integration.c: Multiple rapid writes from same context. Verify all data delivered in order, no corruption.", "accept": "All writes delivered in order without corruption", "deps": ["t-1-1"], "done_at": "a00c756"}
{"t": "task", "id": "t-1-4", "spec": "debug-dashboard-validation.md", "name": "Test on-close callback timing", "s": "d", "notes": "In test_stream_body_integration.c: Verify callback fires exactly once, before stream body freed, callback can safely access stream state.", "accept": "on-close callback fires exactly once with valid stream state", "deps": ["t-1-1"], "done_at": "baeb777"}
{"t": "task", "id": "t-2-1", "spec": "debug-dashboard-validation.md", "name": "Test sse/send wire format", "s": "d", "notes": "File: test/test_sse_format.valk. Test: sse/send 'hello' -> 'data: hello\\n\\n', sse/send 'a\\nb' -> 'data: a\\ndata: b\\n\\n'. Capture actual wire output and compare.", "accept": "sse/send produces correct SSE wire format for all cases", "done_at": "5a1c65f"}
{"t": "task", "id": "t-2-2", "spec": "debug-dashboard-validation.md", "name": "Test sse/event wire format", "s": "d", "notes": "In test/test_sse_format.valk: Test sse/event 'msg' 'data' -> 'event: msg\\ndata: data\\n\\n'. Test with multi-line data.", "accept": "sse/event produces correct SSE wire format", "deps": ["t-2-1"], "done_at": "3cef8a1"}
{"t": "task", "id": "t-2-3", "spec": "debug-dashboard-validation.md", "name": "Test sse/id and sse/full wire format", "s": "d", "notes": "In test/test_sse_format.valk: Test sse/id and sse/full produce correct 'id:' and combined format.", "accept": "sse/id and sse/full produce correct wire format", "deps": ["t-2-1"], "done_at": "ac5b5dd"}
{"t": "task", "id": "t-2-4", "spec": "debug-dashboard-validation.md", "name": "Test sse/retry and sse/comment wire format", "s": "d", "notes": "In test/test_sse_format.valk: Test sse/retry 5000 -> 'retry: 5000\\n\\n', sse/comment 'ping' -> ': ping\\n', sse/heartbeat -> ':\\n'.", "accept": "sse/retry, sse/comment, sse/heartbeat produce correct format", "deps": ["t-2-1"], "done_at": "2c8f3ba"}
{"t": "task", "id": "t-3-1", "spec": "debug-dashboard-validation.md", "name": "Test debug handler route matching", "s": "d", "notes": "File: test/test_debug_handler.valk. Test all routes: /debug, /debug/, /debug/metrics, /debug/metrics/state, /metrics, /debug/diagnostics/memory, /debug/slab/buckets. Verify correct response for each.", "accept": "All debug routes return expected responses", "done_at": "29372e4"}
{"t": "task", "id": "t-3-2", "spec": "debug-dashboard-validation.md", "name": "Test /debug/metrics/state JSON structure", "s": "d", "notes": "In test_debug_handler.valk: Request endpoint, parse JSON, verify structure: metrics.aio, metrics.modular, metrics.vm, metrics.registry, memory.", "accept": "JSON structure matches expected schema", "deps": ["t-3-1"], "done_at": "f85449f"}
{"t": "task", "id": "t-3-3", "spec": "debug-dashboard-validation.md", "name": "Test /debug/diagnostics/memory SSE events", "s": "d", "notes": "In test_debug_handler.valk: Connect to SSE endpoint, verify first event is 'diagnostics' (full state), subsequent are 'diagnostics-delta'. Parse and validate JSON structure.", "accept": "SSE events have correct types and valid JSON", "deps": ["t-3-1"], "done_at": "9fa4728"}
{"t": "task", "id": "t-3-4", "spec": "debug-dashboard-validation.md", "name": "Test SSE handler lifecycle", "s": "d", "notes": "In test_debug_handler.valk: Connect, receive events, disconnect. Verify timer stops after disconnect (no more events if reconnected briefly). Verify reconnect works.", "accept": "Timer stops on disconnect, reconnect works", "deps": ["t-3-3"], "done_at": "903ac6e"}
{"t": "task", "id": "t-3-5", "spec": "debug-dashboard-validation.md", "name": "Test /metrics Prometheus format", "s": "d", "notes": "In test_debug_handler.valk: Request /metrics, verify contains expected metric names (valk_gc_, http_), verify format is valid Prometheus exposition.", "accept": "/metrics returns valid Prometheus format", "deps": ["t-3-1"], "done_at": "8aacc15"}
{"t": "task", "id": "t-4-1", "spec": "debug-dashboard-validation.md", "name": "Document observed concurrency issues", "s": "d", "notes": "Capture specific symptoms from manual testing. What operations trigger issues? Error messages? Crashes? Incorrect data? Create subtasks for each distinct issue.", "accept": "Concurrency issues documented with reproduction steps", "done_at": "0a246b5"}
{"t": "task", "id": "t-4-2", "spec": "debug-dashboard-validation.md", "name": "Add SSE concurrency stress test", "s": "d", "notes": "File: test/stress/test_sse_concurrency.valk. 10 concurrent SSE connections, rapid connect/disconnect cycles, run 60 seconds. Verify no crashes, hangs, or leaks.", "accept": "Stress test passes without crashes or hangs", "deps": ["t-3-3"], "done_at": "017ace3"}
{"t": "task", "id": "t-4-3", "spec": "debug-dashboard-validation.md", "name": "Test delta baseline isolation", "s": "d", "notes": "In stress test: Two SSE connections, increment metrics between their events, verify each sees correct deltas. Tests whether metrics/collect-delta uses per-connection or shared state.", "accept": "Each connection gets correct deltas for its timeline", "deps": ["t-4-2"], "done_at": "74d1c8e"}
{"t": "task", "id": "t-4-4", "spec": "debug-dashboard-validation.md", "name": "Run stress test under TSAN", "s": "d", "notes": "Run test_sse_concurrency.valk with make test-valk-tsan or equivalent. Identify any data races reported.", "accept": "No TSAN warnings, or all races documented", "deps": ["t-4-2"], "done_at": "faa5d8f"}
{"t": "task", "id": "t-4-5", "spec": "debug-dashboard-validation.md", "name": "Run stress test under ASAN", "s": "d", "notes": "Run test_sse_concurrency.valk with make test-valk-asan. Identify any memory errors.", "accept": "No ASAN errors, or all errors documented", "deps": ["t-4-2"], "done_at": "714faa7"}
{"t": "task", "id": "t-4-6", "spec": "debug-dashboard-validation.md", "name": "Fix identified concurrency issues", "s": "d", "notes": "Create fix for each issue found in t-4-1 through t-4-5. Add regression test for each fix.", "accept": "All identified issues fixed with regression tests", "deps": ["t-4-1", "t-4-4", "t-4-5"], "done_at": "83bf5af"}
{"t": "task", "id": "t-5-1", "spec": "debug-dashboard-validation.md", "name": "Create debug-broadcaster.valk", "s": "d", "notes": "File: src/modules/aio/debug-broadcaster.valk. Single 100ms timer shared across all subscribers. Subscriber list as atom. On tick: collect once, broadcast to all. Start timer on first subscribe, stop on last unsubscribe.", "accept": "Broadcaster module loads, timer lifecycle correct", "deps": ["t-4-6"], "done_at": "9418872"}
{"t": "task", "id": "t-5-2", "spec": "debug-dashboard-validation.md", "name": "Implement per-subscriber baseline", "s": "d", "notes": "In debug-broadcaster.valk: Each subscriber entry stores its baseline. First event sends full state. Subsequent events compute delta from that subscriber's baseline. May need new builtin or Lisp-side tracking.", "accept": "Each subscriber gets accurate deltas from its own baseline", "deps": ["t-5-1"], "done_at": "a3e3d9f"}
{"t": "task", "id": "t-5-3", "spec": "debug-dashboard-validation.md", "name": "Implement subscribe/unsubscribe API", "s": "d", "notes": "In debug-broadcaster.valk: debug/subscribe sys stream adds to list, starts timer if first. debug/unsubscribe removes, stops timer if last. Auto-unsubscribe on stream/on-close.", "accept": "Subscribe/unsubscribe work correctly, timer auto-managed", "deps": ["t-5-1"], "done_at": "5c8cc4a"}
{"t": "task", "id": "t-5-4", "spec": "debug-dashboard-validation.md", "name": "Implement backpressure handling", "s": "d", "notes": "In debug-broadcaster.valk: Track consecutive failed writes per subscriber (stream/writable? returns 0). Disconnect after 10 failures. Log disconnection.", "accept": "Slow subscribers disconnected after threshold", "deps": ["t-5-3"], "done_at": "33f9c6d"}
{"t": "task", "id": "t-5-5", "spec": "debug-dashboard-validation.md", "name": "Update debug.valk to use broadcaster", "s": "d", "notes": "Modify src/modules/aio/debug.valk: Replace aio/interval in SSE handler with debug/subscribe. Load debug-broadcaster.valk. Verify dashboard still works.", "accept": "Dashboard works with broadcaster, single timer for all connections", "deps": ["t-5-4"], "done_at": "c6e5589"}
{"t": "task", "id": "t-5-6", "spec": "debug-dashboard-validation.md", "name": "Add broadcaster tests", "s": "d", "notes": "In test_debug_handler.valk or new file: Verify single timer for multiple connections, timer stops when last leaves, slow subscriber disconnected without affecting fast ones.", "accept": "Broadcaster behavior verified by tests", "deps": ["t-5-5"], "done_at": "0857f78"}
{"t": "issue", "id": "i-a1ua", "spec": "debug-dashboard-validation.md", "desc": "metrics/collect-delta uses global registry state - concurrent SSE connections share delta baselines, causing incorrect deltas when multiple clients connect"}
{"t": "issue", "id": "i-m2ri", "spec": "debug-dashboard-validation.md", "desc": "Per-connection timers (aio/interval) create O(N) overhead - N concurrent SSE connections spawn N independent timers, each collecting metrics separately"}
{"t": "issue", "id": "i-8v7l", "spec": "debug-dashboard-validation.md", "desc": "valk_delta_snapshot_collect modifies global registry last_value fields - concurrent calls from multiple SSE handlers race on atomic stores, causing lost deltas"}
{"t": "issue", "id": "i-p0r4", "spec": "debug-dashboard-validation.md", "desc": "Read-modify-write race in valk_delta_snapshot_collect: lines 228-240 read last_value then write it - concurrent collectors can both read same last_value and compute duplicate deltas"}
{"t": "issue", "id": "i-zq1f", "spec": "debug-dashboard-validation.md", "desc": "TSAN: async handle result field race (aio_async.c:480) - main thread reads result while event loop thread writes it"}
{"t": "issue", "id": "i-ary8", "spec": "debug-dashboard-validation.md", "desc": "TSAN: memory arena allocator race (memory.c:501-504) - arena bump pointer accessed from both main and event loop threads without synchronization"}
{"t": "issue", "id": "i-pf9m", "spec": "debug-dashboard-validation.md", "desc": "TSAN: GC region allocator race (gc.c:1228-1229) - region alloc called from event loop thread while main thread may be doing GC"}
{"t": "issue", "id": "i-6qqq", "spec": "debug-dashboard-validation.md", "desc": "TSAN: GC evacuation races (gc.c:1911-2166) - GC evacuation and pointer fixing runs while event loop accesses values"}
{"t": "issue", "id": "i-ee6d", "spec": "debug-dashboard-validation.md", "desc": "TSAN: task queue struct access race (aio_task_queue.c:23-24, aio_task.c:13-17) - task struct fields read by event loop while being written by main thread"}
{"t": "issue", "id": "i-0va4", "spec": "debug-dashboard-validation.md", "desc": "TSAN: Chase-Lev deque race (aio_chase_lev.c:20) - array_get needs atomic load, array_put needs atomic store for correct lock-free behavior"}
{"t": "issue", "id": "i-wehu", "spec": "debug-dashboard-validation.md", "desc": "TSAN: HTTP2 client connect races (aio_http2_client.c:299-341) - reading handle fields after async completion without synchronization"}
{"t": "issue", "id": "i-fagc", "spec": "debug-dashboard-validation.md", "desc": "TSAN: AIO stop race (aio_system.c:371) - valk_aio_stop reads thread state while event loop may still be running"}
{"t": "issue", "id": "i-ok0k", "spec": "debug-dashboard-validation.md", "desc": "TSAN: environment lookup race (parser.c:2193) - valk_lenv_get accesses env while GC may be evacuating"}
{"t": "issue", "id": "i-ieoi", "spec": "debug-dashboard-validation.md", "desc": "ASAN: use-after-free in valk_aio_stop (aio_system.c:367) - after aio/run calls valk_aio_wait_for_shutdown which frees sys, repl.c:143 calls valk_aio_stop on the freed pointer"}
{"t": "issue", "id": "i-zzqz", "spec": "debug-dashboard-validation.md", "desc": "ASAN: memory leak of 24 bytes in 3 atom objects - atoms created via valk_builtin_atom (parser.c:4011) are never freed"}
