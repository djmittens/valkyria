{"t": "spec", "spec": "deprecate-atoms.md"}
{"t": "task", "id": "t-miq4pp", "spec": "deprecate-atoms.md", "name": "Remove atom implementation and tests", "s": "p", "notes": "Breaking change: 1) Remove valk_atom_t and all atom builtins from src/parser.c, 2) Remove registrations from valk_lenv_put_builtins, 3) Delete test/test_atom_builtins.valk, 4) Remove atom error tests from test/test_parser_errors.c", "accept": "(atom 1) returns Unknown function atom error and make test passes", "deps": ["t-ly03eq", "t-c33ayf"], "priority": "medium"}
{"t": "task", "id": "t-c33ayf", "spec": "deprecate-atoms.md", "name": "Run full test suite to verify SSE changes", "s": "p", "notes": "Run make test to ensure SSE stress test refactoring did not break any existing functionality. Focus specifically on: 1) All aio/cancel functionality works properly, 2) Stream closing and cleanup works correctly, 3) No regression in other tests caused by SSE changes", "accept": "make test passes without failures related to aio/cancel or stream handling", "deps": ["t-cviy0r"], "parent": "t-sse-refactor", "decompose_depth": 1}
{"t": "task", "id": "t-4yefch", "spec": "deprecate-atoms.md", "name": "Test SSE stress test interval callback error fix", "s": "p", "notes": "After fixing create-batch function, verify that the interval callback error (ord() receiving Error instead of Number) is resolved. Check test/stress/test_sse_concurrency_short.valk send-events callback logic for proper error handling in ord() calls.", "accept": "build/valk test/stress/test_sse_concurrency_short.valk completes without ord() type errors", "deps": ["t-4qsj98"], "parent": "t-cviy0r", "decompose_depth": 2}
{"t": "task", "id": "t-5eqns4", "spec": "deprecate-atoms.md", "name": "Run full SSE stress test verification", "s": "p", "notes": "Execute timeout 30 build/valk test/stress/test_sse_concurrency.valk to verify the full SSE stress test works after atom removal. No code changes needed - pure verification. Document any failures or timeout behavior.", "accept": "timeout 30 build/valk test/stress/test_sse_concurrency.valk exits cleanly or with expected timeout, no critical errors", "deps": ["t-4yefch"], "parent": "t-cviy0r", "decompose_depth": 2}
{"t": "task", "id": "t-5mlz52", "spec": "deprecate-atoms.md", "name": "Clean up debug files from SSE investigation", "s": "p", "notes": "Remove debug_batch_simple.valk and any other temporary files created during SSE debugging. Run rm debug_batch_simple.valk and check for other temporary files in root directory.", "accept": "debug_batch_simple.valk and other debug files removed, make test passes", "deps": ["t-5eqns4"], "parent": "t-cviy0r", "decompose_depth": 2}
{"t": "task", "id": "t-bp6h8x", "spec": "deprecate-atoms.md", "name": "Add missing aio/within test", "s": "d", "notes": "Create test/test_aio_within.valk to test aio/within combinator functionality: 1) Test success case where handle completes before timeout, 2) Test timeout case where handle takes longer than timeout-ms, 3) Test error propagation when handle fails before timeout. Use aio/sleep to create predictable timing scenarios.", "accept": "test/test_aio_within.valk exists and make test passes", "done_at": "db79573"}
{"t": "task", "id": "t-bto1f2", "spec": "deprecate-atoms.md", "name": "Add missing aio/never test", "s": "p", "notes": "Create test/test_aio_never.valk to test aio/never combinator: 1) Test that aio/never returns handle that never completes, 2) Test aio/race pattern with aio/never versus fast completing handle, 3) Test cancellation of aio/never handle. Use aio/race with quick aio/sleep to verify aio/never truly never completes.", "accept": "test/test_aio_never.valk exists and make test passes"}
{"t": "accept", "id": "t-g6kd61", "done_at": "f391f6b", "reason": ""}
{"t": "reject", "id": "t-huv4b6", "done_at": "e947aab", "reason": "Not all http2/client-request usages follow the handle pattern with aio/then."}
{"t": "accept", "id": "t-u9ur69", "done_at": "50a9603", "reason": ""}
{"t": "accept", "id": "t-veg2v6", "done_at": "8db5cdf", "reason": ""}
{"t": "accept", "id": "t-2gi2zz", "done_at": "4804ce8", "reason": ""}
{"t": "accept", "id": "t-2m2v3z", "done_at": "45cb699", "reason": ""}
{"t": "accept", "id": "t-g3srfg", "done_at": "16b8d7a", "reason": ""}
{"t": "accept", "id": "t-rm-sem", "done_at": "f25a51e", "reason": "aio/semaphore builtins removed"}
{"t": "accept", "id": "t-rm-deferred", "done_at": "6dc600e", "reason": "aio/deferred returns Unknown function error, make test passes", "name": "Remove aio/deferred builtins"}
{"t": "accept", "id": "t-aio-within", "done_at": "a6c6db1", "reason": "aio/within works, test exists, make test passes", "name": "Add aio/within combinator"}
{"t": "accept", "id": "t-interval", "done_at": "0e587de", "reason": "aio/interval returns handle, aio/cancel stops it, make test passes", "name": "Refactor aio/interval to return cancellable handle"}
{"t": "accept", "id": "t-4l8k3z", "done_at": "09f8f1a", "reason": "(aio/deferred) returns Unknown function error, make build and make test pass", "name": "Remove aio/deferred functions"}
{"t": "accept", "id": "t-aio-all-settled", "done_at": "d62fdb7", "reason": "aio/all-settled works, test exists, make test passes", "name": "Add aio/all-settled combinator"}
{"t": "reject", "id": "t-aio-retry", "done_at": "3571d12", "reason": "This was marked done by accident during testing", "name": "Add aio/retry combinator", "timestamp": "2026-01-20T23:53:34-08:00", "changed_files": ["ralph/.current_task", "ralph/.runtime", "src/aio/aio_combinators.c"], "notes": "Add (aio/retry aio fn opts) that: 1) Calls fn to get handle, 2) On failure, retries according to opts {:max-attempts n :backoff :exponential/:linear/:none :base-ms ms}, 3) Returns handle that completes with first success or final failure. Common pattern for network operations."}
{"t": "accept", "id": "t-aio-retry", "done_at": "747a182", "reason": "aio/retry works with backoff, test exists, make test passes", "name": "Add aio/retry combinator", "timestamp": "2026-01-20T23:59:49-08:00", "changed_files": ["ralph/plan.jsonl"], "notes": "Add (aio/retry aio fn opts) that: 1) Calls fn to get handle, 2) On failure, retries according to opts {:max-attempts n :backoff :exponential/:linear/:none :base-ms ms}, 3) Returns handle that completes with first success or final failure. Common pattern for network operations."}
{"t": "accept", "id": "t-sak2xw", "done_at": "1b2cd36", "reason": "aio/interval returns handle type, aio/cancel on interval handle exits code 0, callback returning :stop completes handle, make test passes", "name": "Refactor aio/interval to return handle", "timestamp": "2026-01-21T00:17:07-08:00", "changed_files": ["ralph/.current_task", "ralph/.runtime", "ralph/PROMPT_build.md", "ralph/PROMPT_decompose.md", "ralph/PROMPT_investigate.md", "ralph/PROMPT_plan.md", "ralph/PROMPT_verify.md", "ralph/plan.jsonl"], "notes": "Breaking change: Modify aio/interval in src/aio/aio_combinators.c to: 1) Return a handle instead of numeric ID, 2) Handle completes when interval is stopped (via :stop return or aio/cancel), 3) Make interval cancellable via aio/cancel, 4) Preserve existing :stop return pattern from callback function. Implementation: Replace interval ID tracking with handle-based approach."}
{"t": "reject", "id": "t-k4q13z", "done_at": "a925b0f", "reason": "Missing test for actual timeout behavior. Acceptance criteria states 'aio/within works with timeout' but no test verifies that a slow operation (e.g., aio/sleep with longer duration than timeout) actually produces :timeout error. Tests only cover pre-timeout completion/failure cases.", "name": "Add aio/within combinator", "timestamp": "2026-01-21T00:15:28-08:00", "changed_files": ["ralph/plan.jsonl"], "notes": "Add (aio/within handle timeout-ms) that: 1) Returns handle that fails with timeout error if handle does not complete in time, 2) Implementation in src/aio/aio_combinators.c using aio/race pattern internally, 3) Use aio/race with handle and sleep+timeout-error pattern, 4) Common timeout pattern replacement"}
{"t": "accept", "id": "t-k4q13z", "done_at": "8b5c35b", "reason": "aio/within works with timeout, test exists, make test passes", "name": "Add aio/within combinator", "timestamp": "2026-01-21T00:30:38-08:00", "changed_files": ["ralph/plan.jsonl"], "notes": "Add (aio/within handle timeout-ms) that: 1) Returns handle that fails with timeout error if handle does not complete in time, 2) Implementation in src/aio/aio_combinators.c using aio/race pattern internally, 3) Use aio/race with handle and sleep+timeout-error pattern, 4) Common timeout pattern replacement"}
{"t": "accept", "id": "t-aio-never", "done_at": "f28b542", "reason": "aio/never works, test exists, make test passes", "name": "Add aio/never combinator", "timestamp": "2026-01-21T00:40:39-08:00", "changed_files": ["ralph/plan.jsonl"], "notes": "Add (aio/never aio) that returns a handle that never completes. Useful for aio/race patterns: (aio/race (list (aio/never aio) (stream/closed s))) means 'wait forever unless stream closes'. Simple implementation: create handle, never complete it."}
{"t": "accept", "id": "t-aio-traverse", "done_at": "4d28fee", "reason": "aio/traverse works, test exists, make test passes", "name": "Add aio/traverse combinator", "timestamp": "2026-01-21T00:48:17-08:00", "changed_files": ["ralph/plan.jsonl"], "notes": "Add (aio/traverse list fn) as sugar for (aio/all (map fn list)). Maps async fn over list then collects results. Common pattern: (aio/traverse urls fetch) instead of (aio/all (map fetch urls))."}
{"t": "accept", "id": "t-4cpxzd", "done_at": "61028a4", "reason": "build/valk -e (aio/deferred aio) returns Unknown function error, make build succeeds, make test passes", "name": "Remove aio/deferred builtins", "timestamp": "2026-01-21T00:58:20-08:00", "changed_files": ["ralph/plan.jsonl"], "notes": "Phase 1: Remove aio/deferred, aio/deferred-complete!, aio/deferred-fail! from src/aio/aio_combinators.c: 1) Remove valk_builtin_aio_deferred, valk_builtin_aio_deferred_complete, valk_builtin_aio_deferred_fail functions, 2) Remove their registrations from valk_lenv_put_builtins, 3) These are anti-pattern APIs that expose handle completion to Lisp code"}
{"t": "accept", "id": "t-ly03eq", "done_at": "8c9a97c", "reason": "make test passes and grep -c atom src/modules/test.valk returns 0", "name": "Refactor test framework to remove atoms", "timestamp": "2026-01-21T01:03:23-08:00", "changed_files": ["ralph/plan.jsonl"], "notes": "Refactor src/modules/test.valk: 1) Remove 4 global atoms (*test-async-pending-atom*, etc), 2) Each test returns {:status :pass/:fail/:timeout} via handle, 3) Use aio/all to collect all test results, 4) Use aio/within for per-test timeout instead of atom coordination, 5) Aggregate results after aio/all completes"}
{"t": "accept", "id": "t-4qsj98", "done_at": "5d35593", "reason": "build/valk test/stress/test_sse_concurrency_short.valk runs without aio/then argument type errors", "name": "Fix create-batch function in SSE stress test", "timestamp": "2026-01-21T09:41:16-08:00", "changed_files": ["ralph/plan.jsonl"], "notes": "Fix test/stress/test_sse_concurrency_short.valk:93-110 create-batch recursive function that returns Error instead of list. Replace recursive approach with manual handle list creation or proper loop. Root cause: recursion in Valkyria Lisp causing stack/evaluation issues."}
