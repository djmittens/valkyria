{"t": "spec", "spec": "deprecate-atoms.md"}
{"t": "task", "id": "t-hyo0", "spec": "deprecate-atoms.md", "name": "Refactor http2/client-request-with-headers to return handle", "s": "d", "notes": "In src/aio/http2/aio_http2_client.c: Remove callback param from valk_builtin_http2_client_request_with_headers. Same pattern as http2/client-request - create handle, return immediately, complete in callback.", "accept": "http2/client-request-with-headers takes 5 args (aio host port path headers), returns handle", "deps": ["t-1u7d"], "done_at": "0a944f6"}
{"t": "task", "id": "t-45oi", "spec": "deprecate-atoms.md", "name": "Refactor test.valk to use aio/all for result collection", "s": "d", "notes": "In src/modules/test.valk: Replace *test-async-pending-atom*, *test-async-passed-atom*, *test-async-failed-atom*, *test-async-timed-out-atom* with aio/all pattern. Each test returns {:status :pass} or {:status :fail :error msg} or {:status :timeout}. Use (aio/then (aio/all test-futures) summarize-results) instead of polling.", "accept": "grep -c atom src/modules/test.valk returns 0, all async tests pass", "deps": ["t-4lrj"], "done_at": "337f194"}
{"t": "task", "id": "t-bnb5", "spec": "deprecate-atoms.md", "name": "Refactor test.valk timeout handling to use aio/race", "s": "p", "notes": "In src/modules/test.valk: Replace per-test timed-out atom (line 438) and suite *test-suite-timed-out* atom with aio/race pattern. Use (aio/race (list (aio/then (aio/sleep aio timeout) (fn {_} {:status :timeout})) (aio/then (run-test test) (fn {r} {:status :pass :result r}))))", "accept": "grep -c atom src/modules/test.valk returns 0, timeout tests work correctly", "deps": ["t-45oi"]}
{"t": "task", "id": "t-ogof", "spec": "deprecate-atoms.md", "name": "Refactor test/test_sse_concurrency_short.valk to remove atoms", "s": "p", "notes": "Replace 6 global atoms (connections-opened, connections-closed, events-received, errors-count, test-running, active-connections) and 2 per-connection atoms (events-sent, closed) with: aio/semaphore for rate limiting (MAX_ACTIVE=5), aio/all for result collection, stream/closed for per-stream state. Each connection returns result map, collect with aio/all.", "accept": "grep -c atom test/test_sse_concurrency_short.valk returns 0, test validates concurrency metrics", "deps": ["t-bnb5"]}
{"t": "task", "id": "t-u8bc", "spec": "deprecate-atoms.md", "name": "Refactor test/stress/test_sse_concurrency_short.valk to remove atoms", "s": "p", "notes": "Same refactor as test/test_sse_concurrency_short.valk - use aio/semaphore for rate limiting, aio/all for result collection. Files are nearly identical, apply same pattern.", "accept": "grep -c atom test/stress/test_sse_concurrency_short.valk returns 0", "deps": ["t-ogof"]}
{"t": "task", "id": "t-fdxw", "spec": "deprecate-atoms.md", "name": "Refactor test/stress/test_sse_concurrency.valk to remove atoms", "s": "p", "notes": "Same refactor as other SSE concurrency tests. This is the 60-second version, apply same aio/semaphore + aio/all pattern.", "accept": "grep -c atom test/stress/test_sse_concurrency.valk returns 0", "deps": ["t-u8bc"]}
{"t": "task", "id": "t-cw2h", "spec": "deprecate-atoms.md", "name": "Add deprecation warnings to atom builtins", "s": "p", "notes": "In src/parser.c lines 4044-4100: Add VALK_WARN(\"atom is deprecated: use aio/semaphore or aio/then chains\") to valk_builtin_atom, valk_builtin_atom_get, valk_builtin_atom_set, valk_builtin_atom_add, valk_builtin_atom_sub. Warning only, not error.", "accept": "build/valk -e \"(atom 1)\" prints deprecation warning to stderr, make test passes with warnings", "deps": ["t-fdxw"]}
{"t": "task", "id": "t-v523", "spec": "deprecate-atoms.md", "name": "Remove valk_atom_t and atom builtin functions", "s": "p", "notes": "In src/parser.c: Remove valk_atom_t struct (lines 4040-4042) and all atom builtin functions (lines 4044-4100): valk_builtin_atom, valk_builtin_atom_get, valk_builtin_atom_set, valk_builtin_atom_add, valk_builtin_atom_sub", "accept": "grep -c valk_atom_t src/parser.c returns 0, grep -c valk_builtin_atom src/parser.c returns 0", "deps": ["t-cw2h"]}
{"t": "task", "id": "t-nfkc", "spec": "deprecate-atoms.md", "name": "Remove atom builtin registrations", "s": "p", "notes": "In src/parser.c valk_lenv_put_builtins (lines 5215-5219): Remove registrations for atom, atom/get, atom/set!, atom/add!, atom/sub!", "accept": "grep atom src/parser.c | grep valk_lenv_put_builtin returns empty", "deps": ["t-v523"]}
{"t": "task", "id": "t-jllq", "spec": "deprecate-atoms.md", "name": "Delete test/test_atom_builtins.valk", "s": "p", "notes": "Delete the entire file test/test_atom_builtins.valk since atom builtins are being removed.", "accept": "test/test_atom_builtins.valk does not exist", "deps": ["t-nfkc"]}
{"t": "task", "id": "t-g517", "spec": "deprecate-atoms.md", "name": "Remove atom error tests from test_parser_errors.c", "s": "p", "notes": "In test/test_parser_errors.c: Remove atom error tests around lines 1195-1215 that test atom builtin error handling.", "accept": "grep -c atom test/test_parser_errors.c returns 0", "deps": ["t-nfkc"]}
{"t": "task", "id": "t-27y6", "spec": "deprecate-atoms.md", "name": "Update test_sse_format.valk to use aio/then", "s": "p", "notes": "Update all 18 http2/client-request calls in test/test_sse_format.valk to use aio/then pattern. Pattern: change (http2/client-request aio host port path callback) to (aio/then (http2/client-request aio host port path) callback)", "accept": "grep -c \"aio/then.*http2/client-request\" test/test_sse_format.valk equals 18, make test passes"}
{"t": "task", "id": "t-h78t", "spec": "deprecate-atoms.md", "name": "Update test_sse_integration.valk to use aio/then", "s": "p", "notes": "Update all 17 http2/client-request calls in test/test_sse_integration.valk to use aio/then pattern. Pattern: change (http2/client-request aio host port path callback) to (aio/then (http2/client-request aio host port path) callback)", "accept": "grep -c \"aio/then.*http2/client-request\" test/test_sse_integration.valk equals 17, make test passes"}
{"t": "task", "id": "t-hz4o", "spec": "deprecate-atoms.md", "name": "Update test_large_response.valk to use aio/then", "s": "p", "notes": "Update 2 http2/client-request calls in test/test_large_response.valk to use aio/then pattern. Pattern: change (http2/client-request aio host port path callback) to (aio/then (http2/client-request aio host port path) callback)", "accept": "grep -c \"aio/then.*http2/client-request\" test/test_large_response.valk equals 2, make test passes"}
{"t": "task", "id": "t-0rpp", "spec": "deprecate-atoms.md", "name": "Update test_large_download.valk to use aio/then", "s": "p", "notes": "Update 3 http2/client-request calls in test/test_large_download.valk to use aio/then pattern. Pattern: change (http2/client-request aio host port path callback) to (aio/then (http2/client-request aio host port path) callback)", "accept": "grep -c \"aio/then.*http2/client-request\" test/test_large_download.valk equals 3, make test passes"}
{"t": "task", "id": "t-jjab", "spec": "deprecate-atoms.md", "name": "Update test_http_request_builtins.valk to use aio/then", "s": "p", "notes": "Update all 6 http2/client-request and http2/client-request-with-headers calls in test/test_http_request_builtins.valk to use aio/then pattern. Pattern: change (http2/client-request aio host port path callback) to (aio/then (http2/client-request aio host port path) callback)", "accept": "All http2/client-request calls use aio/then, make test passes"}
{"t": "task", "id": "t-64qj", "spec": "deprecate-atoms.md", "name": "Update test_server_stop.valk to use aio/then", "s": "p", "notes": "Update http2/client-request call in test/test_server_stop.valk to use aio/then pattern", "accept": "grep -c \"aio/then.*http2/client-request\" test/test_server_stop.valk equals 1, make test passes"}
{"t": "task", "id": "t-lzxg", "spec": "deprecate-atoms.md", "name": "Update test_sse_reconnect_minimal.valk to use aio/then", "s": "p", "notes": "Update 2 http2/client-request calls in test/test_sse_reconnect_minimal.valk to use aio/then pattern", "accept": "grep -c \"aio/then.*http2/client-request\" test/test_sse_reconnect_minimal.valk equals 2, make test passes"}
{"t": "task", "id": "t-yt8p", "spec": "deprecate-atoms.md", "name": "Update test_sse_concurrency_short.valk to use aio/then", "s": "p", "notes": "Update http2/client-request call in test/test_sse_concurrency_short.valk to use aio/then pattern", "accept": "grep -c \"aio/then.*http2/client-request\" test/test_sse_concurrency_short.valk equals 1, make test passes"}
{"t": "task", "id": "t-nvq1", "spec": "deprecate-atoms.md", "name": "Update test_sse_diagnostics_endpoint.valk to use aio/then", "s": "p", "notes": "Update http2/client-request call in test/test_sse_diagnostics_endpoint.valk to use aio/then pattern", "accept": "grep -c \"aio/then.*http2/client-request\" test/test_sse_diagnostics_endpoint.valk equals 1, make test passes"}
{"t": "task", "id": "t-edf7", "spec": "deprecate-atoms.md", "name": "Update test_sse_async_timeout.valk to use aio/then", "s": "p", "notes": "Update http2/client-request call in test/test_sse_async_timeout.valk to use aio/then pattern", "accept": "grep -c \"aio/then.*http2/client-request\" test/test_sse_async_timeout.valk equals 1, make test passes"}
{"t": "task", "id": "t-tut5", "spec": "deprecate-atoms.md", "name": "Update stress test files to use aio/then", "s": "p", "notes": "Update http2/client-request calls in test/stress/test_sse_concurrency.valk, test/stress/test_sse_concurrency_short.valk, and test/stress/test_delta_baseline_isolation.valk to use aio/then pattern", "accept": "All stress test files use aio/then for http2/client-request, make test passes"}
{"t": "task", "id": "t-yatm", "spec": "deprecate-atoms.md", "name": "Update test_sse_mini.valk to use aio/then", "s": "p", "notes": "Update 2 http2/client-request calls in test_sse_mini.valk (in project root) to use aio/then pattern", "accept": "grep -c \"aio/then.*http2/client-request\" test_sse_mini.valk equals 2, make test passes"}
{"t": "task", "id": "t-9cgo", "spec": "deprecate-atoms.md", "name": "Debug stream/closed future completion", "s": "p", "notes": "Investigation task: Run test_sse_builtins.valk with VALK_LOG=debug to trace what happens when stream/closed is called and the stream closes. Identify whether: (1) the closed_handle is created, (2) __stream_body_finish_close is called, (3) valk_async_handle_complete is called, (4) the aio/then callback fires. Output the debug trace and document findings.", "accept": "Document the debug findings showing where the stream/closed future completion breaks down"}
{"t": "task", "id": "t-ef8u", "spec": "deprecate-atoms.md", "name": "Fix stream/closed future if needed and add test", "s": "p", "notes": "Based on debug findings, fix any issues in the stream/closed implementation. Then add a positive test to test/test_sse_builtins.valk that verifies stream/closed returns a future completing with :closed. Pattern to follow: open SSE stream in handler, get closed future, schedule stream close, verify future completes via aio/then. Keep test simple - 200ms timeout max.", "accept": "test/test_sse_builtins.valk has passing test for stream/closed positive case, make test passes", "deps": ["t-9cgo"]}
