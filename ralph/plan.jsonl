{"t": "spec", "spec": "debug-dashboard-validation.md"}
{"t": "task", "id": "t-iyj5", "spec": "debug-dashboard-validation.md", "name": "Add make test-stress-tsan target", "s": "d", "notes": "Create Makefile target that runs stress tests under ThreadSanitizer. Must redirect TSAN output to file per AGENTS.md. Key tests: test_sse_concurrency.valk, test_delta_baseline_isolation.valk", "accept": "make test-stress-tsan runs stress tests with TSAN, output goes to build/tsan-stress.log, 0 data races", "deps": ["t-7h3x"], "done_at": "ba19fdb", "priority": "high", "reject": "TSAN reports 10 data races in memory.c and aio_async.c, acceptance requires 0 races"}
{"t": "task", "id": "t-evd5", "spec": "debug-dashboard-validation.md", "name": "Add pthread-based close race test", "s": "p", "notes": "Existing close race tests in test_stream_body_integration.c are single-threaded. Add true concurrent test using pthreads: spawn 2 threads that both call valk_stream_body_close() simultaneously. Verify no crash, no double-free.", "accept": "New pthread test in test_stream_body_integration.c passes, no TSAN warnings", "priority": "medium", "reject": "No pthread_create in test - test calls close sequentially, not from 2 concurrent threads"}
{"t": "task", "id": "t-cwlz", "spec": "debug-dashboard-validation.md", "name": "Add debug handler header validation tests", "s": "p", "notes": "test_debug_handler.valk verifies response bodies but not headers. Add tests verifying: /debug/metrics/state returns Content-Type: application/json, Cache-Control: no-cache...; /metrics returns Content-Type: text/plain; version=0.0.4", "accept": "Tests verify correct Content-Type and Cache-Control headers for debug endpoints", "priority": "medium", "reject": "No Content-Type or Cache-Control header validation in test_debug_handler.valk"}
{"t": "task", "id": "t-p3w9", "spec": "debug-dashboard-validation.md", "name": "Add slab/buckets query param tests", "s": "p", "notes": "test_debug_handler.valk tests /debug/slab/buckets with default values only. Add tests with query params: slab=X, start=Y, end=Z, buckets=N to verify parsing works correctly.", "accept": "Tests verify /debug/slab/buckets correctly parses slab, start, end, buckets query params", "priority": "medium", "reject": "No slab query param tests (slab=, start=, end=, buckets=) in test_debug_handler.valk"}
{"t": "task", "id": "t-2vd4", "spec": "debug-dashboard-validation.md", "name": "Add debug/reset-state unit tests", "s": "p", "notes": "debug-broadcaster.valk has debug/reset-state for bulk cleanup on session ID change. No explicit unit tests exist. Add tests verifying: session ID increments, old subscribers get cleaned up, new subscribers work after reset.", "accept": "Tests verify debug/reset-state behavior in test_debug_handler.valk", "priority": "low", "reject": "No reset-state tests found in test_debug_handler.valk"}
{"t": "task", "id": "t-76lv", "spec": "debug-dashboard-validation.md", "name": "Add GC coordination integration test", "s": "p", "notes": "Create test/test_gc_aio.c that tests GC triggering after aio/start: 1) Start aio, 2) Trigger GC, 3) Verify no hang. Also test allocation after aio/start triggers auto-GC. Use timeout to catch hangs.", "accept": "Test passes: make build && build/test_gc_aio completes in <5 seconds with exit 0", "deps": ["t-txro"], "priority": "medium", "reject": "test/test_gc_aio.c does not exist - only test_gc_aio_debug.c and test_gc_aio_hang.c exist"}
{"t": "task", "id": "t-joav", "spec": "debug-dashboard-validation.md", "name": "Run SSE short test to verify hang fix", "s": "d", "notes": "Run test/test_sse_concurrency_short.valk to verify the GC/aio hang is fixed. This test previously hung on startup. Should complete in <15s.", "accept": "build/valk test/test_sse_concurrency_short.valk exits 0 in under 15 seconds", "deps": ["t-txro"], "done_at": "3bc1d14", "priority": "high"}
{"t": "task", "id": "t-4ec8", "spec": "debug-dashboard-validation.md", "name": "Analyze GC-AIO coordination mechanism", "s": "p", "notes": "Research how GC coordinates with event loop thread. Focus on: (1) How main thread waits for event loop to pause, (2) How event loop signals it reached safe point, (3) What happens with libuv async coalescing. Output: detailed flow description and identify exact deadlock scenario.", "accept": "Written analysis in /tmp/gc_aio_analysis.md with specific code paths and deadlock explanation", "priority": "high", "reject": "/tmp/gc_aio_analysis.md does not exist"}
{"t": "task", "id": "t-hmqm", "spec": "debug-dashboard-validation.md", "name": "Verify make test passes after GC-AIO fix", "s": "d", "notes": "Run full test suite to ensure fix does not break anything. If timeouts occur, identify which specific test hangs.", "accept": "make test completes successfully within 5 minutes", "deps": ["t-88mw"], "done_at": "55d8499", "priority": "high"}
{"t": "task", "id": "t-kaka", "spec": "debug-dashboard-validation.md", "name": "Fix GC mark_env2 to handle malloc-allocated environments", "s": "d", "notes": "The mark_env2() and mark_env2_parallel() functions incorrectly bail out when an environment is not in the GC heap. In mark_env2 (line ~3254) and mark_env2_parallel (line ~3616), the code uses `if (!mark_ptr_only(env, ctx)) return;` which causes immediate return when the root environment is malloc-allocated (because valk_thread_ctx.heap is NULL during environment creation in valk_lenv_empty()). This abandons traversal of all values in the environment, causing the sweep phase to free builtins like +, def, println. Fix: (1) Remove early-return when mark_ptr_only(env) fails - still traverse environment contents. (2) Track visited environments separately using worklist/visited-set pattern since we cannot rely on mark bitmap for cycle detection on malloc environments. (3) Only use mark_ptr_only for env struct to mark it if it IS in heap, but do not bail on failure.", "accept": "Run make test to verify all tests pass. After mem/gc/collect, builtins like +, def, println must remain bound. No infinite loops on cyclic environments.", "done_at": "7a2c89b", "priority": "medium"}
{"t": "task", "id": "t-59lb", "spec": "debug-dashboard-validation.md", "name": "Commit gc.c debug output cleanup", "s": "d", "notes": "There are uncommitted changes to gc.c that remove debug fprintf statements. Commit these changes as a preparatory cleanup.", "accept": "Changes to gc.c are committed with appropriate message", "done_at": "a2f4844", "priority": "high"}
{"t": "task", "id": "t-10t0", "spec": "debug-dashboard-validation.md", "name": "Move GC thread registration to after uv_run is ready", "s": "d", "notes": "Per analysis in gc_aio_analysis.md: The deadlock happens because event loop thread registers with GC before entering uv_run(). Fix: In aio_uv.c __event_loop(), move valk_gc_thread_register() call to right before uv_run() starts, AFTER uv_sem_post. This ensures the thread is only counted for GC when it can respond to async signals.", "accept": "Event loop thread registers for GC immediately before uv_run(). Test: timeout 5 build/valk with (def {aio} (aio/start)) (sleep 0.1) (mem/gc/collect) (aio/stop aio) should not hang (may still error due to separate env corruption bug).", "deps": ["t-59lb"], "done_at": "4054e04", "priority": "high"}
{"t": "task", "id": "t-mals", "spec": "debug-dashboard-validation.md", "name": "Create minimal GC-AIO hang test", "s": "d", "notes": "Create test/test_gc_aio_hang.c that verifies the GC-AIO coordination fix. Test should: 1) Start AIO, 2) Wait briefly for event loop to start, 3) Trigger GC, 4) Stop AIO. Should complete in <5s without hanging. Use alarm() as timeout. Do NOT check for correctness of values after GC (that is a separate bug in t-kaka).", "accept": "test/test_gc_aio_hang.c exists, make build succeeds, build/test_gc_aio_hang completes in <5 seconds with exit 0", "deps": ["t-10t0"], "done_at": "718bdcb", "decompose": true, "kill": "timeout", "kill_log": "/home/xyzyx/src/valkyria/build/ralph-logs/ralph-20260119_200831-build.log", "priority": "high"}
{"t": "task", "id": "t-fehl", "spec": "debug-dashboard-validation.md", "name": "Fix TSAN races in arena allocator stats and async handle callbacks", "s": "p", "notes": "Arena stats race: The offset field uses proper atomic CAS but stats fields (lines 501-505, 477-481) use non-atomic increments. Options: (1) make stats fields _Atomic, (2) use thread-local arenas, (3) accept racy stats for telemetry (document as approximate). Async handle race: on_done/on_done_ctx in valk_async_notify_done (lines 156-160) need atomic load/store or guarantee single-thread access. Recommended approach: use relaxed atomics for stats (telemetry doesn't need precision), use atomic pointer ops for on_done callback fields.", "accept": "TSAN stress tests pass with 0 races in valk_mem_arena_alloc and valk_async_notify_done", "priority": "medium"}
{"t": "reject", "id": "t-iyj5", "done_at": "c068a04", "reason": "TSAN reports 10 data races in memory.c and aio_async.c, acceptance requires 0 races"}
{"t": "reject", "id": "t-evd5", "done_at": "e1a1bee", "reason": "No pthread_create in test - test calls close sequentially, not from 2 concurrent threads"}
{"t": "reject", "id": "t-cwlz", "done_at": "e0da374", "reason": "No Content-Type or Cache-Control header validation in test_debug_handler.valk"}
{"t": "reject", "id": "t-p3w9", "done_at": "dd9ec4c", "reason": "No slab query param tests (slab=, start=, end=, buckets=) in test_debug_handler.valk"}
{"t": "reject", "id": "t-2vd4", "done_at": "31858f2", "reason": "No reset-state tests found in test_debug_handler.valk"}
{"t": "reject", "id": "t-76lv", "done_at": "26ea627", "reason": "test/test_gc_aio.c does not exist - only test_gc_aio_debug.c and test_gc_aio_hang.c exist"}
{"t": "reject", "id": "t-4ec8", "done_at": "1d7fdaf", "reason": "/tmp/gc_aio_analysis.md does not exist"}
