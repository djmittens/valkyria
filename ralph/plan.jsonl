{"t": "spec", "spec": "debug-dashboard-validation.md"}
{"t": "task", "id": "t-1-1", "spec": "debug-dashboard-validation.md", "name": "Add stream body integration test", "s": "d", "notes": "File: test/test_stream_body_integration.c. Test actual data flow through nghttp2: write queues data, read callback dequeues, close triggers on-close callback, backpressure when queue full. Look at test/test_http2_streaming.c for patterns.", "accept": "Test verifies data flows correctly through stream body to nghttp2", "done_at": "17d0bf0"}
{"t": "task", "id": "t-1-2", "spec": "debug-dashboard-validation.md", "name": "Test stream/write under connection close race", "s": "d", "notes": "In test_stream_body_integration.c: Start write, close connection mid-write. Verify no crash, no use-after-free, error returned. Run under TSAN and ASAN.", "accept": "No crashes or memory errors when write races with close", "deps": ["t-1-1"], "done_at": "7a22fad"}
{"t": "task", "id": "t-1-3", "spec": "debug-dashboard-validation.md", "name": "Test concurrent writes to same stream", "s": "d", "notes": "In test_stream_body_integration.c: Multiple rapid writes from same context. Verify all data delivered in order, no corruption.", "accept": "All writes delivered in order without corruption", "deps": ["t-1-1"], "done_at": "a00c756"}
{"t": "task", "id": "t-1-4", "spec": "debug-dashboard-validation.md", "name": "Test on-close callback timing", "s": "d", "notes": "In test_stream_body_integration.c: Verify callback fires exactly once, before stream body freed, callback can safely access stream state.", "accept": "on-close callback fires exactly once with valid stream state", "deps": ["t-1-1"], "done_at": "baeb777"}
{"t": "task", "id": "t-2-1", "spec": "debug-dashboard-validation.md", "name": "Test sse/send wire format", "s": "d", "notes": "File: test/test_sse_format.valk. Test: sse/send 'hello' -> 'data: hello\\n\\n', sse/send 'a\\nb' -> 'data: a\\ndata: b\\n\\n'. Capture actual wire output and compare.", "accept": "sse/send produces correct SSE wire format for all cases", "done_at": "5a1c65f"}
{"t": "task", "id": "t-2-2", "spec": "debug-dashboard-validation.md", "name": "Test sse/event wire format", "s": "d", "notes": "In test/test_sse_format.valk: Test sse/event 'msg' 'data' -> 'event: msg\\ndata: data\\n\\n'. Test with multi-line data.", "accept": "sse/event produces correct SSE wire format", "deps": ["t-2-1"], "done_at": "3cef8a1"}
{"t": "task", "id": "t-2-3", "spec": "debug-dashboard-validation.md", "name": "Test sse/id and sse/full wire format", "s": "d", "notes": "In test/test_sse_format.valk: Test sse/id and sse/full produce correct 'id:' and combined format.", "accept": "sse/id and sse/full produce correct wire format", "deps": ["t-2-1"], "done_at": "ac5b5dd"}
{"t": "task", "id": "t-2-4", "spec": "debug-dashboard-validation.md", "name": "Test sse/retry and sse/comment wire format", "s": "d", "notes": "In test/test_sse_format.valk: Test sse/retry 5000 -> 'retry: 5000\\n\\n', sse/comment 'ping' -> ': ping\\n', sse/heartbeat -> ':\\n'.", "accept": "sse/retry, sse/comment, sse/heartbeat produce correct format", "deps": ["t-2-1"], "done_at": "2c8f3ba"}
{"t": "task", "id": "t-3-1", "spec": "debug-dashboard-validation.md", "name": "Test debug handler route matching", "s": "d", "notes": "File: test/test_debug_handler.valk. Test all routes: /debug, /debug/, /debug/metrics, /debug/metrics/state, /metrics, /debug/diagnostics/memory, /debug/slab/buckets. Verify correct response for each.", "accept": "All debug routes return expected responses", "done_at": "29372e4"}
{"t": "task", "id": "t-3-2", "spec": "debug-dashboard-validation.md", "name": "Test /debug/metrics/state JSON structure", "s": "d", "notes": "In test_debug_handler.valk: Request endpoint, parse JSON, verify structure: metrics.aio, metrics.modular, metrics.vm, metrics.registry, memory.", "accept": "JSON structure matches expected schema", "deps": ["t-3-1"], "done_at": "f85449f"}
{"t": "task", "id": "t-3-3", "spec": "debug-dashboard-validation.md", "name": "Test /debug/diagnostics/memory SSE events", "s": "d", "notes": "In test_debug_handler.valk: Connect to SSE endpoint, verify first event is 'diagnostics' (full state), subsequent are 'diagnostics-delta'. Parse and validate JSON structure.", "accept": "SSE events have correct types and valid JSON", "deps": ["t-3-1"], "done_at": "9fa4728"}
{"t": "task", "id": "t-3-4", "spec": "debug-dashboard-validation.md", "name": "Test SSE handler lifecycle", "s": "d", "notes": "In test_debug_handler.valk: Connect, receive events, disconnect. Verify timer stops after disconnect (no more events if reconnected briefly). Verify reconnect works.", "accept": "Timer stops on disconnect, reconnect works", "deps": ["t-3-3"], "done_at": "903ac6e"}
{"t": "task", "id": "t-3-5", "spec": "debug-dashboard-validation.md", "name": "Test /metrics Prometheus format", "s": "d", "notes": "In test_debug_handler.valk: Request /metrics, verify contains expected metric names (valk_gc_, http_), verify format is valid Prometheus exposition.", "accept": "/metrics returns valid Prometheus format", "deps": ["t-3-1"], "done_at": "8aacc15"}
{"t": "task", "id": "t-4-1", "spec": "debug-dashboard-validation.md", "name": "Document observed concurrency issues", "s": "p", "notes": "Capture specific symptoms from manual testing. What operations trigger issues? Error messages? Crashes? Incorrect data? Create subtasks for each distinct issue.", "accept": "Concurrency issues documented with reproduction steps"}
{"t": "task", "id": "t-4-2", "spec": "debug-dashboard-validation.md", "name": "Add SSE concurrency stress test", "s": "p", "notes": "File: test/stress/test_sse_concurrency.valk. 10 concurrent SSE connections, rapid connect/disconnect cycles, run 60 seconds. Verify no crashes, hangs, or leaks.", "accept": "Stress test passes without crashes or hangs", "deps": ["t-3-3"]}
{"t": "task", "id": "t-4-3", "spec": "debug-dashboard-validation.md", "name": "Test delta baseline isolation", "s": "p", "notes": "In stress test: Two SSE connections, increment metrics between their events, verify each sees correct deltas. Tests whether metrics/collect-delta uses per-connection or shared state.", "accept": "Each connection gets correct deltas for its timeline", "deps": ["t-4-2"]}
{"t": "task", "id": "t-4-4", "spec": "debug-dashboard-validation.md", "name": "Run stress test under TSAN", "s": "p", "notes": "Run test_sse_concurrency.valk with make test-valk-tsan or equivalent. Identify any data races reported.", "accept": "No TSAN warnings, or all races documented", "deps": ["t-4-2"]}
{"t": "task", "id": "t-4-5", "spec": "debug-dashboard-validation.md", "name": "Run stress test under ASAN", "s": "p", "notes": "Run test_sse_concurrency.valk with make test-valk-asan. Identify any memory errors.", "accept": "No ASAN errors, or all errors documented", "deps": ["t-4-2"]}
{"t": "task", "id": "t-4-6", "spec": "debug-dashboard-validation.md", "name": "Fix identified concurrency issues", "s": "p", "notes": "Create fix for each issue found in t-4-1 through t-4-5. Add regression test for each fix.", "accept": "All identified issues fixed with regression tests", "deps": ["t-4-1", "t-4-4", "t-4-5"]}
{"t": "task", "id": "t-5-1", "spec": "debug-dashboard-validation.md", "name": "Create debug-broadcaster.valk", "s": "p", "notes": "File: src/modules/aio/debug-broadcaster.valk. Single 100ms timer shared across all subscribers. Subscriber list as atom. On tick: collect once, broadcast to all. Start timer on first subscribe, stop on last unsubscribe.", "accept": "Broadcaster module loads, timer lifecycle correct", "deps": ["t-4-6"]}
{"t": "task", "id": "t-5-2", "spec": "debug-dashboard-validation.md", "name": "Implement per-subscriber baseline", "s": "p", "notes": "In debug-broadcaster.valk: Each subscriber entry stores its baseline. First event sends full state. Subsequent events compute delta from that subscriber's baseline. May need new builtin or Lisp-side tracking.", "accept": "Each subscriber gets accurate deltas from its own baseline", "deps": ["t-5-1"]}
{"t": "task", "id": "t-5-3", "spec": "debug-dashboard-validation.md", "name": "Implement subscribe/unsubscribe API", "s": "p", "notes": "In debug-broadcaster.valk: debug/subscribe sys stream adds to list, starts timer if first. debug/unsubscribe removes, stops timer if last. Auto-unsubscribe on stream/on-close.", "accept": "Subscribe/unsubscribe work correctly, timer auto-managed", "deps": ["t-5-1"]}
{"t": "task", "id": "t-5-4", "spec": "debug-dashboard-validation.md", "name": "Implement backpressure handling", "s": "p", "notes": "In debug-broadcaster.valk: Track consecutive failed writes per subscriber (stream/writable? returns 0). Disconnect after 10 failures. Log disconnection.", "accept": "Slow subscribers disconnected after threshold", "deps": ["t-5-3"]}
{"t": "task", "id": "t-5-5", "spec": "debug-dashboard-validation.md", "name": "Update debug.valk to use broadcaster", "s": "p", "notes": "Modify src/modules/aio/debug.valk: Replace aio/interval in SSE handler with debug/subscribe. Load debug-broadcaster.valk. Verify dashboard still works.", "accept": "Dashboard works with broadcaster, single timer for all connections", "deps": ["t-5-4"]}
{"t": "task", "id": "t-5-6", "spec": "debug-dashboard-validation.md", "name": "Add broadcaster tests", "s": "p", "notes": "In test_debug_handler.valk or new file: Verify single timer for multiple connections, timer stops when last leaves, slow subscriber disconnected without affecting fast ones.", "accept": "Broadcaster behavior verified by tests", "deps": ["t-5-5"]}
