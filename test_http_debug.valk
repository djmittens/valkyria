(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {aio} (aio/await (aio/start)))
(printf "1. aio started\n")

(def {server-handler}
  (\ {req} {`{:status "200" :body "OK"}}))

(def {server} (http2/server-listen aio 0 server-handler))
(def {test-port} (http2/server-port server))
(printf "2. Server on port %d\n" test-port)

(def {tests} (list
  (test-async "http" (\ {} {
    (printf "  [test body] creating request\n")
    (def {h} (http2/client-request aio "127.0.0.1" test-port "/"))
    (printf "  [test body] got handle, returning aio/then chain\n")
    (aio/then h (\ {resp} {
      (printf "  [then callback] got response\n")
      (== (http2/response-status resp) "200")
    }))
  }))))
(printf "3. Tests created\n")

(printf "4. About to map\n")
(def {handles} (map (\ {t} {
  (printf "  [map] processing %s\n" (str (head t)))
  (*test-run-async-one* aio 5000 t)
}) tests))
(printf "5. Map done\n")

(aio/stop aio)
