(load "src/prelude.valk")
(load "src/modules/test.valk")
(load "src/http_api.valk")

(def {aio} (aio/await (aio/start)))

(def {server-handler}
  (\ {req} {
    (= {path} (req/path req))
    (if (== path "/error")
      {`{:status "500" :body "Internal Server Error"}}
      {`{:status "200" :body "Hello from test server"}})
  }))

(def {server} (http2/server-listen aio 0 server-handler))
(def {test-port} (http2/server-port server))
(printf "Server on port %d\n" test-port)

(test/run-async aio (list
  (test-async "http request works" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" test-port "/") (\ {resp} {
      (== (http2/response-status resp) "200")
    }))
  })))
  {:suite-name "HTTP Test"})
