; Arena Pool Leak Detection Tests
; Verifies that arena pool counts return to baseline after HTTP request cycles

(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {aio} (aio/await (aio/start)))

(fun {get-arena-available sys} {
  (= {stats} (aio/pool-stats sys))
  (= {arenas} (plist/get stats :arenas))
  (plist/get arenas :available)
})

(def {async-handler}
  (\ {req} {
    (aio/then (aio/sleep aio 1) (\ {_} {
      {:status "200" :body "async-response"}
    }))
  }))

(def {sync-handler}
  (\ {req} {
    {:status "200" :body "sync-response"}
  }))

(def {server} (http2/server-listen aio 0 async-handler))
(def {test-port} (http2/server-port server))

(test/run-async aio (list
  (test-async "arenas return to baseline after async requests" (\ {} {
    (= {initial} (get-arena-available aio))
    (= {handles} (list
      (http2/client-request aio "127.0.0.1" test-port "/")
      (http2/client-request aio "127.0.0.1" test-port "/")
      (http2/client-request aio "127.0.0.1" test-port "/")
      (http2/client-request aio "127.0.0.1" test-port "/")
      (http2/client-request aio "127.0.0.1" test-port "/")))
    (aio/then (aio/all handles) (\ {_} {
      (aio/then (aio/sleep aio 100) (\ {_} {
        (= {final} (get-arena-available aio))
        (== initial final)
      }))
    }))
  })))
  {:suite-name "Arena Pool Leak Detection"})
