(load "src/prelude.valk")
(load "src/modules/aio/debug.valk")

(def {TEST_PORT} (net/get-available-port))
(def {aio} (aio/start))
(def {test-passed} 0)
(def {handler-called} 0)
(def {sse-data-received} 0)

(def {wrapped-handler}
  (\ {req ctx} {
    (= {path} (req/path req))
    (if (== path "/debug/diagnostics/memory")
      {(do
        (def {handler-called} 1)
        (println "Handler called for /debug/diagnostics/memory")
      )}
      {nil}
    )
    ((aio/debug-handler aio) req ctx)
  }))

(println "")
(println "=== SSE Diagnostics Endpoint Test ===")
(println "")
(printf "Starting server on port %d\n" TEST_PORT)
(http2/server-listen aio TEST_PORT wrapped-handler)

(aio/schedule aio 100 (\ {} {
  (println "Requesting /debug/diagnostics/memory endpoint...")
  (http2/client-request aio "127.0.0.1" TEST_PORT "/debug/diagnostics/memory" (\ {resp} {
    (println "Client callback received (SSE stream data)")
    (def {sse-data-received} 1)
  }))
}))

(aio/schedule aio 400 (\ {} {
  (if (== handler-called 1)
    {(println "Handler called, waiting for SSE timer to push data...")}
    {nil}
  )
}))

(aio/schedule aio 800 (\ {} {
  (if (and (== handler-called 1) (== sse-data-received 1))
    {(do
      (println "")
      (println "PASS: SSE diagnostics handler called AND data received")
      (def {test-passed} 1)
      (exit 0)
    )}
    {(if (== handler-called 1)
      {(do
        (println "")
        (println "PASS: SSE diagnostics handler was called (data pending)")
        (def {test-passed} 1)
        (exit 0)
      )}
      {nil}
    )}
  )
}))

(aio/schedule aio 2000 (\ {} {
  (if (== test-passed 1)
    {(exit 0)}
    {(do
      (println "")
      (printf "Handler called: %d, SSE data received: %d\n" handler-called sse-data-received)
      (println "=== Test Failed (handler not called) ===")
      (exit 1)
    )}
  )
}))

(aio/schedule aio 5000 (\ {} {
  (println "TIMEOUT!")
  (exit 1)
}))

(aio/run aio)
