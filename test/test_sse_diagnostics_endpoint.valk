; SSE Diagnostics Endpoint Test
; Tests that the /debug/diagnostics/memory endpoint works with SSE
; Note: Due to Lisp scoping, verifies via successful completion

(load "src/prelude.valk")
(load "src/modules/test.valk")
(load "src/modules/aio/debug.valk")

(test/suite "SSE Diagnostics Endpoint Tests")

(def {aio} (aio/start))

(def {wrapped-handler}
  (\ {req} {
    ; Just delegate to debug handler
    ((aio/debug-handler aio) req)
  }))

(def {server} (http2/server-listen aio 0 wrapped-handler))
(def {TEST_PORT} (http2/server-port server))

(test/async "SSE diagnostics handler is called for /debug/diagnostics/memory" (\ {done} {
  (http2/client-request aio "127.0.0.1" TEST_PORT "/debug/diagnostics/memory" (\ {resp} {}))
  
  ; Wait for response - if endpoint works, we get a response
  (aio/schedule aio 500 (\ {} {
    ; If we got here without crash, diagnostics endpoint worked
    (done true)
  }))
}))

(test/run-async aio)
(aio/run aio)
