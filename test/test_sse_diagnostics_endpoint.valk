; SSE Diagnostics Endpoint Test
; Tests that the /debug/diagnostics/memory endpoint works with SSE
; Note: Due to Lisp scoping, verifies via successful completion

(load "src/prelude.valk")
(load "src/modules/test.valk")
(load "src/modules/aio/debug.valk")

(def {aio} (aio/start))

(def {wrapped-handler}
  (\ {req} {
    ; Just delegate to debug handler
    ((aio/debug-handler aio) req)
  }))

(def {server} (http2/server-listen aio 0 wrapped-handler))
(def {TEST_PORT} (http2/server-port server))

(test/run-async aio (list
  (test-async "SSE diagnostics handler is called for /debug/diagnostics/memory" (\ {done} {
  ; Start the SSE request (returns handle, but SSE never completes)
  (http2/client-request aio "127.0.0.1" TEST_PORT "/debug/diagnostics/memory")
  
  ; Wait 500ms - if endpoint works without crash, test passes
  (aio/then (aio/sleep aio 500) (\ {_} {
    (done true)
  }))
})))
  {:suite-name "SSE Diagnostics Endpoint Tests"})
