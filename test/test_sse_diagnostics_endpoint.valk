; SSE Diagnostics Endpoint Test
; Tests that the /debug/diagnostics/memory endpoint works with SSE

(load "src/prelude.valk")
(load "src/modules/test.valk")
(load "src/modules/aio/debug.valk")

(test/suite "SSE Diagnostics Endpoint Tests")

(def {aio} (aio/start))

(def {handler-called} 0)

(def {wrapped-handler}
  (\ {req} {
    (= {path} (req/path req))
    (if (== path "/debug/diagnostics/memory")
      {(def {handler-called} 1)}
      {nil}
    )
    ((aio/debug-handler aio) req)
  }))

(def {server} (http2/server-listen aio 0 wrapped-handler))
(def {TEST_PORT} (http2/server-port server))

(test/async "SSE diagnostics handler is called for /debug/diagnostics/memory" (\ {done} {
  (http2/client-request aio "127.0.0.1" TEST_PORT "/debug/diagnostics/memory" (\ {resp} {
    nil
  }))
  
  (aio/schedule aio 500 (\ {} {
    (done (== handler-called 1))
  }))
}))

(test/run-async aio)
(aio/run aio)
