; SSE Reconnect/Sequential Request Test
; Tests that multiple sequential SSE requests work correctly

(load "src/prelude.valk")
(load "src/modules/test.valk")
(load "src/modules/aio/sse.valk")

(def {aio} (aio/await (aio/start)))

(def {handler}
  (\ {req} {
    (= {stream} (sse/open req))
    (stream/write stream "data: event-data\n\n")
    (stream/close stream)}))

(def {server} (http2/server-listen aio 0 handler))
(def {port} (http2/server-port server))

; Helper to check response is valid 200
(fun {check-response resp} {
  (if (error? resp)
    {false}
    {(== (http2/response-status resp) "200")})})

(test/run-async aio (list
  (test-async "first SSE request completes with 200" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" port "/sse")
      (\ {resp} {(check-response resp)}))}))

  (test-async "second SSE request after delay completes" (\ {} {
    (aio/then (aio/sleep aio 50) 
      (\ {_} {
        (aio/then (http2/client-request aio "127.0.0.1" port "/sse")
          (\ {resp} {(check-response resp)}))}))}))

  (test-async "SSE response contains expected data" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" port "/sse")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(== (http2/response-body resp) "data: event-data\n\n")})}))}))
) {:suite-name "SSE Sequential Request Tests" :timeout-ms 5000})
