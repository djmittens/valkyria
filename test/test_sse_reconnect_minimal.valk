(load "src/prelude.valk")
(load "src/modules/aio/sse.valk")

(= {aio} (aio/await (aio/start)))

(= {handler} (\ {req} {
  (= {stream} (sse/open req))
  (stream/write stream "data: event-data\n\n")
  (stream/close stream)
  :deferred
}))

(= {server} (http2/server-listen aio 0 handler))
(= {port} (http2/server-port server))

(print "STEP1_START")
(aio/then (http2/client-request aio "127.0.0.1" port "/sse")
  (\ {resp1} {
    (if (error? resp1)
      {(print "STEP1_ERROR" resp1)}
      {(do
        (print "STEP1_DONE")
        (aio/schedule aio 50 (\ {} {
          (print "STEP2_START")
          (aio/then (http2/client-request aio "127.0.0.1" port "/sse")
            (\ {resp2} {
              (if (error? resp2)
                {(print "STEP2_ERROR" resp2)}
                {(do
                  (print "STEP2_DONE")
                  (http2/server-close server)
                  (aio/stop aio))})}))
        }))
      )})
  }))

(aio/run aio)
(print "TEST_COMPLETE")
