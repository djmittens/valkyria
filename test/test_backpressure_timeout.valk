; Backpressure Edge Case Coverage Test
; Tests backpressure queue overflow, list removal traversal, and timeout paths
;
; Targets:
; - __backpressure_list_add queue full path (line 451-453)
; - __backpressure_list_remove traversal (line 466-476) - removing from middle
; - Maintenance timer backpressure timeout (line 1276-1298)
; - __backpressure_try_resume_one (lines 488-525)

(load "src/prelude.valk")
(load "src/modules/test.valk")

(test/suite "Backpressure Timeout Coverage Test")

(def {aio} (aio/start {
  :max-connections 8
  :tcp-buffer-pool-size 10
  :backpressure-list-max 2
  :backpressure-timeout-ms 1000
  :maintenance-interval-ms 100
  :min-buffers-to-resume 1
}))

(def {server} (http2/server-listen aio 0 (\ {req} {
  (aio/then (aio/sleep aio 800) (\ {_} {{:status "200" :body "OK"}}))
})))
(def {test-port} (http2/server-port server))

(def {requests-completed} 0)
(def {requests-started} 0)
(def {errors} 0)
(def {test-done-callback} nil)
(def {test-already-done} 0)

(fun {finish-test} {
  (if (== test-already-done 0)
    {do
      (def {test-already-done} 1)
      (test-done-callback (>= (+ requests-completed errors) 4))}
    {true})
})

(fun {send-request} {
  (def {requests-started} (+ requests-started 1))
  (http2/client-request aio "127.0.0.1" test-port "/" (\ {resp} {
    (if (error? resp)
      {(def {errors} (+ errors 1))}
      {(def {requests-completed} (+ requests-completed 1))})
    (if (>= (+ requests-completed errors) 14)
      {(finish-test)}
      {true})
  }))
})

(test/async "backpressure timeout and recovery" (\ {done} {
  (def {test-done-callback} done)
  
  (aio/schedule aio 50 (\ {} {
    (send-request)
    (send-request)
    (send-request)
    (send-request)
  }))
  
  (aio/schedule aio 80 (\ {} {
    (send-request)
    (send-request)
    (send-request)
    (send-request)
    (send-request)
    (send-request)
  }))
  
  (aio/schedule aio 1200 (\ {} {
    (send-request)
    (send-request)
  }))
  
  (aio/schedule aio 2500 (\ {} {
    (send-request)
    (send-request)
  }))
  
  (aio/schedule aio 5000 (\ {} {
    (finish-test)
  }))
}))

(test/run-async aio)
