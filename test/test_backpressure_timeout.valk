; Backpressure Edge Case Coverage Test
; Tests that requests fail cleanly under buffer exhaustion and backpressure timeout

(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {aio} (aio/await (aio/start {
  :max-connections 4
  :tcp-buffer-pool-size 6
  :backpressure-timeout-ms 1000
  :maintenance-interval-ms 100
})))

(def {server} (http2/server-listen aio 0 (\ {req} {
  {:status "200" :body "OK"}
})))
(def {test-port} (http2/server-port server))

(test/run-async aio (list
  (test-async "backpressure timeout and recovery" (\ {} {
    ; Create requests directly - some will succeed, some will fail
    (= {reqs} (list
      (http2/client-request aio "127.0.0.1" test-port "/")
      (http2/client-request aio "127.0.0.1" test-port "/")
      (http2/client-request aio "127.0.0.1" test-port "/")
      (http2/client-request aio "127.0.0.1" test-port "/")))
    
    (aio/then (aio/all-settled reqs) (\ {results} {
      ; Test passes if all requests settled (success or failure)
      (= {settled} (foldl (\ {c r} {
        (if (or (plist/has? r :value) (plist/has? r :error)) {(+ c 1)} {c})
      }) 0 results))
      (== settled 4)
    }))
  })))
  {:suite-name "Backpressure Timeout Coverage Test" :timeout-ms 8000 :suite-timeout-ms 12000})
