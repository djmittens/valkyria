; Backpressure Edge Case Coverage Test
; Tests backpressure queue overflow, list removal traversal, and timeout paths

(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {aio} (aio/start {
  :max-connections 8
  :tcp-buffer-pool-size 10
  :backpressure-list-max 2
  :backpressure-timeout-ms 1000
  :maintenance-interval-ms 100
  :min-buffers-to-resume 1
}))

(def {server} (http2/server-listen aio 0 (\ {req} {
  (aio/then (aio/sleep aio 800) (\ {_} {{:status "200" :body "OK"}}))
})))
(def {test-port} (http2/server-port server))

(test/run-async aio (list
  (test-async "backpressure timeout and recovery" (\ {} {
    (= {batch1} (aio/then (aio/sleep aio 50) (\ {_} {
      (list
        (http2/client-request aio "127.0.0.1" test-port "/")
        (http2/client-request aio "127.0.0.1" test-port "/")
        (http2/client-request aio "127.0.0.1" test-port "/")
        (http2/client-request aio "127.0.0.1" test-port "/"))
    })))
    (= {batch2} (aio/then (aio/sleep aio 80) (\ {_} {
      (list
        (http2/client-request aio "127.0.0.1" test-port "/")
        (http2/client-request aio "127.0.0.1" test-port "/")
        (http2/client-request aio "127.0.0.1" test-port "/")
        (http2/client-request aio "127.0.0.1" test-port "/")
        (http2/client-request aio "127.0.0.1" test-port "/")
        (http2/client-request aio "127.0.0.1" test-port "/"))
    })))
    (= {batch3} (aio/then (aio/sleep aio 1200) (\ {_} {
      (list
        (http2/client-request aio "127.0.0.1" test-port "/")
        (http2/client-request aio "127.0.0.1" test-port "/"))
    })))
    (= {batch4} (aio/then (aio/sleep aio 2500) (\ {_} {
      (list
        (http2/client-request aio "127.0.0.1" test-port "/")
        (http2/client-request aio "127.0.0.1" test-port "/"))
    })))
    
    (aio/then (aio/all-settled (list batch1 batch2 batch3 batch4)) (\ {batches} {
      (= {all-requests} (foldl (\ {acc b} {
        (if (plist/has? b :value) {(join acc (plist/get b :value))} {acc})
      }) {} batches))
      (aio/then (aio/all-settled all-requests) (\ {results} {
        (= {completed} (foldl (\ {c r} {
          (if (plist/has? r :value) {(+ c 1)} {c})
        }) 0 results))
        (>= completed 4)
      }))
    }))
  })))
  {:suite-name "Backpressure Timeout Coverage Test" :timeout-ms 10000 :suite-timeout-ms 15000})
