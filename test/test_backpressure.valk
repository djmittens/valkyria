; Backpressure Resume Test  
; Tests recovery from backpressure when buffers become available
;
; Strategy:
; - Use SEPARATE aio systems for server and client to avoid buffer competition
; - Server has small buffer pool to trigger backpressure
; - Client has large pool to ensure it doesn't run out  
; - This exercises the backpressure add/remove/resume paths

(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {server-aio} (aio/start {
  :max-connections 8
  :tcp-buffer-pool-size 48
  :backpressure-timeout-ms 60000
  :backpressure-list-max 10
}))

(def {client-aio} (aio/start {
  :max-connections 16
  :tcp-buffer-pool-size 128
}))

(def {handler}
  (\ {req} {
    (aio/then (aio/sleep server-aio 50) (\ {_} {{:status "200" :body "OK"}}))
  }))

(def {server} (http2/server-listen server-aio 0 handler))
(def {test-port} (http2/server-port server))

(test/run-async client-aio (list
  (test-async "backpressure recovery with 14 requests" (\ {} {
    (= {request-handles} (list
      (aio/then (aio/sleep client-aio 50) (\ {_} {
        (list 
          (http2/client-request client-aio "127.0.0.1" test-port "/")
          (http2/client-request client-aio "127.0.0.1" test-port "/")
          (http2/client-request client-aio "127.0.0.1" test-port "/")
          (http2/client-request client-aio "127.0.0.1" test-port "/"))
      }))
      (aio/then (aio/sleep client-aio 80) (\ {_} {
        (list
          (http2/client-request client-aio "127.0.0.1" test-port "/")
          (http2/client-request client-aio "127.0.0.1" test-port "/")
          (http2/client-request client-aio "127.0.0.1" test-port "/")
          (http2/client-request client-aio "127.0.0.1" test-port "/"))
      }))
      (aio/then (aio/sleep client-aio 300) (\ {_} {
        (list
          (http2/client-request client-aio "127.0.0.1" test-port "/")
          (http2/client-request client-aio "127.0.0.1" test-port "/")
          (http2/client-request client-aio "127.0.0.1" test-port "/")
          (http2/client-request client-aio "127.0.0.1" test-port "/"))
      }))
      (aio/then (aio/sleep client-aio 600) (\ {_} {
        (list
          (http2/client-request client-aio "127.0.0.1" test-port "/")
          (http2/client-request client-aio "127.0.0.1" test-port "/"))
      }))))
    
    (aio/then (aio/all-settled request-handles) (\ {batch-results} {
      (= {all-requests} (foldl (\ {acc batch} {
        (if (plist/has? batch :value)
          {(join acc (plist/get batch :value))}
          {acc})
      }) {} batch-results))
      
      (aio/then (aio/all-settled all-requests) (\ {results} {
        (= {completed} (foldl (\ {count r} {
          (if (and (plist/has? r :value) (not (error? (plist/get r :value))))
            {(+ count 1)}
            {count})
        }) 0 results))
        (aio/stop server-aio)
        (>= completed 10)
      }))
    }))
  })))
  {:suite-name "Backpressure Resume Test"})
