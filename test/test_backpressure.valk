; Backpressure Resume Test  
; Tests batched HTTP requests under load

(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {server-aio} (aio/await (aio/start {:max-connections 8 :tcp-buffer-pool-size 48})))
(def {client-aio} (aio/await (aio/start {:max-connections 16 :tcp-buffer-pool-size 128})))

(def {handler} (\ {req} {{:status "200" :body "OK"}}))

(def {server} (http2/server-listen server-aio 0 handler))
(def {test-port} (http2/server-port server))

(test/run-async client-aio (list
  (test-async "batched requests under load" (\ {} {
    (printf "[BP] Creating batches\n")
    (= {batch1} (aio/then (aio/sleep client-aio 50) (\ {_} {
      (printf "[BP] Batch 1\n")
      (list 
        (http2/client-request client-aio "127.0.0.1" test-port "/")
        (http2/client-request client-aio "127.0.0.1" test-port "/")
        (http2/client-request client-aio "127.0.0.1" test-port "/")
        (http2/client-request client-aio "127.0.0.1" test-port "/"))
    })))
    (= {batch2} (aio/then (aio/sleep client-aio 80) (\ {_} {
      (printf "[BP] Batch 2\n")
      (list
        (http2/client-request client-aio "127.0.0.1" test-port "/")
        (http2/client-request client-aio "127.0.0.1" test-port "/")
        (http2/client-request client-aio "127.0.0.1" test-port "/")
        (http2/client-request client-aio "127.0.0.1" test-port "/"))
    })))
    (= {batch3} (aio/then (aio/sleep client-aio 300) (\ {_} {
      (printf "[BP] Batch 3\n")
      (list 
        (http2/client-request client-aio "127.0.0.1" test-port "/")
        (http2/client-request client-aio "127.0.0.1" test-port "/")
        (http2/client-request client-aio "127.0.0.1" test-port "/")
        (http2/client-request client-aio "127.0.0.1" test-port "/"))
    })))
    (= {batch4} (aio/then (aio/sleep client-aio 600) (\ {_} {
      (printf "[BP] Batch 4\n")
      (list
        (http2/client-request client-aio "127.0.0.1" test-port "/")
        (http2/client-request client-aio "127.0.0.1" test-port "/"))
    })))
    
    (printf "[BP] Waiting for batches\n")
    (aio/then (aio/all-settled (list batch1 batch2 batch3 batch4)) (\ {batch-results} {
      (printf "[BP] Batches completed: %ld\n" (len batch-results))
      (= {all-requests} (foldl (\ {acc batch} {
        (if (plist/has? batch :value)
          {(join acc (plist/get batch :value))}
          {acc})
      }) {} batch-results))
      (printf "[BP] Got %ld requests\n" (len all-requests))
      
      (aio/then (aio/all-settled all-requests) (\ {results} {
        (= {num-results} (len results))
        (printf "[BP] All settled: %ld\n" num-results)
        (aio/stop server-aio)
        (>= num-results 10)
      }))
    }))
  })))
  {:suite-name "Backpressure Resume Test" :timeout-ms 5000})
