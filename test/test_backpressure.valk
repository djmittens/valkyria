; Backpressure Resume Test  
; Tests recovery from backpressure when buffers become available
;
; Strategy:
; - Use SEPARATE aio systems for server and client to avoid buffer competition
; - Server has small buffer pool to trigger backpressure
; - Client has large pool to ensure it doesn't run out  
; - This exercises the backpressure add/remove/resume paths

(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {server-aio} (aio/start {
  :max-connections 8
  :tcp-buffer-pool-size 48
  :backpressure-timeout-ms 60000
  :backpressure-list-max 10
}))

(def {client-aio} (aio/start {
  :max-connections 16
  :tcp-buffer-pool-size 128
}))

(def {handler}
  (\ {req} {
    (aio/then (aio/sleep server-aio 50) (\ {_} {{:status "200" :body "OK"}}))
  }))

(def {server} (http2/server-listen server-aio 0 handler))
(def {test-port} (http2/server-port server))

(def {requests-completed} 0)
(def {requests-started} 0)
(def {errors} 0)
(def {target} 14)
(def {test-done-callback} nil)

(fun {check-done} {
  (if (>= (+ requests-completed errors) target)
    {do
      (aio/stop server-aio)
      (test-done-callback (>= requests-completed 10))}
    {true})
})

(fun {send-request} {
  (def {requests-started} (+ requests-started 1))
  (http2/client-request client-aio "127.0.0.1" test-port "/" (\ {resp} {
    (if (error? resp)
      {(def {errors} (+ errors 1))}
      {(def {requests-completed} (+ requests-completed 1))})
    (check-done)
  }))
})

(test/run-async client-aio (list
  (test-async "backpressure recovery with 14 requests" (\ {done} {
  (def {test-done-callback} done)
  
  (aio/schedule client-aio 50 (\ {} {
    (send-request) (send-request)
    (send-request) (send-request)
  }))
  
  (aio/schedule client-aio 80 (\ {} {
    (send-request) (send-request)
    (send-request) (send-request)
  }))
  
  (aio/schedule client-aio 300 (\ {} {
    (send-request) (send-request)
    (send-request) (send-request)
  }))
  
  (aio/schedule client-aio 600 (\ {} {
    (send-request) (send-request)
  }))
})))
  {:suite-name "Backpressure Resume Test"})
