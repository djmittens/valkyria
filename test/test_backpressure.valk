; Backpressure Stress Test
; Creates many concurrent connections to exhaust buffer pool and trigger backpressure
; This exercises: __backpressure_list_add, __backpressure_list_remove, 
;                 __backpressure_try_resume_one (event-driven resume)

(load "src/prelude.valk")

(def {TEST_PORT} 8491)

; STRESS: Use constrained buffer pool to trigger backpressure
; tcp-buffer-pool-size=8 triggers backpressure while being CI-reliable
; (4 was too aggressive - caused >50% request failures sometimes)
(def {aio} (aio/start {
  :max-connections 8
  :tcp-buffer-pool-size 8
}))

(def {requests-completed} 0)
(def {requests-started} 0)
(def {errors} 0)

; Handler that takes some time - this holds connections open longer
; which helps trigger backpressure recovery paths
(def {handler}
  (\ {req} {
    (aio/then (aio/sleep 50) (\ {_} {{:status "200" :body "OK"}}))
  }))

(println "")
(println "=== Backpressure Stress Test ===")
(println "")
(printf "Config: tcp-buffer-pool-size=8, max-connections=8\n")
(printf "Starting server on port %d\n" TEST_PORT)
(http2/server-listen aio TEST_PORT handler)

; Helper to send a single request using http2/client-request
(fun {send-request} {
  (def {requests-started} (+ requests-started 1))
  (http2/client-request aio "127.0.0.1" TEST_PORT "/" (\ {resp} {
    (if (error? resp)
      {(def {errors} (+ errors 1))}
      {(def {requests-completed} (+ requests-completed 1))})
  }))
})

; Phase 1: 6 requests
(aio/schedule aio 50 (\ {} {
  (println "Phase 1: Starting 6 requests...")
  (send-request)
  (send-request)
  (send-request)
  (send-request)
  (send-request)
  (send-request)
}))

; Phase 2: 9 more requests while phase 1 still processing
; This should exhaust buffers and trigger backpressure
(aio/schedule aio 100 (\ {} {
  (println "Phase 2: Starting 9 more requests (should trigger backpressure)...")
  (send-request)
  (send-request)
  (send-request)
  (send-request)
  (send-request)
  (send-request)
  (send-request)
  (send-request)
  (send-request)
}))

; Phase 3: More requests as buffers start freeing
(aio/schedule aio 200 (\ {} {
  (println "Phase 3: Starting 4 more requests...")
  (send-request)
  (send-request)
  (send-request)
  (send-request)
}))

; Phase 4: Final burst
(aio/schedule aio 400 (\ {} {
  (println "Phase 4: Starting 4 more requests...")
  (send-request)
  (send-request)
  (send-request)
  (send-request)
}))

; Wait for all requests to complete (handler has 50ms sleep)
(aio/schedule aio 3000 (\ {} {
  (println "")
  (printf "=== Results ===\n")
  (printf "Requests started: %d\n" requests-started)
  (printf "Requests completed: %d\n" requests-completed)
  (printf "Errors: %d\n" errors)
  (println "")
  
  ; Success if we completed most requests
  ; Some may fail due to backpressure, which is fine
  (if (> requests-completed (/ requests-started 2))
    {(do
      (println "PASS: Backpressure test completed successfully")
      (exit 0))}
    {(do
      (printf "FAIL: Only %d of %d requests completed\n" requests-completed requests-started)
      (exit 1))})
}))

; Timeout - just exit, don't stop aio (avoids cleanup race)
(aio/schedule aio 10000 (\ {} {
  (println "TIMEOUT!")
  (exit 1)
}))

(aio/run aio)
