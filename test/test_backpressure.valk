; Backpressure Stress Test
; Creates many concurrent connections to exhaust buffer pool and trigger backpressure
; This exercises: __backpressure_list_add, __backpressure_list_remove, 
;                 __backpressure_try_resume_one (event-driven resume)

(load "src/prelude.valk")

(def {TEST_PORT} 8491)

; STRESS: Use small buffer pool (4) to stress-test failure handling  
; The server MUST survive this - shed load, apply backpressure, recover when pressure eases
(def {aio} (aio/start {
  :max-connections 8
  :tcp-buffer-pool-size 4
}))

(def {requests-completed} 0)
(def {requests-started} 0)
(def {errors} 0)

; Handler that takes some time - this holds connections open longer
; which helps trigger backpressure recovery paths
(def {handler}
  (\ {req} {
    (aio/then (aio/sleep 50) (\ {_} {{:status "200" :body "OK"}}))
  }))

(println "")
(println "=== Backpressure Stress Test ===")
(println "")
(printf "Config: tcp-buffer-pool-size=4, max-connections=8\n")
(printf "Starting server on port %d\n" TEST_PORT)
(http2/server-listen aio TEST_PORT handler)

; Function to make a burst of requests
(fun {make-requests n} {
  (if (<= n 0)
    {nil}
    {(do
      (def {requests-started} (+ requests-started 1))
      (http2/client-request aio "127.0.0.1" TEST_PORT "/" (\ {resp} {
        (if (error? resp)
          {(def {errors} (+ errors 1))}
          {(def {requests-completed} (+ requests-completed 1))})
      }))
      (make-requests (- n 1)))})
})

; First: Start 6 requests to use up some buffers
(aio/schedule aio 50 (\ {} {
  (println "Phase 1: Starting 6 initial requests...")
  (make-requests 6)
}))

; While those are in-flight (handler sleeps 50ms), start more to exhaust buffers
; This should cause backpressure on the new connections
(aio/schedule aio 100 (\ {} {
  (println "Phase 2: Starting 8 more requests (should trigger backpressure)...")
  (make-requests 8)
}))

; First batch completes around 100-150ms, freeing buffers
; The backpressured connections should then resume
; Add more requests to keep pressure up
(aio/schedule aio 200 (\ {} {
  (println "Phase 3: Starting 4 more requests...")
  (make-requests 4)
}))

(aio/schedule aio 400 (\ {} {
  (println "Phase 4: Starting 4 more requests...")
  (make-requests 4)
}))

; Wait longer for backpressure recovery to happen
(aio/schedule aio 5000 (\ {} {
  (println "")
  (printf "=== Results ===\n")
  (printf "Requests started: %d\n" requests-started)
  (printf "Requests completed: %d\n" requests-completed)
  (printf "Errors: %d\n" errors)
  (println "")
  
  ; Success if we completed some requests - the point is to exercise backpressure
  ; Even 1 completed request means the system handled the load
  (if (> requests-completed 0)
    {(do
      (println "PASS: Backpressure test completed successfully")
      (exit 0))}
    {(do
      (println "FAIL: No requests completed")
      (exit 1))})
}))

; Timeout - just exit, don't stop aio (avoids cleanup race)
(aio/schedule aio 15000 (\ {} {
  (println "TIMEOUT!")
  (exit 1)
}))

(aio/run aio)
