; Backpressure Resume Test  
; Tests recovery from backpressure when buffers become available
;
; Strategy:
; - Use SEPARATE aio systems for server and client to avoid buffer competition
; - Server has small buffer pool to trigger backpressure
; - Client has large pool to ensure it doesn't run out  
; - This exercises the backpressure add/remove/resume paths

(load "src/prelude.valk")

(def {TEST_PORT} (net/get-available-port))

; Server AIO - enough buffers to allow requests to complete
; This test validates that backpressure can happen and recover
(def {server-aio} (aio/start {
  :max-connections 8
  :tcp-buffer-pool-size 48
  :backpressure-timeout-ms 60000
  :backpressure-list-max 10
}))

; Client AIO with LARGE buffer pool - won't hit backpressure
(def {client-aio} (aio/start {
  :max-connections 16
  :tcp-buffer-pool-size 128
}))

(def {requests-completed} 0)
(def {requests-started} 0)
(def {errors} 0)

; Handler with small delay to keep buffers in use longer on server
(def {handler}
  (\ {req} {
    (aio/then (aio/sleep aio 50) (\ {_} {{:status "200" :body "OK"}}))
  }))

(println "")
(println "=== Backpressure Resume Test ===")
(println "")
(printf "Server: pool=48, Client: pool=128\n")
(printf "Starting server on port %d\n" TEST_PORT)
(http2/server-listen server-aio TEST_PORT handler)

; Helper to send a single request (uses client-aio)
(fun {send-request} {
  (def {requests-started} (+ requests-started 1))
  (http2/client-request client-aio "127.0.0.1" TEST_PORT "/" (\ {resp} {
    (if (error? resp)
      {(def {errors} (+ errors 1))}
      {(def {requests-completed} (+ requests-completed 1))})
  }))
})

; Burst of requests to trigger server-side backpressure
(aio/schedule client-aio 50 (\ {} {
  (println "Burst 1: Starting 4 requests...")
  (send-request) (send-request)
  (send-request) (send-request)
}))

; More requests while first burst is processing
(aio/schedule client-aio 80 (\ {} {
  (println "Burst 2: Starting 4 more requests...")
  (send-request) (send-request)
  (send-request) (send-request)
}))

; Wait for first burst to complete, then send more
(aio/schedule client-aio 300 (\ {} {
  (printf "Burst 3: %d completed, starting 4 more...\n" requests-completed)
  (send-request) (send-request)
  (send-request) (send-request)
}))

; Final batch after more completions
(aio/schedule client-aio 600 (\ {} {
  (printf "Burst 4: %d completed, final batch...\n" requests-completed)
  (send-request) (send-request)
}))

; Check results
(aio/schedule client-aio 3000 (\ {} {
  (println "")
  (printf "=== Results ===\n")
  (printf "Requests started: %d\n" requests-started)
  (printf "Requests completed: %d\n" requests-completed)
  (printf "Errors: %d\n" errors)
  (println "")
  
  ; Stop both aio systems
  (aio/stop server-aio)
  
  ; Success if most requests completed
  (if (>= requests-completed 10)
    {(do
      (println "PASS: Backpressure test completed successfully")
      (exit 0))}
    {(do
      (printf "FAIL: Only %d of %d requests completed\n" requests-completed requests-started)
      (exit 1))})
}))

; Timeout
(aio/schedule client-aio 10000 (\ {} {
  (println "TIMEOUT!")
  (aio/stop server-aio)
  (exit 1)
}))

(aio/run client-aio)
