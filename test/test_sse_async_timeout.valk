; SSE Async Timeout Tests
; Tests SSE stream lifecycle with async close via scheduled timer
; Note: Due to Lisp scoping, verifies via successful completion

(load "src/prelude.valk")
(load "src/modules/test.valk")
(load "src/modules/aio/sse.valk")

(def {aio} (aio/await (aio/start)))

(def {handler}
  (\ {req} {
    (= {path} (req/path req))
    (if (== path "/sse-test")
      {(do
        (= {stream} (sse/open req))
        (sse/send stream "test message")
        ; Close after delay via timer
        (aio/schedule aio 100 (\ {} {
          (sse/close stream)
        }))
        :deferred
      )}
      {`{:status "200" :body "OK"}}
    )
  }))

(def {server} (http2/server-listen aio 0 handler))
(def {TEST_PORT} (http2/server-port server))

(test/run-async aio (list
  (test-async "SSE stream created and closed via async timer" (\ {} {
  (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/sse-test") (\ {resp} {}))
  (aio/then (aio/sleep aio 300) (\ {_} {true}))
})))
  {:suite-name "SSE Async Timeout Tests"})
