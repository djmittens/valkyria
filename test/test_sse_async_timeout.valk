; SSE Async Timeout Tests
; Tests SSE stream lifecycle with async close via scheduled timer
; Note: Due to Lisp scoping, verifies via successful completion

(load "src/prelude.valk")
(load "src/modules/test.valk")
(load "src/modules/aio/sse.valk")

(def {aio} (aio/start))

(def {handler}
  (\ {req} {
    (= {path} (req/path req))
    (if (== path "/sse-test")
      {(do
        (= {stream} (sse/open req))
        (sse/send stream "test message")
        ; Close after delay via timer
        (aio/schedule aio 100 (\ {} {
          (sse/close stream)
        }))
        :deferred
      )}
      {`{:status "200" :body "OK"}}
    )
  }))

(def {server} (http2/server-listen aio 0 handler))
(def {TEST_PORT} (http2/server-port server))

; Test: SSE stream is created and closed via async timer
; Verifies by receiving response (close triggers response completion)

(test/run-async aio (list
  (test-async "SSE stream created and closed via async timer" (\ {done} {
  ; Fire request - if async close works, we'll get a response
  (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/sse-test") (\ {resp} {}))
  ; Wait for timer + response processing
  (aio/schedule aio 300 (\ {} {
    ; If we got here without crash, async close worked
    (done true)
  }))
})))
  {:suite-name "SSE Async Timeout Tests"})
