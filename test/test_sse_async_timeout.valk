; SSE Async Timeout Tests
; Tests SSE stream lifecycle with async close via scheduled timer

(load "src/prelude.valk")
(load "src/modules/test.valk")
(load "src/modules/aio/sse.valk")

(test/suite "SSE Async Timeout Tests")

(def {aio} (aio/start))

(def {sse-stream-created} 0)
(def {sse-stream-closed} 0)

(def {handler}
  (\ {req} {
    (= {path} (req/path req))
    (if (== path "/sse-test")
      {(do
        (= {stream} (sse/open req))
        (def {sse-stream-created} 1)
        (sse/send stream "test message")
        (aio/schedule aio 100 (\ {} {
          (sse/close stream)
          (def {sse-stream-closed} 1)
        }))
        :deferred
      )}
      {`{:status "200" :body "OK"}}
    )
  }))

(def {server} (http2/server-listen aio 0 handler))
(def {TEST_PORT} (http2/server-port server))

; Test: SSE stream is created and closed via async timer
(test/async "SSE stream created and closed via async timer" (\ {done} {
  (http2/client-request aio "127.0.0.1" TEST_PORT "/sse-test" (\ {resp} {
    (aio/schedule aio 150 (\ {} {
      (done (and (== sse-stream-created 1) (== sse-stream-closed 1)))
    }))
  }))
}))

(test/run-async aio)
(aio/run aio)
