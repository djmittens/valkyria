; Tests for http2/client-request error paths and custom headers edge cases

(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {aio} (aio/await (aio/start)))

(def {header-echo-handler}
  (\ {req} {
    (= {headers} (req/headers req))
    {:status "200" :body (str headers)}
  }))

(def {server} (http2/server-listen aio 0 header-echo-handler))
(def {TEST_PORT} (http2/server-port server))

(test/run-async aio (list
  (test-async "connection failure to non-listening port" (\ {} {
  (aio/then (http2/client-request aio "127.0.0.1" 59999 "/test")
    (\ {resp} {(error? resp)}))
}))
  (test-async "connection failure with custom headers" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" 59998 "/test"
    {{"x-custom" "value"} {"x-another" "test"}})
    (\ {resp} {(error? resp)}))
}))
  (test-async "headers with extra elements in pair" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"x-header" "value" "extra" "ignored"}})
    (\ {resp} {(if (error? resp) {false} {(== (http2/response-status resp) "200")})}))
}))
  (test-async "request with single header" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"x-single-header" "single-value"}})
    (\ {resp} {(if (error? resp) {false} {(== (http2/response-status resp) "200")})}))
}))
  (test-async "request with multiple headers" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"x-header-1" "value1"} {"x-header-2" "value2"} {"x-header-3" "value3"}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "headers with special characters" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"x-special" "value with spaces"} {"x-nums" "12345"}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "headers with empty value" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"x-empty-value" ""}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "malformed header single element skipped" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"only-name"}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "mixed valid and malformed headers" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"x-valid" "value"} {"only-name"} {"x-also-valid" "val2"}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "non-string header name skipped" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{123 "value"} {"x-valid" "val"}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "non-string header value skipped" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"x-header" 456} {"x-valid" "val"}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "nil headers works like no headers" (\ {} {
  (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/test")
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "long header value" (\ {} {
  (= {long-value} "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-=_+[]{}|;:',.<>/?!@#$%^&*()abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ")
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"x-long-header" long-value}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "standard HTTP headers" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/api/test"
    {{"content-type" "application/json"} {"accept" "application/json"} {"user-agent" "TestClient/1.0"}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "concurrent connection error 1" (\ {} {
  (aio/then (http2/client-request aio "127.0.0.1" 59997 "/a")
    (\ {resp} {(error? resp)}))
}))
  (test-async "concurrent connection error 2" (\ {} {
  (aio/then (http2/client-request aio "127.0.0.1" 59996 "/b")
    (\ {resp} {(error? resp)}))
}))
  (test-async "error callback inspects error details" (\ {} {
  (aio/then (http2/client-request aio "127.0.0.1" 59995 "/test")
    (\ {resp} {(if (error? resp) {(> (len (str resp)) 0)} {false})}))
})))
  {:suite-name "HTTP2 Client Request Error Paths"})
