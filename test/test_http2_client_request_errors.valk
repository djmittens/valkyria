; Tests for http2/client-request error paths and custom headers edge cases
; Split into smaller batches to avoid concurrency race conditions

(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {aio} (aio/await (aio/start)))

(def {header-echo-handler}
  (\ {req} {
    (= {headers} (req/headers req))
    {:status "200" :body (str headers)}
  }))

(def {server} (http2/server-listen aio 0 header-echo-handler))
(def {TEST_PORT} (http2/server-port server))

(test/run-async aio (list
  (test-async "connection failure to non-listening port" (\ {} {
  (aio/catch (http2/client-request aio "127.0.0.1" 59999 "/test")
    (\ {err} {true}))
}))
  (test-async "connection failure with custom headers" (\ {} {
  (aio/catch (http2/client-request-with-headers aio "127.0.0.1" 59998 "/test"
    {{"x-custom" "value"} {"x-another" "test"}})
    (\ {err} {true}))
}))
  (test-async "headers with extra elements in pair" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"x-header" "value" "extra" "ignored"}})
    (\ {resp} {(if (error? resp) {false} {(== (http2/response-status resp) "200")})}))
}))
  (test-async "request with single header" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"x-single-header" "single-value"}})
    (\ {resp} {(if (error? resp) {false} {(== (http2/response-status resp) "200")})}))
}))
  (test-async "request with multiple headers" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"x-header-1" "value1"} {"x-header-2" "value2"} {"x-header-3" "value3"}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "headers with special characters" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"x-special" "value with spaces"} {"x-nums" "12345"}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "headers with empty value" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"x-empty-value" ""}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "concurrent connection error 1" (\ {} {
  (aio/catch (http2/client-request aio "127.0.0.1" 59997 "/a")
    (\ {err} {true}))
}))
  (test-async "error callback inspects error details" (\ {} {
  (aio/catch (http2/client-request aio "127.0.0.1" 59995 "/test")
    (\ {err} {(> (len (str err)) 0)}))
})))
  {:suite-name "HTTP2 Client Request Error Paths"})
