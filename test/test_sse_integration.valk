; SSE Integration Tests
; Tests SSE functionality with real HTTP/2 server
; Exercises: sse/open, sse/send (2-arg and 3-arg), sse/close, sse/writable?
;            sse/message, sse/event wrappers, multiple sends, send with event-id

(load "src/prelude.valk")
(load "src/modules/test.valk")
(load "src/modules/aio/sse.valk")

(test/suite "SSE Integration Tests")

(def {aio} (aio/start))

(def {test-stream} nil)
(def {test-send-result} nil)
(def {test-send-typed-result} nil)
(def {test-writable-result} nil)
(def {test-close-result} nil)
(def {test-send-after-close} nil)
(def {test-multi-send} 0)
(def {test-event-result} nil)
(def {test-message-result} nil)

(def {test-handler}
  (\ {req} {
    (= {path} (req/path req))
    
    (if (== path "/test-open")
      {(do
        (= {stream} (sse/open req))
        (def {test-stream} stream)
        (def {test-writable-result} (sse/writable? stream))
        (def {test-send-result} (sse/send stream "hello"))
        (def {test-send-typed-result} (sse/send stream "custom-event" "typed data"))
        (sse/close stream)
        (def {test-close-result} true)
        (def {test-send-after-close} (sse/send stream "after close"))
        `{:status "200" :body "done"}
      )}
      
      {(if (== path "/test-multi-send")
        {(do
          (= {stream} (sse/open req))
          (sse/send stream "event 1")
          (def {test-multi-send} (+ test-multi-send 1))
          (sse/send stream "event 2")
          (def {test-multi-send} (+ test-multi-send 1))
          (sse/send stream "event 3")
          (def {test-multi-send} (+ test-multi-send 1))
          (sse/send stream "typed" "event 4")
          (def {test-multi-send} (+ test-multi-send 1))
          (def {test-message-result} (sse/message stream "message 5"))
          (def {test-multi-send} (+ test-multi-send 1))
          (def {test-event-result} (sse/event stream "custom" "event 6"))
          (def {test-multi-send} (+ test-multi-send 1))
          (sse/close stream)
          `{:status "200" :body "multi done"}
        )}
        
        {`{:status "200" :body "OK"}}
      )}
    )
  }))

(def {server} (http2/server-listen aio 0 test-handler))
(def {TEST_PORT} (http2/server-port server))

; Test: sse/open creates a stream
(test/async "sse/open creates stream" (\ {done} {
  (http2/client-request aio "127.0.0.1" TEST_PORT "/test-open" (\ {resp} {
    (aio/schedule aio 50 (\ {} {
      (done (!= test-stream nil))
    }))
  }))
}))

; Test: sse/writable? returns truthy for new stream
(test/async "sse/writable? returns truthy for new stream" (\ {done} {
  (aio/schedule aio 200 (\ {} {
    (done test-writable-result)
  }))
}))

; Test: sse/send (2-arg) returns positive length
(test/async "sse/send (2-arg) returns positive length" (\ {done} {
  (aio/schedule aio 250 (\ {} {
    (done (and (not (error? test-send-result)) (> test-send-result 0)))
  }))
}))

; Test: sse/send (3-arg with event-type) returns positive length
(test/async "sse/send (3-arg with event-type) returns positive length" (\ {done} {
  (aio/schedule aio 300 (\ {} {
    (done (and (not (error? test-send-typed-result)) (> test-send-typed-result 0)))
  }))
}))

; Test: sse/close completes
(test/async "sse/close completes" (\ {done} {
  (aio/schedule aio 350 (\ {} {
    (done test-close-result)
  }))
}))

; Test: sse/send after close fails
(test/async "sse/send after close fails" (\ {done} {
  (aio/schedule aio 400 (\ {} {
    (= {send-failed} (or (error? test-send-after-close) (== test-send-after-close nil)))
    (done send-failed)
  }))
}))

; Test: Multiple sse/send calls work (6 events)
(test/async "Multiple sse/send calls work (6 events)" (\ {done} {
  (http2/client-request aio "127.0.0.1" TEST_PORT "/test-multi-send" (\ {resp} {
    (aio/schedule aio 50 (\ {} {
      (done (== test-multi-send 6))
    }))
  }))
}))

; Test: sse/message wrapper returns positive length
(test/async "sse/message wrapper returns positive length" (\ {done} {
  (aio/schedule aio 600 (\ {} {
    (done (and (not (error? test-message-result)) (> test-message-result 0)))
  }))
}))

; Test: sse/event wrapper returns positive length
(test/async "sse/event wrapper returns positive length" (\ {done} {
  (aio/schedule aio 650 (\ {} {
    (done (and (not (error? test-event-result)) (> test-event-result 0)))
  }))
}))

(test/run-async aio)
(aio/run aio)
