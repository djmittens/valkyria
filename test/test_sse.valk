; SSE Module Tests
; Run with: ./build/valk test/test_sse.valk

; Load prelude first (provides fun, def, etc.)
(load "src/prelude.valk")

; Load test framework
(load "src/modules/test.valk")

; Load SSE module
(load "src/modules/aio/sse.valk")

; Set the test suite name

; ============================================================================
; Module Loading and Function Existence Tests
; ============================================================================

; Test: sse/message wrapper exists and is callable

; Test: sse/event wrapper exists and is callable

; Test: sse/json wrapper exists and is callable

; Test: sse/json-event wrapper exists and is callable

; Test: sse/handler wrapper exists and is callable

; ============================================================================
; Alias Tests
; ============================================================================

; Test: sse/create is an alias for sse/open

; ============================================================================
; Handler Wrapper Tests
; ============================================================================

; ============================================================================
; Integration Notes
; ============================================================================

; NOTE: The following SSE functions require an HTTP handler context to test:
;   - sse/open (sse/create) - Must be called within HTTP/2 handler
;   - sse/send - Requires active SSE stream
;   - sse/close - Requires active SSE stream
;   - sse/writable? - Requires active SSE stream
;   - sse/on-drain - Requires active SSE stream
;   - sse/on-close - Requires active SSE stream
;
; These functions are tested through:
;   1. Manual integration testing with live HTTP/2 server
;   2. The networking test suite which creates actual HTTP contexts
;   3. End-to-end tests in test/test_http_*.valk files
;
; This test suite focuses on:
;   - Module loading and function existence
;   - Wrapper function creation (sse/handler)
;   - Alias correctness (sse/create)
;   - Type checks (fun? predicate)

; Run all tests
(test/run (list
  (test "sse/message-exists"
    {do
    (test/assert (!= sse/message nil) "sse/message should be defined")
    (test/assert (not (error? sse/message)) "sse/message should not be an error")
    true
  })
  (test "sse/event-exists"
    {do
    (test/assert (!= sse/event nil) "sse/event should be defined")
    (test/assert (not (error? sse/event)) "sse/event should not be an error")
    true
  })
  (test "sse/json-exists"
    {do
    (test/assert (!= sse/json nil) "sse/json should be defined")
    (test/assert (not (error? sse/json)) "sse/json should not be an error")
    true
  })
  (test "sse/json-event-exists"
    {do
    (test/assert (!= sse/json-event nil) "sse/json-event should be defined")
    (test/assert (not (error? sse/json-event)) "sse/json-event should not be an error")
    true
  })
  (test "sse/handler-exists"
    {do
    (test/assert (!= sse/handler nil) "sse/handler should be defined")
    (test/assert (not (error? sse/handler)) "sse/handler should not be an error")
    true
  })
  (test "sse/create-alias"
    {do
    (test/assert (== sse/create sse/open) "sse/create should equal sse/open")
    true
  })
  (test "sse/handler-returns-function"
    {do
    (= {handler} (sse/handler (\ {stream req} {true})))
    (test/assert (!= handler {}) "sse/handler should return a function")
    true
  }))
  {:suite-name "SSE Module Tests (Limited)"})
