; Tests for http2/client-request header edge cases (part 2)

(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {aio} (aio/await (aio/start)))

(def {header-echo-handler}
  (\ {req} {
    (= {headers} (req/headers req))
    {:status "200" :body (str headers)}
  }))

(def {server} (http2/server-listen aio 0 header-echo-handler))
(def {TEST_PORT} (http2/server-port server))

(test/run-async aio (list
  (test-async "malformed header single element skipped" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"only-name"}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "mixed valid and malformed headers" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"x-valid" "value"} {"only-name"} {"x-also-valid" "val2"}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "non-string header name skipped" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{123 "value"} {"x-valid" "val"}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "non-string header value skipped" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"x-header" 456} {"x-valid" "val"}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "nil headers works like no headers" (\ {} {
  (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/test")
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "long header value" (\ {} {
  (= {long-value} "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-=_+[]{}|;:',.<>/?!@#$%^&*()abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ")
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test"
    {{"x-long-header" long-value}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "standard HTTP headers" (\ {} {
  (aio/then (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/api/test"
    {{"content-type" "application/json"} {"accept" "application/json"} {"user-agent" "TestClient/1.0"}})
    (\ {resp} {(not (error? resp))}))
}))
  (test-async "concurrent connection error 2" (\ {} {
  (aio/catch (http2/client-request aio "127.0.0.1" 59996 "/b")
    (\ {err} {true}))
})))
  {:suite-name "HTTP2 Client Header Edge Cases"})
