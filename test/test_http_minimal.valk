; HTTP API Minimal Tests
; Using proper test framework

(load "src/prelude.valk")
(load "src/modules/test.valk")
(load "src/http_api.valk")
(test/suite "HTTP API Tests")

; ============================================================================
; Request Creation Tests
; ============================================================================

(test/define "http/get creates request"
  {do
    (def {req} (http/get "example.com"))
    (!= req ())
  })

(test/define "http/post creates request"
  {do
    (def {req} (http/post "api.example.com" "body"))
    (!= req ())
  })

(test/define "http/request custom method"
  {do
    (def {req} (http/request "PUT" "api.example.com"))
    (!= req ())
  })

(test/define "http/with-header returns request"
  {do
    (def {req} (http/get "example.com"))
    (def {req2} (http/with-header req "x-test" "value"))
    (!= req2 ())
  })

; ============================================================================
; Async Operations Tests
; ============================================================================

(test/define "http/fetch creates async op"
  {do
    (def {op} (http/fetch "example.com"))
    (!= op ())
  })

(test/define "async/pure creates op"
  {do
    (def {op} (async/pure 42))
    (!= op ())
  })

; ============================================================================
; Middleware Tests
; ============================================================================

(test/define "http/with-auth creates middleware"
  {do
    (def {mw} (http/with-auth "Bearer token"))
    (!= mw ())
  })

(test/define "http/compose-middleware combines"
  {do
    (def {mw} (http/compose-middleware (list
      (http/with-auth "token")
      (http/with-user-agent "Agent"))))
    (!= mw ())
  })

; ============================================================================
; Pattern Tests
; ============================================================================

(test/define "http/parallel creates operation"
  {do
    (def {ops} (list (async/pure 10) (async/pure 20)))
    (def {par} (http/parallel ops))
    (!= par ())
  })

; ============================================================================
; Route Matching Tests
; ============================================================================

(test/define "http/route-matches? exact"
  {(== 1 (http/route-matches? "/api/users" "/api/users"))})

(test/define "http/route-matches? no match"
  {(== 0 (http/route-matches? "/api/users" "/api/posts"))})

; Run all tests
(test/run {})
