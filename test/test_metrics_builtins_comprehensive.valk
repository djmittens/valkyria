(load "src/prelude.valk")
(load "src/modules/test.valk")

(test/suite "Metrics Builtins Comprehensive")

(test/define "counter-create-basic"
  {do
    (= {c} (metrics/counter "test_basic_counter"))
    (test/assert (! (error? c)) "counter creation should succeed")
    true
  })

(test/define "counter-create-with-labels"
  {do
    (= {c} (metrics/counter "test_labeled_counter" "method" "GET" "path" "/api"))
    (test/assert (! (error? c)) "labeled counter creation should succeed")
    true
  })

(test/define "counter-inc-by-1"
  {do
    (= {c} (metrics/counter "test_inc_counter"))
    (= {result} (metrics/counter-inc c))
    (test/assert (! (error? result)) "counter-inc should succeed")
    true
  })

(test/define "counter-inc-by-n"
  {do
    (= {c} (metrics/counter "test_inc_n_counter"))
    (= {result} (metrics/counter-inc c 10))
    (test/assert (! (error? result)) "counter-inc by n should succeed")
    true
  })

(test/define "counter-inc-wrong-type"
  {do
    (= {result} (metrics/counter-inc "not-a-counter"))
    (test/assert (error? result) "counter-inc with string should fail")
    true
  })

(test/define "counter-inc-wrong-n-type"
  {do
    (= {c} (metrics/counter "test_wrong_n_counter"))
    (= {result} (metrics/counter-inc c "ten"))
    (test/assert (error? result) "counter-inc with string n should fail")
    true
  })

(test/define "gauge-create-basic"
  {do
    (= {g} (metrics/gauge "test_basic_gauge"))
    (test/assert (! (error? g)) "gauge creation should succeed")
    true
  })

(test/define "gauge-create-with-labels"
  {do
    (= {g} (metrics/gauge "test_labeled_gauge" "region" "us-west"))
    (test/assert (! (error? g)) "labeled gauge creation should succeed")
    true
  })

(test/define "gauge-set"
  {do
    (= {g} (metrics/gauge "test_set_gauge"))
    (= {result} (metrics/gauge-set g 42))
    (test/assert (! (error? result)) "gauge-set should succeed")
    true
  })

(test/define "gauge-set-negative"
  {do
    (= {g} (metrics/gauge "test_negative_gauge"))
    (= {result} (metrics/gauge-set g -100))
    (test/assert (! (error? result)) "gauge-set with negative should succeed")
    true
  })

(test/define "gauge-set-wrong-type"
  {do
    (= {result} (metrics/gauge-set "not-a-gauge" 42))
    (test/assert (error? result) "gauge-set with string should fail")
    true
  })

(test/define "gauge-set-wrong-value-type"
  {do
    (= {g} (metrics/gauge "test_wrong_value_gauge"))
    (= {result} (metrics/gauge-set g "forty-two"))
    (test/assert (error? result) "gauge-set with string value should fail")
    true
  })

(test/define "gauge-inc"
  {do
    (= {g} (metrics/gauge "test_inc_gauge"))
    (metrics/gauge-set g 0)
    (= {result} (metrics/gauge-inc g))
    (test/assert (! (error? result)) "gauge-inc should succeed")
    true
  })

(test/define "gauge-inc-wrong-type"
  {do
    (= {result} (metrics/gauge-inc "not-a-gauge"))
    (test/assert (error? result) "gauge-inc with string should fail")
    true
  })

(test/define "gauge-dec"
  {do
    (= {g} (metrics/gauge "test_dec_gauge"))
    (metrics/gauge-set g 10)
    (= {result} (metrics/gauge-dec g))
    (test/assert (! (error? result)) "gauge-dec should succeed")
    true
  })

(test/define "gauge-dec-wrong-type"
  {do
    (= {result} (metrics/gauge-dec "not-a-gauge"))
    (test/assert (error? result) "gauge-dec with string should fail")
    true
  })

(test/define "histogram-create-default-buckets"
  {do
    (= {h} (metrics/histogram "test_default_histogram"))
    (test/assert (! (error? h)) "histogram creation should succeed")
    true
  })

(test/define "histogram-create-with-labels"
  {do
    (= {h} (metrics/histogram "test_labeled_histogram" "endpoint" "/api/v1"))
    (test/assert (! (error? h)) "labeled histogram creation should succeed")
    true
  })

(test/define "histogram-observe"
  {do
    (= {h} (metrics/histogram "test_observe_histogram"))
    (= {result} (metrics/histogram-observe h 1000))
    (test/assert (! (error? result)) "histogram-observe should succeed")
    true
  })

(test/define "histogram-observe-multiple"
  {do
    (= {h} (metrics/histogram "test_multi_observe_histogram"))
    (metrics/histogram-observe h 100)
    (metrics/histogram-observe h 500)
    (metrics/histogram-observe h 1000)
    (metrics/histogram-observe h 5000)
    (metrics/histogram-observe h 10000)
    (test/assert true "multiple observations should succeed")
    true
  })

(test/define "histogram-observe-wrong-type"
  {do
    (= {result} (metrics/histogram-observe "not-a-histogram" 1000))
    (test/assert (error? result) "histogram-observe with string should fail")
    true
  })

(test/define "histogram-observe-wrong-value-type"
  {do
    (= {h} (metrics/histogram "test_wrong_obs_histogram"))
    (= {result} (metrics/histogram-observe h "thousand"))
    (test/assert (error? result) "histogram-observe with string value should fail")
    true
  })

(test/define "metrics-json-returns-string"
  {do
    (= {json} (metrics/json))
    (test/assert (! (error? json)) "metrics/json should not error")
    (test/assert (str? json) "metrics/json should return string")
    true
  })

(test/define "metrics-prometheus-returns-string"
  {do
    (= {prom} (metrics/prometheus))
    (test/assert (! (error? prom)) "metrics/prometheus should not error")
    (test/assert (str? prom) "metrics/prometheus should return string")
    true
  })

(test/define "metrics-collect-delta"
  {do
    (= {delta} (metrics/collect-delta))
    (test/assert (! (error? delta)) "metrics/collect-delta should not error")
    true
  })

(test/define "metrics-delta-json"
  {do
    (= {delta} (metrics/collect-delta))
    (= {json} (metrics/delta-json delta))
    (test/assert (! (error? json)) "metrics/delta-json should not error")
    (test/assert (str? json) "metrics/delta-json should return string")
    true
  })

(test/define "counter-name-must-be-string"
  {do
    (= {result} (metrics/counter 123))
    (test/assert (error? result) "counter with numeric name should fail")
    true
  })

(test/define "gauge-name-must-be-string"
  {do
    (= {result} (metrics/gauge 123))
    (test/assert (error? result) "gauge with numeric name should fail")
    true
  })

(test/define "histogram-name-must-be-string"
  {do
    (= {result} (metrics/histogram 123))
    (test/assert (error? result) "histogram with numeric name should fail")
    true
  })

(test/define "counter-labels-must-be-strings"
  {do
    (= {result} (metrics/counter "test" 123 "value"))
    (test/assert (error? result) "counter with numeric label key should fail")
    true
  })

(test/define "gauge-labels-must-be-strings"
  {do
    (= {result} (metrics/gauge "test" 123 "value"))
    (test/assert (error? result) "gauge with numeric label key should fail")
    true
  })

(test/define "histogram-labels-must-be-strings"
  {do
    (= {result} (metrics/histogram "test" 123 "value"))
    (test/assert (error? result) "histogram with numeric label key should fail")
    true
  })

(test/define "counter-inc-no-args-fails"
  {do
    (= {result} (metrics/counter-inc))
    (test/assert (error? result) "counter-inc with no args should fail")
    true
  })

(test/define "gauge-set-no-args-fails"
  {do
    (= {result} (metrics/gauge-set))
    (test/assert (error? result) "gauge-set with no args should fail")
    true
  })

(test/define "gauge-set-one-arg-fails"
  {do
    (= {g} (metrics/gauge "one_arg_test"))
    (= {result} (metrics/gauge-set g))
    (test/assert (error? result) "gauge-set with one arg should fail")
    true
  })

(test/define "gauge-inc-no-args-fails"
  {do
    (= {result} (metrics/gauge-inc))
    (test/assert (error? result) "gauge-inc with no args should fail")
    true
  })

(test/define "gauge-dec-no-args-fails"
  {do
    (= {result} (metrics/gauge-dec))
    (test/assert (error? result) "gauge-dec with no args should fail")
    true
  })

(test/define "histogram-observe-no-args-fails"
  {do
    (= {result} (metrics/histogram-observe))
    (test/assert (error? result) "histogram-observe with no args should fail")
    true
  })

(test/define "histogram-observe-one-arg-fails"
  {do
    (= {h} (metrics/histogram "one_arg_hist"))
    (= {result} (metrics/histogram-observe h))
    (test/assert (error? result) "histogram-observe with one arg should fail")
    true
  })

(test/define "metrics-json-with-args-fails"
  {do
    (= {result} (metrics/json "extra-arg"))
    (test/assert (error? result) "metrics/json with args should fail")
    true
  })

(test/define "metrics-prometheus-with-args-fails"
  {do
    (= {result} (metrics/prometheus "extra-arg"))
    (test/assert (error? result) "metrics/prometheus with args should fail")
    true
  })

(test/define "metrics-collect-delta-with-args-fails"
  {do
    (= {result} (metrics/collect-delta "extra-arg"))
    (test/assert (error? result) "metrics/collect-delta with args should fail")
    true
  })

(test/define "metrics-delta-json-wrong-type"
  {do
    (= {result} (metrics/delta-json "not-a-delta"))
    (test/assert (error? result) "metrics/delta-json with string should fail")
    true
  })

(test/define "counter-inc-too-many-args"
  {do
    (= {c} (metrics/counter "too_many_args_counter"))
    (= {result} (metrics/counter-inc c 1 2 3))
    (test/assert (error? result) "counter-inc with too many args should fail")
    true
  })

(test/run {})
