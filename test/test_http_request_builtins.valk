; HTTP Request Builtins Coverage Tests
; Tests req/method, req/path, req/authority, req/scheme, req/headers, req/header, req/body, req/stream-id

(load "src/prelude.valk")
(load "src/modules/test.valk")

(test/suite "HTTP Request Builtins Coverage")

(def {aio} (aio/start))

(def {test-results} {})

(def {method-handler}
  (\ {req} {
    (= {method} (req/method req))
    `{:status "200" :body ,method}
  }))

(def {path-handler}
  (\ {req} {
    (= {path} (req/path req))
    `{:status "200" :body ,path}
  }))

(def {authority-handler}
  (\ {req} {
    (= {auth} (req/authority req))
    (if (nil? auth)
      {`{:status "200" :body "nil-authority"}}
      {`{:status "200" :body ,auth}})
  }))

(def {scheme-handler}
  (\ {req} {
    (= {sch} (req/scheme req))
    `{:status "200" :body ,sch}
  }))

(def {headers-handler}
  (\ {req} {
    (= {hdrs} (req/headers req))
    (= {count} (len hdrs))
    `{:status "200" :body ,(str count)}
  }))

(def {header-handler}
  (\ {req} {
    (= {ua} (req/header req "user-agent"))
    (if (nil? ua)
      {`{:status "200" :body "no-user-agent"}}
      {`{:status "200" :body ,ua}})
  }))

(def {header-missing-handler}
  (\ {req} {
    (= {val} (req/header req "x-nonexistent-header"))
    (if (nil? val)
      {`{:status "200" :body "header-missing"}}
      {`{:status "200" :body ,val}})
  }))

(def {body-handler}
  (\ {req} {
    (= {b} (req/body req))
    (if (nil? b)
      {`{:status "200" :body "no-body"}}
      {`{:status "200" :body ,b}})
  }))

(def {stream-id-handler}
  (\ {req} {
    (= {sid} (req/stream-id req))
    `{:status "200" :body ,(str sid)}
  }))

(def {all-builtins-handler}
  (\ {req} {
    (= {method} (req/method req))
    (= {path} (req/path req))
    (= {auth} (req/authority req))
    (= {sch} (req/scheme req))
    (= {hdrs} (req/headers req))
    (= {hdr-count} (len hdrs))
    (= {body} (req/body req))
    (= {sid} (req/stream-id req))
    `{:status "200" :body "all-ok"}
  }))

(fun {route path handlers} {
  (if (nil? handlers)
    {{:status "404" :body "not-found"}}
    {(if (== path (fst (fst handlers)))
      {(eval (snd (fst handlers)))}
      {(route path (tail handlers))})})
})

(def {router}
  (\ {req} {
    (= {path} (req/path req))
    (route path (list
      {"/method" {(method-handler req)}}
      {"/path" {(path-handler req)}}
      {"/authority" {(authority-handler req)}}
      {"/scheme" {(scheme-handler req)}}
      {"/headers" {(headers-handler req)}}
      {"/header" {(header-handler req)}}
      {"/header-missing" {(header-missing-handler req)}}
      {"/body" {(body-handler req)}}
      {"/stream-id" {(stream-id-handler req)}}
      {"/all" {(all-builtins-handler req)}}))
  }))

(def {server} (http2/server-listen aio 0 router))
(def {TEST_PORT} (http2/server-port server))

(fun {make-test path expected-body done} {
  (http2/client-request aio "127.0.0.1" TEST_PORT path
    (\ {resp} {
      (if (error? resp)
        {(done false)}
        {(do
          (= {body} (http2/response-body resp))
          (done (== body expected-body)))})
    }))
})

(test/async "req/path returns request path" (\ {done} {
  (make-test "/path" "/path" done)
}))

(test/async "req/headers returns headers list" (\ {done} {
  (http2/client-request aio "127.0.0.1" TEST_PORT "/headers"
    (\ {resp} {
      (if (error? resp)
        {(done false)}
        {(do
          (= {body} (http2/response-body resp))
          (= {count} (int body))
          (done (> count 0)))})
    }))
}))

(test/async "req/header returns header value" (\ {done} {
  (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/header"
    {{"user-agent" "TestAgent/1.0"}}
    (\ {resp} {
      (if (error? resp)
        {(done false)}
        {(do
          (= {body} (http2/response-body resp))
          (done (== body "TestAgent/1.0")))})
    }))
}))

(test/async "req/header returns nil for missing header" (\ {done} {
  (make-test "/header-missing" "header-missing" done)
}))

(test/async "req/body returns nil for GET without body" (\ {done} {
  (make-test "/body" "no-body" done)
}))

(test/async "req/stream-id returns stream id" (\ {done} {
  (http2/client-request aio "127.0.0.1" TEST_PORT "/stream-id"
    (\ {resp} {
      (if (error? resp)
        {(done false)}
        {(do
          (= {body} (http2/response-body resp))
          (= {sid} (int body))
          (done (> sid 0)))})
    }))
}))

(test/async "req/authority returns authority" (\ {done} {
  (http2/client-request aio "127.0.0.1" TEST_PORT "/authority"
    (\ {resp} {
      (if (error? resp)
        {(done false)}
        {(do
          (= {body} (http2/response-body resp))
          (done (!= body "")))})
    }))
}))

(test/async "req/scheme returns scheme" (\ {done} {
  (http2/client-request aio "127.0.0.1" TEST_PORT "/scheme"
    (\ {resp} {
      (if (error? resp)
        {(done false)}
        {(do
          (= {body} (http2/response-body resp))
          (done (!= body "")))})
    }))
}))

(test/async "all request builtins work together" (\ {done} {
  (make-test "/all" "all-ok" done)
}))

(test/run-async aio)
