(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {aio} (aio/start))

(def {stream-closed-result} (atom 0))

(def {stream-closed-test-handler}
  (\ {req} {
    (= {path} (req/path req))
    (if (== path "/test-stream-closed")
      {(do
        (= {stream} (sse/open req))
        (= {closed-future} (stream/closed stream))
        (aio/then closed-future (\ {result} {
          (if (== result (quote :closed))
            {(atom/set! stream-closed-result 1)}
            {(atom/set! stream-closed-result 2)})}))
        (stream/write stream "data: test\n\n")
        (stream/close stream)
        :deferred)}
      {{:status "404" :body "Not found"}})}))

(def {stream-closed-server} (http2/server-listen aio 0 stream-closed-test-handler))
(def {STREAM_CLOSED_PORT} (http2/server-port stream-closed-server))

(test/run-async aio (list
  (test-async "stream/closed future completes with :closed when stream closes" (\ {done} {
    (aio/then (http2/client-request aio "127.0.0.1" STREAM_CLOSED_PORT "/test-stream-closed") (\ {resp} {}))
    (aio/schedule aio 200 (\ {} {
      (= {result} (atom/get stream-closed-result))
      (if (== result 1)
        {(done true)}
        {(do (print "Expected 1 (got :closed), got:" result) (done false))})}))
  }))
  (test-async "sse-open-outside-handler-fails" (\ {done} {
    (= {result} (sse/open))
    (done (error? result))
  }))
  (test-async "sse-open-with-args-fails" (\ {done} {
    (= {result} (sse/open "extra-arg"))
    (done (error? result))
  }))
  (test-async "sse-send-no-args-fails" (\ {done} {
    (= {result} (sse/send))
    (done (error? result))
  }))
  (test-async "sse-send-one-arg-fails" (\ {done} {
    (= {result} (sse/send "not-a-stream"))
    (done (error? result))
  }))
  (test-async "sse-send-wrong-type-fails" (\ {done} {
    (= {result} (sse/send "not-a-stream" "data"))
    (done (error? result))
  }))
  (test-async "sse-send-too-many-args-fails" (\ {done} {
    (= {result} (sse/send "a" "b" "c" "d"))
    (done (error? result))
  }))
  (test-async "sse-close-no-args-fails" (\ {done} {
    (= {result} (sse/close))
    (done (error? result))
  }))
  (test-async "sse-close-wrong-type-fails" (\ {done} {
    (= {result} (sse/close "not-a-stream"))
    (done (error? result))
  }))
  (test-async "sse-writable-no-args-fails" (\ {done} {
    (= {result} (sse/writable?))
    (done (error? result))
  }))
  (test-async "sse-writable-wrong-type-fails" (\ {done} {
    (= {result} (sse/writable? "not-a-stream"))
    (done (error? result))
  }))
  (test-async "sse-on-drain-no-args-fails" (\ {done} {
    (= {result} (sse/on-drain))
    (done (error? result))
  }))
  (test-async "sse-on-drain-one-arg-fails" (\ {done} {
    (= {result} (sse/on-drain "stream"))
    (done (error? result))
  }))
  (test-async "sse-on-drain-wrong-stream-type-fails" (\ {done} {
    (= {result} (sse/on-drain "not-a-stream" (\ {} {})))
    (done (error? result))
  }))
  (test-async "sse-on-drain-wrong-callback-type-fails" (\ {done} {
    (= {result} (sse/on-drain "stream" "not-a-function"))
    (done (error? result))
  }))
  (test-async "sse-set-timeout-no-args-fails" (\ {done} {
    (= {result} (sse/set-timeout))
    (done (error? result))
  }))
  (test-async "sse-set-timeout-one-arg-fails" (\ {done} {
    (= {result} (sse/set-timeout "stream"))
    (done (error? result))
  }))
  (test-async "sse-set-timeout-wrong-stream-type-fails" (\ {done} {
    (= {result} (sse/set-timeout "not-a-stream" 1000))
    (done (error? result))
  }))
  (test-async "sse-set-timeout-wrong-timeout-type-fails" (\ {done} {
    (= {result} (sse/set-timeout "stream" "not-a-number"))
    (done (error? result))
  }))
  (test-async "sse-cancel-no-args-fails" (\ {done} {
    (= {result} (sse/cancel))
    (done (error? result))
  }))
  (test-async "sse-cancel-wrong-type-fails" (\ {done} {
    (= {result} (sse/cancel "not-a-stream"))
    (done (error? result))
  }))
  (test-async "sse-stream-id-no-args-fails" (\ {done} {
    (= {result} (sse/stream-id))
    (done (error? result))
  }))
  (test-async "sse-stream-id-wrong-type-fails" (\ {done} {
    (= {result} (sse/stream-id "not-a-stream"))
    (done (error? result))
  }))
  (test-async "sse-cancel-by-id-no-args-fails" (\ {done} {
    (= {result} (sse/cancel-by-id))
    (done (error? result))
  }))
  (test-async "sse-cancel-by-id-wrong-type-fails" (\ {done} {
    (= {result} (sse/cancel-by-id "not-a-number"))
    (done (error? result))
  }))
  (test-async "sse-cancel-by-id-nonexistent" (\ {done} {
    (= {result} (sse/cancel-by-id 999999))
    (done (= result false))
  }))
  (test-async "sse-shutdown-all-no-args" (\ {done} {
    (= {result} (sse/shutdown-all))
    (done (number? result))
  }))
  (test-async "sse-shutdown-all-with-timeout" (\ {done} {
    (= {result} (sse/shutdown-all 0))
    (done (number? result))
  }))
  (test-async "sse-shutdown-all-too-many-args-fails" (\ {done} {
    (= {result} (sse/shutdown-all 1000 2000))
    (done (error? result))
  }))
  (test-async "sse-shutdown-all-wrong-type-fails" (\ {done} {
    (= {result} (sse/shutdown-all "not-a-number"))
    (done (error? result))
  }))
  (test-async "sse-stream-count-no-args" (\ {done} {
    (= {result} (sse/stream-count))
    (done (and (number? result) (>= result 0)))
  }))
  (test-async "sse-stream-count-with-args-fails" (\ {done} {
    (= {result} (sse/stream-count "extra"))
    (done (error? result))
  }))
  (test-async "stream-closed-no-args-fails" (\ {done} {
    (= {result} (stream/closed))
    (done (error? result))
  }))
  (test-async "stream-closed-wrong-type-fails" (\ {done} {
    (= {result} (stream/closed "not-a-stream"))
    (done (error? result))
  }))
  (test-async "stream-closed-too-many-args-fails" (\ {done} {
    (= {result} (stream/closed "a" "b"))
    (done (error? result))
  })))
  {:suite-name "SSE Builtins Tests" :timeout 5000})
