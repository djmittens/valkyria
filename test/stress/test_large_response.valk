; test_large_response.valk
; Stress test for 50MB response through the Lisp machinery.
; Exercises: Lisp handler -> response building -> HTTP/2 framing -> SSL

(load "src/prelude.valk")

(println "=== Large Response Stress Test ===")
(println "")

; 50MB = 52428800 bytes
(def {RESPONSE_SIZE} 52428800)

(println "Pre-allocating 50MB test data...")
(def {big-string} (make-string RESPONSE_SIZE 65))  ; 65 = 'A'
(printf "  50MB: %d bytes\n" (len big-string))
(println "")

(def {aio} (aio/await (aio/start)))

(def {server-handler}
  (\ {req} {
    (= {path} (req/path req))
    (select
      {(== path "/big")
       `{:status "200" :content-type "text/plain" :body ,big-string}}
      {otherwise
       {:status "404" :content-type "text/plain" :body "Not found"}})}))

(def {server} (http2/server-listen aio 0 server-handler))
(def {test-port} (http2/server-port server))
(printf "Starting server on port %d\n" test-port)

(def {tests-passed} 0)
(def {tests-failed} 0)

(aio/schedule aio 500 (\ {} {
  (println "Testing 50MB download...")
  (aio/then (http2/client-request aio "127.0.0.1" test-port "/big")
    (\ {resp} {
      (if (error? resp)
        {(do
           (printf "FAIL: 50MB download error: %s\n" (error-message resp))
           (def {tests-failed} (+ tests-failed 1)))}
        {(do
           (= {body} (http2/response-body resp))
           (= {body-len} (len body))
           (if (== body-len RESPONSE_SIZE)
             {(do
                (printf "PASS: 50MB download - %d bytes\n" body-len)
                (def {tests-passed} (+ tests-passed 1)))}
             {(do
                (printf "FAIL: 50MB download - expected %d, got %d\n" RESPONSE_SIZE body-len)
                (def {tests-failed} (+ tests-failed 1)))}))})

      (println "")
      (println "=== Results ===")
      (printf "Passed: %d/1\n" tests-passed)
      (printf "Failed: %d\n" tests-failed)

      (if (== tests-failed 0)
        {(println "PASS: Large response stress test passed")}
        {(println "FAIL: Large response stress test failed")})

      (aio/stop aio)
    }))
}))

(aio/schedule aio 120000 (\ {} {
  (println "TIMEOUT: Test did not complete in 120 seconds")
  (def {tests-failed} (+ tests-failed 1))
  (aio/stop aio)
}))

(aio/run aio)

(exit (if (== tests-failed 0) {0} {1}))
