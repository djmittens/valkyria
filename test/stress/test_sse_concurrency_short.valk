; SSE Concurrency Stress Test (Short Version for CI)
; Tests 10 concurrent SSE connections with rapid connect/disconnect cycles
; Runs for 10 seconds - suitable for regular CI runs

(load "src/prelude.valk")
(load "src/modules/test.valk")
(load "src/modules/aio/debug.valk")

(def {aio} (aio/start))

(def {CONCURRENT_CONNECTIONS} 10)
(def {TEST_DURATION_MS} 10000)
(def {CYCLE_INTERVAL_MS} 500)
(def {EVENTS_PER_CONNECTION} 3)

(def {connections-opened} (atom 0))
(def {connections-closed} (atom 0))
(def {events-received} (atom 0))
(def {errors-count} (atom 0))
(def {test-running} (atom true))
(def {active-connections} (atom 0))

(fun {str-contains? haystack needle}
  {(> (len (str/split haystack needle)) 1)})

(fun {stress-sse-handler req}
  {(= {path} (req/path req))
   (if (== path "/stress-sse")
     (do
       (= {stream} (sse/open req))
       (= {events-sent} (atom 0))
       (= {closed} (atom false))
       (= {sys} aio)
       (stream/on-close stream (\ {} {(atom/set! closed true)}))
       (aio/interval sys 50 (\ {}
         {(if (atom/get closed)
            :stop
            (if (>= (atom/get events-sent) EVENTS_PER_CONNECTION)
              (do
                (stream/close stream)
                :stop)
              (do
                (atom/set! events-sent (+ (atom/get events-sent) 1))
                (= {n} (atom/get events-sent))
                (if (== n 1)
                  (do
                    (= {state} (aio/debug-diagnostics-state sys))
                    (stream/write stream (str "event: diagnostics\ndata: " state "\n\n")))
                  (do
                    (= {delta} (aio/debug-diagnostics-delta sys))
                    (stream/write stream (str "event: diagnostics-delta\ndata: " delta "\n\n")))))))}))
       :deferred)
     (aio/debug-handle-request aio req))})

(def {server} (http2/server-listen aio 0 stress-sse-handler))
(def {TEST_PORT} (http2/server-port server))

(fun {log-status}
  {(printf "Status: opened=%d closed=%d events=%d errors=%d active=%d\n"
           (atom/get connections-opened)
           (atom/get connections-closed)
           (atom/get events-received)
           (atom/get errors-count)
           (atom/get active-connections))})

(def {MAX_ACTIVE} 5)

(fun {handle-response resp}
  {(atom/set! active-connections (- (atom/get active-connections) 1))
   (atom/set! connections-closed (+ (atom/get connections-closed) 1))
   (if (error? resp)
     (atom/set! errors-count (+ (atom/get errors-count) 1))
     (do
       (= {body} (http2/response-body resp))
       (if (str-contains? body "event:")
         (atom/set! events-received (+ (atom/get events-received) 1))
         nil)))})

(fun {create-sse-connection id}
  {(if (not (atom/get test-running))
     nil
     (if (>= (atom/get active-connections) MAX_ACTIVE)
       nil
       (do
         (atom/set! connections-opened (+ (atom/get connections-opened) 1))
         (atom/set! active-connections (+ (atom/get active-connections) 1))
         (http2/client-request aio "127.0.0.1" TEST_PORT "/stress-sse"
           (\ {resp} {(handle-response resp)})))))})

(fun {create-batch n}
  {(if (<= n 0)
     nil
     (do
       (create-sse-connection n)
       (create-batch (- n 1))))})

(fun {cycle-connections}
  {(if (not (atom/get test-running))
     nil
     (do
       (create-batch CONCURRENT_CONNECTIONS)
       (aio/schedule aio CYCLE_INTERVAL_MS (\ {} {(cycle-connections)}))))})

(println "=== SSE Concurrency Stress Test (Short) ===")
(printf "Testing %d concurrent SSE connections for %d seconds\n" CONCURRENT_CONNECTIONS (/ TEST_DURATION_MS 1000))
(printf "Server running on port %d\n" TEST_PORT)
(println "")

(cycle-connections)

(aio/interval aio 2000 (\ {}
  {(if (atom/get test-running)
     (do (log-status) nil)
     :stop)}))

(aio/schedule aio TEST_DURATION_MS (\ {}
  {(println "")
   (println "=== Test Complete ===")
   (atom/set! test-running false)
   (log-status)
   (= {opened} (atom/get connections-opened))
   (= {closed} (atom/get connections-closed))
   (= {events} (atom/get events-received))
   (= {errors} (atom/get errors-count))
   (println "")
   (= {error-threshold} (+ 1 (/ opened 100)))
   (if (and (> opened 0)
            (and (> events 0)
                 (< errors error-threshold)))
     (do
       (println "PASS: Stress test completed successfully")
       (printf "  - Opened %d connections\n" opened)
       (printf "  - Received %d events\n" events)
       (printf "  - Errors: %d (threshold: %d)\n" errors error-threshold)
       (aio/schedule aio 2000 (\ {} {(aio/stop aio)})))
     (do
       (println "FAIL: Stress test failed")
       (printf "  - Opened: %d (expected > 0)\n" opened)
       (printf "  - Events: %d (expected > 0)\n" events)
       (printf "  - Errors: %d (expected < %d)\n" errors error-threshold)
       (exit 1)))}))

(aio/run aio)
