; SSE Concurrency Stress Test (Long Version)
; Tests concurrent SSE connections over a longer duration

(load "src/prelude.valk")
(load "src/modules/test.valk")
(load "src/modules/aio/debug.valk")

(def {aio} (aio/await (aio/start)))

(fun {str-contains? haystack needle}
  {(> (len (str/split haystack needle)) 1)})

; SSE handler that sends a few events then closes
(fun {stress-sse-handler req}
  {(= {path} (req/path req))
   (if (== path "/stress-sse")
     (do
       (= {stream} (sse/open req))
       (stream/write stream (str "event: diagnostics\ndata: " (aio/debug-diagnostics-state aio) "\n\n"))
       (aio/then (aio/sleep aio 100)
         (\ {_} {
           (stream/write stream (str "event: diagnostics-delta\ndata: " (aio/debug-diagnostics-delta aio) "\n\n"))
           (aio/then (aio/sleep aio 100)
             (\ {_} {
               (stream/write stream (str "event: diagnostics-delta\ndata: " (aio/debug-diagnostics-delta aio) "\n\n"))
               (stream/close stream)}))})))
     {:status "404" :body "Not found"})})

(def {server} (http2/server-listen aio 0 stress-sse-handler))
(def {port} (http2/server-port server))

; Single SSE connection test
(fun {test-sse-connection}
  {(aio/then (http2/client-request aio "127.0.0.1" port "/stress-sse")
     (\ {resp}
       {(if (error? resp)
          false
          (str-contains? (http2/response-body resp) "event:"))}))})

; Run N batches of M concurrent connections
(fun {run-batches batches-remaining batch-size}
  {(if (<= batches-remaining 0)
     (aio/pure {})
     (aio/then (aio/all (map (\ {_} {(test-sse-connection)}) (range 0 batch-size)))
       (\ {batch-results}
         {(aio/then (aio/sleep aio 500)
            (\ {_}
              {(aio/then (run-batches (- batches-remaining 1) batch-size)
                 (\ {rest-results}
                   {(join batch-results rest-results)}))}))})))})

(println "=== SSE Concurrency Stress Test ===")
(printf "Server running on port %d\n" port)
(println "Running 10 batches of 5 concurrent connections...")

(test/run-async aio (list
  (test-async "50 SSE connections across 10 batches" (\ {} {
    (aio/then (run-batches 10 5)
      (\ {results}
        {(= {total} (len results))
         (= {successes} (len (filter (\ {r} {r}) results)))
         (printf "Results: %d/%d successes\n" successes total)
         (> successes (/ total 2))}))}))
) {:suite-name "SSE Concurrency Stress Test" :timeout-ms 120000 :suite-timeout-ms 180000})
