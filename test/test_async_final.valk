; Comprehensive async/await tests using continuation-based API
; Tests multiple real-world async patterns

(load "src/prelude.valk")

(print "=== Comprehensive Async/Await Test Suite ===\n")

; === Mock Async Services ===

(def {fetch-user} (\ {user-id k} {
  (print "  [User Service] Fetching user" user-id)
  (k (list "user" user-id (join "User" (str user-id))))
}))

(def {fetch-posts} (\ {user-id k} {
  (print "  [Posts Service] Fetching posts for user" user-id)
  (k (list
    (list "post" 1 user-id "First post")
    (list "post" 2 user-id "Second post")
    (list "post" 3 user-id "Third post")))
}))

(def {fetch-comments} (\ {post-id k} {
  (print "  [Comments Service] Fetching comments for post" post-id)
  (k (list
    (list "comment" 1 post-id "Great!")
    (list "comment" 2 post-id "Thanks!")))
}))

(def {fetch-analytics} (\ {entity-type entity-id k} {
  (print "  [Analytics] Fetching" entity-type "analytics for" entity-id)
  (k (list entity-type entity-id "views" (* entity-id 100)))
}))

; === Test 1: Simple Sequential Operations ===
(print "\nTest 1: Sequential Operations")
(def {test1-result} (async-reset {
  (def {user} (async-shift {k} {(fetch-user 42 k)}))
  (print "  Got user:" (nth 2 user))

  (def {posts} (async-shift {k} {(fetch-posts 42 k)}))
  (print "  Got" (len posts) "posts")

  (def {analytics} (async-shift {k} {(fetch-analytics "user" 42 k)}))
  (print "  Analytics:" (nth 3 analytics) "views")

  (list user posts analytics)
}))

(if (== (len test1-result) 3)
  (print "✓ Test 1 passed: Sequential operations completed\n")
  (print "✗ Test 1 failed\n"))

; === Test 2: Nested Async Operations ===
(print "Test 2: Nested Data Fetching")
(def {test2-result} (async-reset {
  (def {user-id} 7)

  ; Fetch user
  (def {user} (async-shift {k} {(fetch-user user-id k)}))
  (print "  Fetched user:" (nth 2 user))

  ; Fetch posts for that user
  (def {posts} (async-shift {k} {(fetch-posts user-id k)}))
  (print "  Fetched" (len posts) "posts")

  ; Fetch comments for first post
  (def {first-post} (head posts))
  (def {post-id} (nth 1 first-post))
  (def {comments} (async-shift {k} {(fetch-comments post-id k)}))
  (print "  Fetched" (len comments) "comments for post" post-id)

  ; Fetch analytics for that post
  (def {post-analytics} (async-shift {k} {(fetch-analytics "post" post-id k)}))
  (print "  Post views:" (nth 3 post-analytics))

  ; Build enriched post data
  (list first-post comments post-analytics)
}))

(if (== (len test2-result) 3)
  (print "✓ Test 2 passed: Nested async operations completed\n")
  (print "✗ Test 2 failed\n"))

; === Test 3: Conditional Async Flow ===
(print "Test 3: Conditional Async Flow")

(def {check-threshold} (\ {value k} {
  (print "  Checking threshold for" value)
  (k (> value 50))
}))

(def {process-high} (\ {value k} {
  (print "  Processing high value:" value)
  (k (* value 10))
}))

(def {process-low} (\ {value k} {
  (print "  Processing low value:" value)
  (k (* value 2))
}))

(def {test3-result} (async-reset {
  (def {value} 75)
  (def {is-high} (async-shift {k} {(check-threshold value k)}))

  (if is-high
    {(async-shift {k} {(process-high value k)})}
    {(async-shift {k} {(process-low value k)})})
}))

(if (== test3-result 750)
  (print "✓ Test 3 passed: Conditional flow worked correctly\n")
  (print "✗ Test 3 failed: Expected 750, got" test3-result "\n"))

; === Test 4: Chained Transformations ===
(print "Test 4: Chained Async Transformations")

(def {double-async} (\ {x k} {
  (print "  Doubling:" x)
  (k (* x 2))
}))

(def {add-ten-async} (\ {x k} {
  (print "  Adding 10 to:" x)
  (k (+ x 10))
}))

(def {square-async} (\ {x k} {
  (print "  Squaring:" x)
  (k (* x x))
}))

(def {test4-result} (async-reset {
  (def {step1} (async-shift {k} {(double-async 5 k)}))
  (def {step2} (async-shift {k} {(add-ten-async step1 k)}))
  (def {step3} (async-shift {k} {(square-async step2 k)}))
  step3
}))

; (5 * 2 + 10) ^ 2 = 20 ^ 2 = 400
(if (== test4-result 400)
  (print "✓ Test 4 passed: Chained transformations = 400\n")
  (print "✗ Test 4 failed: Expected 400, got" test4-result "\n"))

; === Test 5: Building Complex Data Structure ===
(print "Test 5: Building Dashboard Data")

(def {test5-result} (async-reset {
  (def {user-id} 10)

  ; Fetch multiple things for a dashboard
  (def {user-data} (async-shift {k} {(fetch-user user-id k)}))
  (def {posts-data} (async-shift {k} {(fetch-posts user-id k)}))
  (def {user-analytics} (async-shift {k} {(fetch-analytics "user" user-id k)}))

  ; Build dashboard structure
  (def {dashboard} (list
    (list "user" user-data)
    (list "posts" posts-data)
    (list "analytics" user-analytics)))

  (print "  Built dashboard with" (len posts-data) "posts")
  dashboard
}))

(if (== (len test5-result) 3)
  (print "✓ Test 5 passed: Complex data structure built\n")
  (print "✗ Test 5 failed\n"))

; === Test 6: Error Simulation ===
(print "Test 6: Simulated Error Handling")

(def {risky-operation} (\ {value k} {
  (print "  Risky operation with:" value)
  (if (== (mod value 2) 0)
    {(k (list "success" (* value 3)))}
    {(k (list "error" "Odd numbers not allowed"))})
}))

(def {test6a} (async-reset {
  (def {result} (async-shift {k} {(risky-operation 4 k)}))
  (if (== (head result) "success")
    {(nth 1 result)}
    {0})
}))

(def {test6b} (async-reset {
  (def {result} (async-shift {k} {(risky-operation 3 k)}))
  (if (== (head result) "success")
    {(nth 1 result)}
    {-1})
}))

(if (& (== test6a 12) (== test6b -1))
  (print "✓ Test 6 passed: Error handling works (success=12, error=-1)\n")
  (print "✗ Test 6 failed\n"))

; === Test 7: Multiple Independent Async Calls ===
(print "Test 7: Multiple Independent Async Calls")

(def {test7-result} (async-reset {
  ; Fetch data for multiple users independently
  (def {user1} (async-shift {k} {(fetch-user 1 k)}))
  (def {user2} (async-shift {k} {(fetch-user 2 k)}))
  (def {user3} (async-shift {k} {(fetch-user 3 k)}))

  (print "  Fetched 3 users:" (nth 2 user1) "," (nth 2 user2) "," (nth 2 user3))

  (list user1 user2 user3)
}))

(if (== (len test7-result) 3)
  (print "✓ Test 7 passed: Multiple independent calls completed\n")
  (print "✗ Test 7 failed\n"))

(print "\n=== All Tests Completed ===")
(print "✓ Continuation-based async/await system is working!")
(print "\nKey Features Demonstrated:")
(print "  • Sequential async operations")
(print "  • Nested data fetching")
(print "  • Conditional async flow")
(print "  • Chained transformations")
(print "  • Complex data structures")
(print "  • Error handling patterns")
(print "  • Multiple independent calls")

(shutdown 0)
