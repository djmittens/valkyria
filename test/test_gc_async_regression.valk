; GC Async Regression Test Suite
; Tests for GC bugs that occurred with async/timer operations
; These test garbage collection across checkpoint boundaries

(load "src/prelude.valk")
(load "src/http_api.valk")

(= {aio} (aio/await (aio/start)))

; ============================================================================
; Parallel Timer Callback Crash (Fixed 2026-01-02)
; Bug: When 4+ parallel HTTP requests were made through timer callbacks,
; the GC checkpoint would crash with "value must not be null at apply_cont"
; Root cause: Phase 2 of GC could visit environments that Phase 1 hadn't
; processed, leading to un-forwarded scratch pointers being NULLed.
;
; This test verifies the fix by running 4+ parallel HTTP requests.
; The timer callback aspect is tested by using aio/sleep to delay request start.
; ============================================================================

(= {server-handler} (\ {req} { `{:status "200" :body "Hi"} }))
(= {server} (http2/server-listen aio 0 server-handler))
(= {port} (http2/server-port server))

(printf "üß™ GC Async Regression Tests\n\n")

; Start test with a small delay to trigger timer machinery
(aio/then (aio/sleep aio 1) (\ {_} {
  ; Run 4 parallel HTTP requests (the bug occurred at 4+)
  (aio/then 
    (aio/all (list
      (http2/client-request aio "127.0.0.1" port "/")
      (http2/client-request aio "127.0.0.1" port "/")
      (http2/client-request aio "127.0.0.1" port "/")
      (http2/client-request aio "127.0.0.1" port "/")))
    (\ {results} {
      (= {count} (len results))
      (if (== count 4)
        {do 
          (printf "‚úÖ gc-parallel-timer-callbacks-no-crash\n")
          (printf "\nüèÅ Results: 1 passed, 0 failed\n")
          (aio/stop aio)
          (shutdown 0)}
        {do
          (printf "‚ùå gc-parallel-timer-callbacks-no-crash - expected 4 results, got %d\n" count)
          (printf "\nüèÅ Results: 0 passed, 1 failed\n")
          (aio/stop aio)
          (shutdown 1)})
    }))
}))

(aio/run aio)
