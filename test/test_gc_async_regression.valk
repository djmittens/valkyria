; GC Async Regression Test Suite
; Tests for GC bugs that occurred with async/timer operations
; These test garbage collection across checkpoint boundaries
;
; Bug fixed 2026-01-02: When 4+ parallel HTTP requests were made through
; timer callbacks, the GC checkpoint would crash with "value must not be
; null at apply_cont". Root cause: Phase 2 of GC could visit environments
; that Phase 1 hadn't processed, leading to un-forwarded scratch pointers.

(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {aio} (aio/await (aio/start)))

(def {server-handler} (\ {req} {`{:status "200" :body "Hi"}}))
(def {server} (http2/server-listen aio 0 server-handler))
(def {port} (http2/server-port server))

(test/run-async aio (list
  (test-async "4+ parallel HTTP requests via timer don't crash GC" (\ {} {
    (aio/then (aio/sleep aio 1) (\ {_} {
      (aio/then
        (aio/all (list
          (http2/client-request aio "127.0.0.1" port "/")
          (http2/client-request aio "127.0.0.1" port "/")
          (http2/client-request aio "127.0.0.1" port "/")
          (http2/client-request aio "127.0.0.1" port "/")))
        (\ {results} {
          (== (len results) 4)
        }))
    }))
  })))
  {:suite-name "GC Async Regression Tests" :timeout-ms 5000})

(http2/server-stop server)
(aio/stop aio)
