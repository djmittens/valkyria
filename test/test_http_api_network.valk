; HTTP API Network Integration Tests
; Tests http_api.valk functions that require real network connections
; Starts a local server and tests the high-level fetch functions

(load "src/prelude.valk")
(load "src/modules/test.valk")

(fun {reverse l} {
  (= {reverse-helper} (\ {acc remaining} {
    (if (== remaining nil)
      {acc}
      {(reverse-helper (join (list (head remaining)) acc) (tail remaining))})
  }))
  (reverse-helper nil l)
})

(load "src/http_api.valk")

(def {aio} (aio/start))

(def {server-handler}
  (\ {req} {
    (= {path} (req/path req))
    (if (== path "/error")
      {`{:status "500" :body "Internal Server Error"}}
      {`{:status "200" :body "Hello from test server"}})
  }))

(def {server} (http2/server-listen aio 0 server-handler))
(def {test-port} (http2/server-port server))

(test/run-async aio (list
  (test-async "http2/client-request returns async handle" (\ {aio} {
    (= {h} (http2/client-request aio "127.0.0.1" test-port "/"))
    (aio/then h (\ {resp} {
      (and (not (error? resp)) (== (http2/response-status resp) "200"))
    }))
  }))
  (test-async "http2/client-request body extraction" (\ {aio} {
    (= {h} (http2/client-request aio "127.0.0.1" test-port "/"))
    (aio/then h (\ {resp} {
      (not (error? (http2/response-body resp)))
    }))
  }))
  (test-async "http2/response-ok? returns true for 200" (\ {aio} {
    (= {h} (http2/client-request aio "127.0.0.1" test-port "/"))
    (aio/then h (\ {resp} {
      (http2/response-ok? resp)
    }))
  }))
  (test-async "http2/health-check returns true for healthy endpoint" (\ {aio} {
    (= {h} (http2/client-request aio "127.0.0.1" test-port "/"))
    (aio/then h (\ {resp} {
      (http2/response-ok? resp)
    }))
  }))
  (test-async "http2/client-request with path works" (\ {aio} {
    (= {h} (http2/client-request aio "127.0.0.1" test-port "/"))
    (aio/then h (\ {resp} {
      (not (error? resp))
    }))
  }))
  (test-async "multiple requests complete" (\ {aio} {
    (= {h1} (http2/client-request aio "127.0.0.1" test-port "/"))
    (= {h2} (http2/client-request aio "127.0.0.1" test-port "/"))
    (aio/then (aio/all (list h1 h2)) (\ {results} {
      (== (len results) 2)
    }))
  }))
  (test-async "aio/all collects multiple request results" (\ {aio} {
    (= {handles} (list
      (http2/client-request aio "127.0.0.1" test-port "/")
      (http2/client-request aio "127.0.0.1" test-port "/")))
    (aio/then (aio/all handles) (\ {results} {
      (not (error? results))
    }))
  }))
  (test-async "sequential requests work" (\ {aio} {
    (= {h1} (http2/client-request aio "127.0.0.1" test-port "/"))
    (aio/then h1 (\ {resp1} {
      (= {h2} (http2/client-request aio "127.0.0.1" test-port "/"))
      (aio/then h2 (\ {resp2} {
        (and (not (error? resp1)) (not (error? resp2)))
      }))
    }))
  }))
  (test-async "batch requests with aio/all" (\ {aio} {
    (= {handles} (list
      (http2/client-request aio "127.0.0.1" test-port "/")
      (http2/client-request aio "127.0.0.1" test-port "/")))
    (aio/then (aio/all handles) (\ {results} {
      (not (error? results))
    }))
  }))
  (test-async "aio/all-settled collects results" (\ {aio} {
    (= {handles} (list
      (http2/client-request aio "127.0.0.1" test-port "/")
      (http2/client-request aio "127.0.0.1" test-port "/")))
    (aio/then (aio/all-settled handles) (\ {results} {
      (== (len results) 2)
    }))
  }))
  (test-async "aggregate pattern works" (\ {aio} {
    (= {handles} (list
      (http2/client-request aio "127.0.0.1" test-port "/")
      (http2/client-request aio "127.0.0.1" test-port "/")))
    (aio/then (aio/all handles) (\ {results} {
      (== (len results) 2)
    }))
  }))
  (test-async "error response returns 500" (\ {aio} {
    (= {h} (http2/client-request aio "127.0.0.1" test-port "/error"))
    (aio/then h (\ {resp} {
      (and (not (error? resp)) (== (http2/response-status resp) "500"))
    }))
  })))
  {:suite-name "HTTP API Network Tests"})
