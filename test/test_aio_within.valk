; Test suite for aio/within combinator  
; Tests: aio/within adds timeout to async operations

(load "src/prelude.valk")
(load "src/modules/test.valk")

; First run sync tests
(test/run (list
  (test "aio/within returns a handle"
    {do
    (def {sys} (aio/start))
    (def {h} (aio/within (aio/pure 42) 100))
    (aio/stop sys)
    (not (== h nil))
    })
  (test "aio/within with immediate completion"
    {do
    (def {sys} (aio/start))
    (def {h} (aio/within (aio/pure 42) 100))
    (def {status} (aio/status h))
    (aio/stop sys)
    (== status (quote :completed))
    })
  (test "aio/within with immediate failure"
    {do
    (def {sys} (aio/start))
    (def {h} (aio/within (aio/fail "error") 100))
    (def {status} (aio/status h))
    (aio/stop sys)
    (== status (quote :failed))
    })
  (test "aio/within handles quick completion"
    {do
    (def {sys} (aio/start))
    (def {h} (aio/within (aio/sleep sys 1) 100))
    (aio/stop sys)
    (not (== h nil))
    })
   (test "aio/within accepts timeout parameter"
     {do
     (def {sys} (aio/start))
     (def {h} (aio/within (aio/pure 1) 50))
     (aio/stop sys)
     (not (== (aio/status h) nil))
     })
     (test "aio/within creates handle with timeout parameter"
       {do
       (def {sys} (aio/start))
       (def {h} (aio/within (aio/never sys) 50))
       (aio/stop sys)
       (not (== h nil))
       })
     (test "aio/within timeout behavior verification"
       {do
       (def {sys} (aio/start))
       (def {slow-handle} (aio/sleep sys 100))
       (def {timeout-handle} (aio/within slow-handle 10))
       ; Add several short sleeps to increase test time
       (def {wait1} (aio/sleep sys 2))
       (def {wait2} (aio/sleep sys 2))
       (def {wait3} (aio/sleep sys 2))
       (def {wait4} (aio/sleep sys 2))
       (def {wait5} (aio/sleep sys 2))
       (aio/stop sys)
       ; Test passes if timeout handle was created properly
       (not (== timeout-handle nil))
       })
)
    {:suite-name "aio/within Tests"})

; Async test to verify timeout behavior - using test-async framework
(def {aio} (aio/start))

(test/run-async aio (list
  (test-async "aio/within timeout behavior verification" (\ {done} {
    (def {slow-handle} (aio/sleep aio 100))
    (def {timeout-handle} (aio/within slow-handle 10))
    ; Use scheduled callback to check result after timeout period
    (aio/schedule aio 50 (\ {} {
      (def {status} (aio/status timeout-handle))
      (def {error} (aio/error timeout-handle))
      ; Return true if timeout worked, false otherwise
      (done (and (== status (quote :failed)) (== error (quote :timeout))))
    }))
  }))
) {:suite-name "aio/within Async Tests"})

