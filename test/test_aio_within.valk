; Test suite for aio/within combinator  
; Tests: aio/within adds timeout to async operations

(load "src/prelude.valk")
(load "src/modules/test.valk")

; time/now - returns current time in milliseconds
(fun {time/now} {/ (time-us) 1000})

(def {aio} (aio/start))

(test/run (list
  (test "aio/within creates handle"
    {do
    (def {h} (aio/within (aio/pure 42) 100))
    (not (== h nil))
    })
  (test "aio/within completes without timeout"
    {do
    ; Create a basic test - immediate completion should not timeout
    (def {timeout-handle} (aio/within (aio/pure 42) 100))
    (def {status} (aio/status timeout-handle))
    ; Test passes if handle completes successfully (no timeout needed for immediate value)
    (== status (quote :completed))
    })
) {:suite-name "aio/within basic tests"})

(test/run-async aio (list
  (test-async "aio/within timeout behavior with timing" (\ {done} {
    (def {start-time} (time/now))
    
    ; Create slow operation (100ms sleep) with short timeout (10ms) - should timeout in ~10ms
    (def {timeout-handle} (aio/within (aio/sleep aio 100) 10))
    
    ; Use aio/catch to handle the timeout and measure time
    (aio/catch timeout-handle (\ {err} {
      (def {end-time} (time/now))
      (def {elapsed-ms} (- end-time start-time))
      
      ; Verify timeout behavior: should fail with timeout error in approximately 10ms, not 100ms
      (if (and 
        (== err (quote :timeout))
        (> elapsed-ms 8)    ; At least 8ms (some timing variance)
        (< elapsed-ms 50)   ; But much less than the 100ms sleep duration
      )
        {(done true)}
        {(do
          (printf "Timeout test failed: err=%s, elapsed=%f ms\n" err elapsed-ms)
          (done false)
        )}
      )
    }))
  }))
) {:suite-name "aio/within timeout tests"})

