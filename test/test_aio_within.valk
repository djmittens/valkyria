; Test suite for aio/within combinator  
; Tests: aio/within adds timeout to async operations

(load "src/prelude.valk")
(load "src/modules/test.valk")

; time/now - returns current time in milliseconds
(fun {time/now} {/ (time-us) 1000})

(def {aio} (aio/start))

(test/run-async aio (list
  (test-async "aio/within creates handle" (\ {done} {
    (def {h} (aio/within (aio/pure 42) 100))
    (done (not (== h nil)))
  }))
  (test-async "aio/within completes without timeout" (\ {done} {
    (def {timeout-handle} (aio/within (aio/pure 42) 100))
    (def {status} (aio/status timeout-handle))
    (done (== status (quote :completed)))
  }))
  (test-async "aio/within timeout behavior with timing" (\ {done} {
    (def {start-time} (time/now))
    
    (def {timeout-handle} (aio/within (aio/sleep aio 100) 10))
    
    (aio/catch timeout-handle (\ {err} {
      (def {end-time} (time/now))
      (def {elapsed-ms} (- end-time start-time))
      
      (if (and 
        (== err (quote :timeout))
        (> elapsed-ms 8)
        (< elapsed-ms 50)
      )
        {(done true)}
        {(do
          (printf "Timeout test failed: err=%s, elapsed=%f ms\n" err elapsed-ms)
          (done false)
        )}
      )
    }))
  }))
) {:suite-name "aio/within async tests"})

