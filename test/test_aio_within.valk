; Test suite for aio/within combinator  
; Tests: aio/within adds timeout to async operations

(load "src/prelude.valk")
(load "src/modules/test.valk")

(test/run (list
  (test "aio/within creates handle"
    {do
    (def {sys} (aio/start))
    (def {h} (aio/within (aio/pure 42) 100))
    (aio/stop sys)
    (not (== h nil))
    })
  (test "aio/within completes without timeout"
    {do
    (def {sys} (aio/start))
    ; Create a basic test - immediate completion should not timeout
    (def {timeout-handle} (aio/within (aio/pure 42) 100))
    (def {status} (aio/status timeout-handle))
    (aio/stop sys)
    ; Test passes if handle completes successfully (no timeout needed for immediate value)
    (== status (quote :completed))
    })
  (test "aio/within timeout behavior with timing"
    {do
    (def {sys} (aio/start))
    (def {start-time} (time/now))
    
    ; Create slow operation (100ms sleep) with short timeout (10ms) - should timeout in ~10ms
    (def {timeout-handle} (aio/within (aio/sleep sys 100) 10))
    
    ; Wait synchronously for completion
    (aio/wait timeout-handle)
    
    (def {end-time} (time/now))
    (def {elapsed-ms} (- end-time start-time))
    
    ; Check results
    (def {status} (aio/status timeout-handle))
    (def {error} (aio/error timeout-handle))
    
    (aio/stop sys)
    
    ; Verify timeout behavior: should fail with timeout error in approximately 10ms, not 100ms
    (and 
      (== status (quote :failed))
      (== error (quote :timeout))
      (> elapsed-ms 8)    ; At least 8ms (some timing variance)
      (< elapsed-ms 50)   ; But much less than the 100ms sleep duration
    )
    })
) {:suite-name "aio/within timeout tests"})

