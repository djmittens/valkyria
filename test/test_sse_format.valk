; SSE Wire Format Tests
; Verifies that SSE functions produce correct SSE-spec-compliant wire format

(load "src/prelude.valk")
(load "src/modules/test.valk")
(load "src/modules/aio/sse.valk")

(def {aio} (aio/await (aio/start)))

(def {test-handler}
  (\ {req} {
    (= {path} (req/path req))
    
    ; sse/send tests
    (if (== path "/send-simple")
      {(do
        (= {stream} (sse/open req))
        (sse/send stream "hello")
        (sse/close stream)
        :deferred
      )}
      
      {(if (== path "/send-multiline")
        {(do
          (= {stream} (sse/open req))
          (sse/send stream "a\nb")
          (sse/close stream)
          :deferred
        )}
        
        {(if (== path "/send-empty")
          {(do
            (= {stream} (sse/open req))
            (sse/send stream "")
            (sse/close stream)
            :deferred
          )}
          
          {(if (== path "/send-three-lines")
            {(do
              (= {stream} (sse/open req))
              (sse/send stream "line1\nline2\nline3")
              (sse/close stream)
              :deferred
            )}
            
            ; sse/event tests
            {(if (== path "/event-simple")
              {(do
                (= {stream} (sse/open req))
                (sse/event stream "msg" "data")
                (sse/close stream)
                :deferred
              )}
              
              {(if (== path "/event-multiline")
                {(do
                  (= {stream} (sse/open req))
                  (sse/event stream "msg" "a\nb")
                  (sse/close stream)
                  :deferred
                )}
                
                {(if (== path "/event-empty-data")
                  {(do
                    (= {stream} (sse/open req))
                    (sse/event stream "update" "")
                    (sse/close stream)
                    :deferred
                  )}
                  
                  {(if (== path "/event-three-lines")
                    {(do
                      (= {stream} (sse/open req))
                      (sse/event stream "notification" "line1\nline2\nline3")
                      (sse/close stream)
                      :deferred
                    )}
                    
                    ; sse/id tests
                    {(if (== path "/id-simple")
                      {(do
                        (= {stream} (sse/open req))
                        (sse/id stream "123" "data")
                        (sse/close stream)
                        :deferred
                      )}
                      
                      {(if (== path "/id-multiline")
                        {(do
                          (= {stream} (sse/open req))
                          (sse/id stream "evt-456" "a\nb")
                          (sse/close stream)
                          :deferred
                        )}
                        
                        ; sse/full tests
                        {(if (== path "/full-simple")
                          {(do
                            (= {stream} (sse/open req))
                            (sse/full stream "msg" "123" "data")
                            (sse/close stream)
                            :deferred
                          )}
                          
                          {(if (== path "/full-multiline")
                            {(do
                              (= {stream} (sse/open req))
                              (sse/full stream "update" "evt-789" "line1\nline2")
                              (sse/close stream)
                              :deferred
                            )}
                            
                            ; sse/retry tests
                            {(if (== path "/retry-simple")
                              {(do
                                (= {stream} (sse/open req))
                                (sse/retry stream 5000)
                                (sse/close stream)
                                :deferred
                              )}
                              
                              {(if (== path "/retry-zero")
                                {(do
                                  (= {stream} (sse/open req))
                                  (sse/retry stream 0)
                                  (sse/close stream)
                                  :deferred
                                )}
                                
                                ; sse/comment tests
                                {(if (== path "/comment-simple")
                                  {(do
                                    (= {stream} (sse/open req))
                                    (sse/comment stream "ping")
                                    (sse/close stream)
                                    :deferred
                                  )}
                                  
                                  {(if (== path "/comment-multiline")
                                    {(do
                                      (= {stream} (sse/open req))
                                      (sse/comment stream "line1\nline2")
                                      (sse/close stream)
                                      :deferred
                                    )}
                                    
                                    {(if (== path "/comment-empty")
                                      {(do
                                        (= {stream} (sse/open req))
                                        (sse/comment stream "")
                                        (sse/close stream)
                                        :deferred
                                      )}
                                      
                                      ; sse/heartbeat test
                                      {(if (== path "/heartbeat")
                                        {(do
                                          (= {stream} (sse/open req))
                                          (sse/heartbeat stream)
                                          (sse/close stream)
                                          :deferred
                                        )}
                                        
                                        {:status "404" :body "Not Found"}
                                      )}
                                    )}
                                  )}
                                )}
                              )}
                            )}
                          )}
                        )}
                      )}
                    )}
                  )}
                )}
              )}
            )}
          )}
        )}
      )}
    )
  }))

(def {server} (http2/server-listen aio 0 test-handler))
(def {TEST_PORT} (http2/server-port server))

(test/run-async aio (list
  ; sse/send tests
  (test-async "sse/send 'hello' -> 'data: hello\\n\\n'" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/send-simple")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} "data: hello\n\n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
             )})})
      }))
  }))
  
  (test-async "sse/send 'a\\nb' -> 'data: a\\ndata: b\\n\\n'" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/send-multiline")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} "data: a\ndata: b\n\n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
             )})})
      }))
  }))
  
  (test-async "sse/send '' -> 'data: \\n\\n'" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/send-empty")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} "data: \n\n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
             )})})
      }))
  }))
  
  (test-async "sse/send 'line1\\nline2\\nline3' -> 'data: line1\\ndata: line2\\ndata: line3\\n\\n'" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/send-three-lines")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} "data: line1\ndata: line2\ndata: line3\n\n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
             )})})
      }))
  }))
  
  ; sse/event tests
  (test-async "sse/event 'msg' 'data' -> 'event: msg\\ndata: data\\n\\n'" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/event-simple")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} "event: msg\ndata: data\n\n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
             )})})
      }))
  }))
  
  (test-async "sse/event 'msg' 'a\\nb' -> 'event: msg\\ndata: a\\ndata: b\\n\\n'" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/event-multiline")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} "event: msg\ndata: a\ndata: b\n\n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
             )})})
      }))
  }))
  
  (test-async "sse/event 'update' '' -> 'event: update\\ndata: \\n\\n'" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/event-empty-data")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} "event: update\ndata: \n\n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
             )})})
      }))
  }))
  
  (test-async "sse/event multi-line -> data prefix per line" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/event-three-lines")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} "event: notification\ndata: line1\ndata: line2\ndata: line3\n\n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
              )})})
      }))
  }))
  
  ; sse/id tests
  (test-async "sse/id '123' 'data' -> 'id: 123\\ndata: data\\n\\n'" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/id-simple")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} "id: 123\ndata: data\n\n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
             )})})
      }))
  }))
  
  (test-async "sse/id 'evt-456' 'a\\nb' -> 'id: evt-456\\ndata: a\\ndata: b\\n\\n'" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/id-multiline")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} "id: evt-456\ndata: a\ndata: b\n\n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
             )})})
      }))
  }))
  
  ; sse/full tests
  (test-async "sse/full 'msg' '123' 'data' -> 'id: 123\\nevent: msg\\ndata: data\\n\\n'" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/full-simple")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} "id: 123\nevent: msg\ndata: data\n\n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
             )})})
      }))
  }))
  
  (test-async "sse/full multiline -> 'id: evt-789\\nevent: update\\ndata: line1\\ndata: line2\\n\\n'" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/full-multiline")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} "id: evt-789\nevent: update\ndata: line1\ndata: line2\n\n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
             )})})
      }))
  }))
  
  ; sse/retry tests
  (test-async "sse/retry 5000 -> 'retry: 5000\\n\\n'" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/retry-simple")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} "retry: 5000\n\n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
             )})})
      }))
  }))
  
  (test-async "sse/retry 0 -> 'retry: 0\\n\\n'" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/retry-zero")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} "retry: 0\n\n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
             )})})
      }))
  }))
  
  ; sse/comment tests
  (test-async "sse/comment 'ping' -> ': ping\\n'" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/comment-simple")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} ": ping\n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
             )})})
      }))
  }))
  
  (test-async "sse/comment multiline -> ': line1\\n: line2\\n'" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/comment-multiline")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} ": line1\n: line2\n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
             )})})
      }))
  }))
  
  (test-async "sse/comment '' -> ': \\n'" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/comment-empty")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} ": \n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
             )})})
      }))
  }))
  
  ; sse/heartbeat test
  (test-async "sse/heartbeat -> ':\\n'" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" TEST_PORT "/heartbeat")
      (\ {resp} {
        (if (error? resp)
          {false}
          {(= {body} (http2/response-body resp))
           (= {expected} ":\n")
           (if (== body expected)
             {true}
             {(do
               (print "Expected:" expected)
               (print "Got:" body)
               false
             )})})
      }))
  })))
  {:suite-name "SSE Wire Format"})
