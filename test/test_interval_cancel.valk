; Test aio/interval cancellation functionality
; Verifies that aio/interval returns a handle and aio/cancel works

(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {aio} (aio/await (aio/start)))

(test/run-async aio (list
  (test-async "aio/interval returns a handle" (\ {} {
    (= {h} (aio/interval aio 100 (\ {} {nil})))
    (= {is-handle} (handle? h))
    (aio/cancel h)
    (aio/pure is-handle)
  }))

  (test-async "aio/cancel on interval returns :true" (\ {} {
    (= {h} (aio/interval aio 100 (\ {} {nil})))
    (aio/then (aio/sleep aio 50) (\ {_} {
      (== (aio/cancel h) :true)
    }))
  }))

  (test-async "aio/cancelled? returns :true after cancel" (\ {} {
    (= {h} (aio/interval aio 100 (\ {} {nil})))
    (aio/then (aio/sleep aio 50) (\ {_} {(do
      (aio/cancel h)
      (== (aio/cancelled? h) :true))
    }))
  }))

  (test-async "aio/status after cancel shows :cancelled" (\ {} {
    (= {h} (aio/interval aio 100 (\ {} {nil})))
    (aio/then (aio/sleep aio 50) (\ {_} {(do
      (aio/cancel h)
      (== (aio/status h) :cancelled))
    }))
  })))
  {:suite-name "aio/interval Cancellation Tests" :timeout-ms 1000})

(aio/stop aio)
