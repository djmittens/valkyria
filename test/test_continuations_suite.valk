; Continuation Test Suite
; Tests for shift/reset and continuation functionality

(load "src/prelude.valk")
(load "src/modules/test.valk")

; ============================================================================
; Basic Continuation Tests
; ============================================================================

(test/define "shift-reset-basic"
  {do
    (def {result} (async-reset {
      (async-shift {k} {(k 42)})
    }))
    (== result 42)
  })

(test/define "shift-reset-with-computation"
  {do
    (def {result} (async-reset {
      (def {x} (async-shift {k} {(k 10)}))
      (* x 2)
    }))
    (== result 20)
  })

(test/define "nested-shift-reset"
  {do
    (def {result} (async-reset {
      (def {x} (async-shift {k} {(k 5)}))
      (def {y} (async-shift {k} {(k 10)}))
      (+ x y)
    }))
    (== result 15)
  })

; ============================================================================
; Continuation Capture Tests
; ============================================================================

(test/define "continuation-captures-context"
  {do
    (def {add-async} (\ {x k} {(k (+ x 1))}))
    (def {result} (async-reset {
      (async-shift {k} {(add-async 41 k)})
    }))
    (== result 42)
  })

(test/define "continuation-sequential"
  {do
    (def {double} (\ {x k} {(k (* x 2))}))
    (def {result} (async-reset {
      (def {a} (async-shift {k} {(double 5 k)}))
      (def {b} (async-shift {k} {(double a k)}))
      b
    }))
    (== result 20)
  })

; ============================================================================
; Complex Continuation Tests
; ============================================================================

(test/define "continuation-with-lambda"
  {do
    (def {op} (\ {x} {
      (async-reset {
        (async-shift {k} {(k (* x 2))})
      })
    }))
    (def {result} (op 21))
    (== result 42)
  })

(test/define "continuation-preserves-bindings"
  {do
    (def {outer} 10)
    (def {result} (async-reset {
      (def {inner} 32)
      (async-shift {k} {(k (+ outer inner))})
    }))
    (== result 42)
  })

; Run all continuation tests
(test/run {})
