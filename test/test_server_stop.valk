; HTTP/2 Server Stop Tests
; Tests graceful server shutdown with http2/server-stop

(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {aio} (aio/start))

(def {simple-handler}
  (\ {req} {
    {:status "200" :body "OK"}
  }))

(test/run-async aio (list
  (test-async "server-stop completes successfully" (\ {done} {
  (= {server} (http2/server-listen aio 0 simple-handler))
  (= {port} (http2/server-port server))
  (= {stop-handle} (http2/server-stop server))
  (aio/then stop-handle (\ {result} {
    (done (nil? result))
  }))
}))
  (test-async "stopped server rejects new connections" (\ {done} {
  (= {server} (http2/server-listen aio 0 simple-handler))
  (= {port} (http2/server-port server))
  (= {stop-handle} (http2/server-stop server))
  (aio/then stop-handle (\ {_} {
    (http2/client-request aio "127.0.0.1" port "/"
      (\ {resp} {
        (done (error? resp))
      }))
  }))
}))
  (test-async "double stop is idempotent" (\ {done} {
  (= {server} (http2/server-listen aio 0 simple-handler))
  (= {port} (http2/server-port server))
  (= {stop-handle} (http2/server-stop server))
  (aio/then stop-handle (\ {_} {
    (= {stop-handle2} (http2/server-stop server))
    (aio/then stop-handle2 (\ {result2} {
      (done (nil? result2))
    }))
  }))
})))
  {:suite-name "HTTP/2 Server Stop Tests"})
