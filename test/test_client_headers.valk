(load "src/prelude.valk")

(def {TEST_PORT} 8501)
(def {aio} (aio/start))
(def {test-passed} 0)
(def {received-headers} nil)

(def {handler}
  (\ {req} {
    (= {path} (plist/get req :path))
    (= {headers} (plist/get req :headers))
    (def {received-headers} headers)
    (printf "Received headers: %s\n" (str headers))
    `{:status "200" :body "OK"}
  }))

(println "")
(println "=== Custom Headers Test ===")
(println "")
(printf "Starting server on port %d\n" TEST_PORT)
(http2/server-listen aio TEST_PORT handler)

(aio/schedule aio 100 (\ {} {
  (println "Requesting with custom headers...")
  (http2/client-request-with-headers aio "127.0.0.1" TEST_PORT "/test" 
    {{"x-custom-header" "test-value"} {"user-agent" "TestClient/1.0"}}
    (\ {resp} {
      (if (error? resp)
        {(printf "Error: %s\n" (str resp))}
        {(do
          (= {status} (http2/response-status resp))
          (printf "Response status: %s\n" status)
          (if (== status "200")
            {(def {test-passed} 1)}
            {nil}
          )
        )}
      )
    }))
}))

(aio/schedule aio 500 (\ {} {
  (println "")
  (printf "Received headers: %s\n" (str received-headers))
  (if (== test-passed 1)
    {(do
      (println "PASS: Custom headers test")
      (exit 0)
    )}
    {(do
      (println "FAIL: Custom headers test")
      (exit 1)
    )}
  )
}))

(aio/schedule aio 5000 (\ {} {
  (println "TIMEOUT!")
  (exit 1)
}))

(aio/run aio)
