; Custom Headers Test
; Tests sending custom headers with HTTP/2 client requests

(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {aio} (aio/await (aio/start)))

; Helper to find header value by name
(fun {get-header-value headers name}
  {if (nil? headers)
    {nil}
    {do
      (= {pair} (head headers))
      (if (== (head pair) name)
        {(head (tail pair))}
        {get-header-value (tail headers) name})}})

; Handler echoes back a specific header value in the body to verify it was received
(def {handler}
  (\ {req} {
    (= {headers} (req/headers req))
    (= {custom-val} (get-header-value headers "x-custom-header"))
    (list :status "200" :body (if (nil? custom-val) {"no-header"} {custom-val}))
  }))

(def {server} (http2/server-listen aio 0 handler))
(def {test-port} (http2/server-port server))

(test/run-async aio (list
  (test-async "custom headers are received by server" (\ {} {
    (aio/then (http2/client-request-with-headers aio "127.0.0.1" test-port "/test" 
      {{"x-custom-header" "test-value"} {"user-agent" "TestClient/1.0"}})
      (\ {resp} {
        (if (error? resp)
          {false}
          {(== (http2/response-body resp) "test-value")})
      }))
  })))
  {:suite-name "Client Headers Tests"})
