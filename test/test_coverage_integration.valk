(load "src/prelude.valk")
(load "src/modules/test.valk")

(test/run (list
  (test "if-both-branches"
    {do
    (fun {test-if x} {
      if (> x 0)
        {"positive"}
        {"non-positive"}
    })
    (test/assert-eq "positive" (test-if 5) "true branch")
    (test/assert-eq "non-positive" (test-if -1) "false branch")
    true
  })
  (test "nested-if-coverage"
    {do
    (fun {classify x} {
      if (> x 0)
        {if (> x 100)
          {"large"}
          {"small"}}
        {"non-positive"}
    })
    (test/assert-eq "large" (classify 200) "large path")
    (test/assert-eq "small" (classify 50) "small path")
    (test/assert-eq "non-positive" (classify -5) "non-positive path")
    true
  })
  (test "select-clause-coverage"
    {do
    (fun {day-type d} {
      select
        {(== d 0) "sunday"}
        {(== d 6) "saturday"}
        {otherwise "weekday"}
    })
    (test/assert-eq "sunday" (day-type 0) "sunday")
    (test/assert-eq "saturday" (day-type 6) "saturday")
    (test/assert-eq "weekday" (day-type 3) "weekday")
    true
  })
  (test "higher-order-coverage"
    {do
    (= {doubled} (map (\ {x} {* x 2}) {1 2 3}))
    (= {positives} (filter (\ {x} {> x 0}) {-1 0 1 2}))
    (test/assert-eq 3 (len doubled) "map result length")
    (test/assert-eq 2 (len positives) "filter result length")
    true
  })
  (test "recursive-coverage"
    {do
    (fun {factorial n} {
      if (<= n 1)
        {1}
        {* n (factorial (- n 1))}
    })
    (test/assert-eq 120 (factorial 5) "factorial 5")
    true
  })
  (test "do-block-coverage"
    {do
    (= {a} 1)
    (= {b} 2)
    (= {c} 3)
    (test/assert-eq 6 (+ a b c) "sum of three")
    true
  })
  (test "error-path-coverage"
    {do
    (fun {safe-div a b} {
      if (== b 0)
        {0}
        {/ a b}
    })
    (test/assert-eq 0 (safe-div 10 0) "div by zero handled")
    (test/assert-eq 5 (safe-div 10 2) "normal division")
    true
  }))
  {:suite-name "Coverage Integration Tests"})
