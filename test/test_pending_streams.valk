; Pending Streams Coverage Test  
; Tests that the server can handle multiple concurrent requests with limited arena pool.

(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {aio} (aio/start {
  :max-connections 16
  :tcp-buffer-pool-size 48
  :arena-pool-size 8
  :arena-size 1048576
  :pending-stream-pool-size 32
}))

(def {handler}
  (\ {req} {
    (= {path} (req/path req))
    (aio/then (aio/sleep aio 100) (\ {_} {
      {:status "200" :body (str "OK: " path)}
    }))
  }))

(def {server} (http2/server-listen aio 0 handler))
(def {test-port} (http2/server-port server))

(fun {send-request path} {
  (http2/client-request aio "127.0.0.1" test-port path)
})

(test/run-async aio (list
  (test-async "concurrent requests batch 1" (\ {} {
    (= {requests} (list
      (send-request "/stream1")
      (send-request "/stream2")
      (send-request "/stream3")
      (send-request "/stream4")))
    (aio/then (aio/all requests) (\ {results} {
      (= {completed} (foldl (\ {count r} {
        (if (not (error? r)) {(+ count 1)} {count})
      }) 0 results))
      (>= completed 2)
    }))
  }))
  (test-async "concurrent requests batch 2" (\ {} {
    (aio/then (aio/sleep aio 200) (\ {_} {
      (= {requests} (list
        (send-request "/stream5")
        (send-request "/stream6")
        (send-request "/stream7")
        (send-request "/stream8")))
      (aio/then (aio/all requests) (\ {results} {
        (= {completed} (foldl (\ {count r} {
          (if (not (error? r)) {(+ count 1)} {count})
        }) 0 results))
        (>= completed 2)
      }))
    }))
  })))
  {:suite-name "Pending Streams Coverage Tests"})
