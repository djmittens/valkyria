; Pending Streams Coverage Test  
; Tests that the server can handle multiple concurrent requests with limited arena pool.
; Some requests may fail due to resource limits, but the server should remain stable.

(load "src/prelude.valk")

(def {TEST_PORT} (net/get-available-port))

; Use adequate buffer pools for per-connection buffer model
; Each connection holds 1 read buffer until close, so we need 2 * max-connections
(def {aio} (aio/start {
  :max-connections 16
  :tcp-buffer-pool-size 48
  :arena-pool-size 8
  :arena-size 1048576
  :pending-stream-pool-size 32
}))

(def {requests-started} 0)
(def {requests-completed} 0)
(def {requests-errored} 0)

; Handler that sleeps briefly
(def {handler}
  (\ {req} {
    (= {path} (plist/get req :path))
    (aio/then (aio/sleep 100) (\ {_} {
      {:status "200" :body (str "OK: " path)}
    }))
  }))

(println "")
(println "=== Pending Streams Coverage Test ===")
(println "")
(printf "Config: tcp-buffer-pool-size=48, arena-pool-size=8, pending-stream-pool-size=32\n")
(printf "Starting server on port %d\n" TEST_PORT)
(http2/server-listen aio TEST_PORT handler)

; Helper to send a request and track completion
(fun {send-request path} {
  (def {requests-started} (+ requests-started 1))
  (http2/client-request aio "127.0.0.1" TEST_PORT path (\ {r} {
    (if (not (error? r)) 
      {(do (def {requests-completed} (+ requests-completed 1)) 
           (printf "  Request to %s completed (total: %d)\n" path requests-completed))}
      {(do (def {requests-errored} (+ requests-errored 1))
           (printf "  Request to %s error: %s\n" path (str r)))})
  }))
})

; Send 8 requests in phases
(aio/schedule aio 100 (\ {} {
  (println "")
  (println "Sending first batch of 4 requests...")
  (send-request "/stream1")
  (send-request "/stream2")
  (send-request "/stream3")
  (send-request "/stream4")
}))

(aio/schedule aio 200 (\ {} {
  (println "Sending second batch of 4 requests...")
  (send-request "/stream5")
  (send-request "/stream6")
  (send-request "/stream7")
  (send-request "/stream8")
}))

; Check results
(aio/schedule aio 3000 (\ {} {
  (println "")
  (println "=== Results ===")
  (printf "Requests started: %d\n" requests-started)
  (printf "Requests completed: %d\n" requests-completed)
  (printf "Requests errored: %d\n" requests-errored)
  
  ; Success if at least half the requests completed
  (if (>= requests-completed 4)
    {(do
      (println "")
      (println "PASS: Pending streams test completed - server handled concurrent load")
      (exit 0))}
    {(do
      (println "")
      (printf "FAIL: Only %d of 8 requests completed\n" requests-completed)
      (exit 1))})
}))

; Timeout
(aio/schedule aio 10000 (\ {} {
  (println "TIMEOUT!")
  (exit 1)
}))

(aio/run aio)
