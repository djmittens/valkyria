; Arena Out-of-Order Completion Test
; Tests that arena linked-list removal works when requests complete out of order
; Exercises: __http_remove_from_active_arenas traversal path

(load "src/prelude.valk")
(load "src/modules/test.valk")

(test/suite "Arena Out-of-Order Completion")

(def {aio} (aio/start))

(def {completed-slow} false)
(def {completed-medium} false)
(def {completed-fast} false)

(def {handler}
  (\ {req} {
    (= {path} (req/path req))
    (if (== path "/slow")
      {(aio/then (aio/sleep aio 100) (\ {_} {{:status "200" :body "slow"}}))}
      {(if (== path "/medium")
        {(aio/then (aio/sleep aio 50) (\ {_} {{:status "200" :body "medium"}}))}
        {(if (== path "/fast")
          {(aio/then (aio/sleep aio 10) (\ {_} {{:status "200" :body "fast"}}))}
          {{:status "200" :body "ok"}})})})
  }))

(def {server} (http2/server-listen aio 0 handler))
(def {TEST_PORT} (http2/server-port server))

(test/async "out-of-order arena removal works" (\ {done} {
  (http2/client-request aio "127.0.0.1" TEST_PORT "/slow" (\ {resp} {
    (if (and (not (error? resp)) (== (http2/response-body resp) "slow"))
      {(def {completed-slow} true)}
      {true})
  }))
  
  (http2/client-request aio "127.0.0.1" TEST_PORT "/medium" (\ {resp} {
    (if (and (not (error? resp)) (== (http2/response-body resp) "medium"))
      {(def {completed-medium} true)}
      {true})
  }))
  
  (http2/client-request aio "127.0.0.1" TEST_PORT "/fast" (\ {resp} {
    (if (and (not (error? resp)) (== (http2/response-body resp) "fast"))
      {(def {completed-fast} true)}
      {true})
  }))
  
  (aio/schedule aio 500 (\ {} {
    (done (and completed-slow (and completed-medium completed-fast)))
  }))
}))

(aio/schedule aio 100 (\ {} {
  (test/run-async aio)
}))

(aio/run aio)
