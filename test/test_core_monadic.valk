(load "src/prelude.valk")

(print "Testing core monadic operations")

; Test async-pure manually
(def {async-pure} (\ {value} {
  (\ {k} {(k value)})
}))

(def {run-async} (\ {async-op} {
  (async-reset {
    (async-shift {k} {(async-op k)})
  })
}))

(print "Test 1: async-pure")
(def {r1} (run-async (async-pure 42)))
(print "Result:" r1)

(print "Test 2: async-map-list")
(def {double-async} (\ {x k} {(k (* x 2))}))

(def {async-map-list} (\ {async-fn items} {
  (\ {k} {
    (def {process-items} (\ {remaining acc} {
      (if (== remaining ())
        {(k (reverse acc))}
        {(def {item} (head remaining))
         (def {rest} (tail remaining))
         (async-fn item (\ {result} {
           (process-items rest (join (list result) acc))
         }))})
    }))
    (process-items items ())
  })
}))

(def {r2} (run-async (async-map-list double-async (list 1 2 3))))
(print "Result:" r2)

(print "Done")
(shutdown 0)
