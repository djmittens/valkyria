; Test suite for aio/semaphore builtins
; Tests: aio/semaphore, aio/semaphore-acquire, aio/semaphore-release

(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {aio} (aio/start))

(test/run-async aio (list
  (test-async "aio/semaphore creates semaphore ref" (\ {done} {
    (= {sem} (aio/semaphore aio 3))
    (if (error? sem)
      {(do (print "Error:" sem) (done false))}
      {(done true)})
  }))

  (test-async "aio/semaphore-acquire immediate when permits available" (\ {done} {
    (= {sem} (aio/semaphore aio 2))
    (= {h1} (aio/semaphore-acquire sem))
    (= {status} (aio/status h1))
    (if (== status (quote :completed))
      {(do (aio/semaphore-release sem) (done true))}
      {(do (print "Expected :completed, got:" status) (done false))})
  }))

  (test-async "aio/semaphore-acquire returns :acquired symbol" (\ {done} {
    (= {sem} (aio/semaphore aio 1))
    (= {h} (aio/semaphore-acquire sem))
    (aio/then h (\ {result} {
      (aio/semaphore-release sem)
      (if (== result (quote :acquired))
        {(done true)}
        {(do (print "Expected :acquired, got:" result) (done false))})}))
  }))

  (test-async "aio/semaphore-release returns nil" (\ {done} {
    (= {sem} (aio/semaphore aio 1))
    (aio/semaphore-acquire sem)
    (= {result} (aio/semaphore-release sem))
    (if (nil? result)
      {(done true)}
      {(do (print "Expected nil, got:" result) (done false))})
  }))

  (test-async "aio/semaphore blocks when permits exhausted" (\ {done} {
    (= {sem} (aio/semaphore aio 1))
    (= {h1} (aio/semaphore-acquire sem))
    (= {h2} (aio/semaphore-acquire sem))
    (= {status1} (aio/status h1))
    (= {status2} (aio/status h2))
    (if (and (== status1 (quote :completed)) (== status2 (quote :running)))
      {(do (aio/semaphore-release sem) (done true))}
      {(do (print "Expected completed+running, got:" status1 status2) (done false))})
  }))

  (test-async "aio/semaphore-release wakes blocked waiter" (\ {done} {
    (= {sem} (aio/semaphore aio 1))
    (aio/semaphore-acquire sem)
    (= {h2} (aio/semaphore-acquire sem))
    (aio/semaphore-release sem)
    (aio/schedule aio 10 (\ {} {
      (= {status} (aio/status h2))
      (aio/semaphore-release sem)
      (if (== status (quote :completed))
        {(done true)}
        {(do (print "Expected :completed, got:" status) (done false))})}))
  }))

  (test-async "multiple waiters complete when released" (\ {done} {
    (= {sem} (aio/semaphore aio 1))
    (aio/semaphore-acquire sem)
    (= {h1} (aio/semaphore-acquire sem))
    (= {h2} (aio/semaphore-acquire sem))
    (= {s1-before} (aio/status h1))
    (= {s2-before} (aio/status h2))
    (aio/semaphore-release sem)
    (aio/semaphore-release sem)
    (aio/semaphore-release sem)
    (aio/schedule aio 10 (\ {} {
      (= {s1-after} (aio/status h1))
      (= {s2-after} (aio/status h2))
      (if (and (and (== s1-before (quote :running)) (== s2-before (quote :running)))
               (and (== s1-after (quote :completed)) (== s2-after (quote :completed))))
        {(done true)}
        {(do (print "Before:" s1-before s2-before "After:" s1-after s2-after) (done false))})}))
  }))

  (test-async "semaphore permits can be re-acquired after release" (\ {done} {
    (= {sem} (aio/semaphore aio 1))
    (= {h1} (aio/semaphore-acquire sem))
    (aio/semaphore-release sem)
    (= {h2} (aio/semaphore-acquire sem))
    (= {status} (aio/status h2))
    (aio/semaphore-release sem)
    (if (== status (quote :completed))
      {(done true)}
      {(do (print "Expected :completed, got:" status) (done false))})
  }))

  (test-async "semaphore with multiple permits" (\ {done} {
    (= {sem} (aio/semaphore aio 3))
    (= {h1} (aio/semaphore-acquire sem))
    (= {h2} (aio/semaphore-acquire sem))
    (= {h3} (aio/semaphore-acquire sem))
    (= {h4} (aio/semaphore-acquire sem))
    (= {s1} (aio/status h1))
    (= {s2} (aio/status h2))
    (= {s3} (aio/status h3))
    (= {s4} (aio/status h4))
    (aio/semaphore-release sem)
    (aio/semaphore-release sem)
    (aio/semaphore-release sem)
    (aio/semaphore-release sem)
    (if (and (and (== s1 (quote :completed)) (== s2 (quote :completed)))
             (and (== s3 (quote :completed)) (== s4 (quote :running))))
      {(done true)}
      {(do (print "Unexpected statuses:" s1 s2 s3 s4) (done false))})
  }))

  (test-async "aio/semaphore error: wrong arg count" (\ {done} {
    (= {result} (aio/semaphore aio))
    (if (error? result)
      {(done true)}
      {(do (print "Expected error, got:" result) (done false))})
  }))

  (test-async "aio/semaphore error: non-aio first arg" (\ {done} {
    (= {result} (aio/semaphore 42 1))
    (if (error? result)
      {(done true)}
      {(do (print "Expected error, got:" result) (done false))})
  }))

  (test-async "aio/semaphore error: non-number permits" (\ {done} {
    (= {result} (aio/semaphore aio "not-a-number"))
    (if (error? result)
      {(done true)}
      {(do (print "Expected error, got:" result) (done false))})
  }))

  (test-async "aio/semaphore error: zero permits" (\ {done} {
    (= {result} (aio/semaphore aio 0))
    (if (error? result)
      {(done true)}
      {(do (print "Expected error, got:" result) (done false))})
  }))

  (test-async "aio/semaphore-acquire error: non-semaphore arg" (\ {done} {
    (= {result} (aio/semaphore-acquire 42))
    (if (error? result)
      {(done true)}
      {(do (print "Expected error, got:" result) (done false))})
  }))

  (test-async "aio/semaphore-release error: non-semaphore arg" (\ {done} {
    (= {result} (aio/semaphore-release "not-a-sem"))
    (if (error? result)
      {(done true)}
      {(do (print "Expected error, got:" result) (done false))})
  }))

) {:suite-name "aio/semaphore tests"})
