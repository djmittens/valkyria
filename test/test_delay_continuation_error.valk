; test_delay_continuation_error.valk
; Tests that errors in aio/delay continuations are handled properly (return 500)

(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {aio} (aio/start))

(def {handler}
  (\ {req} {
    (= {path} (req/path req))
    (if (== path "/delay-err")
      {(aio/delay aio 50 (\ {} {
        (error "Error from aio/delay continuation")
      }))}
      {`{:status "200" :body "OK"}}
    )
  }))

(def {server} (http2/server-listen aio 0 handler))
(def {test-port} (http2/server-port server))

(test/run-async aio (list
  (test-async "error in aio/delay continuation returns 500" (\ {done} {
  (aio/then (http2/client-request aio "127.0.0.1" test-port "/delay-err")
    (\ {resp} {
      (if (error? resp)
        {(done false)}
        {do
          (= {status} (http2/response-status resp))
          (done (== status "500"))})
    }))
})))
  {:suite-name "aio/delay Continuation Error Tests"})
