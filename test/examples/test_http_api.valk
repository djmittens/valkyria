; Comprehensive HTTP API Test Suite
; Tests all components of the high-level HTTP API

(load "src/prelude.valk")
(load "src/http_api.valk")

(print "=== HTTP API Test Suite ===")
(print "")

; Test tracking
(def {passed} 0)
(def {failed} 0)

(def {assert-eq} (\ {name expected actual} {
  (if (== expected actual)
    {(do
       (print "✓" name)
       (= {passed} (+ passed 1)))}
    {(do
       (print "✗" name "- Expected:" expected "Got:" actual)
       (= {failed} (+ failed 1)))})
}))

(def {assert-not-nil} (\ {name value} {
  (if (!= value ())
    {(do
       (print "✓" name)
       (= {passed} (+ passed 1)))}
    {(do
       (print "✗" name "- Got nil")
       (= {failed} (+ failed 1)))})
}))

; ============================================================================
; PART 1: Request Creation Tests
; ============================================================================

(print "--- Request Creation ---")

; Test http-get
(def {get-req} (http-get "example.com"))
(assert-not-nil "http-get creates request" get-req)

; Test http-post
(def {post-req} (http-post "example.com" "test body"))
(assert-not-nil "http-post creates request" post-req)

; Test http-request
(def {custom-req} (http-request "PUT" "example.com"))
(assert-not-nil "http-request creates custom request" custom-req)

; Test with-header (should return request)
(def {req-with-header} (with-header get-req "x-custom" "value"))
(assert-not-nil "with-header returns request" req-with-header)

; Test with-headers
(def {headers-list} (list
  (list "x-foo" "bar")
  (list "x-baz" "qux")
))
(def {req-with-headers} (with-headers get-req headers-list))
(assert-not-nil "with-headers returns request" req-with-headers)

(print "")

; ============================================================================
; PART 2: Mock Response Tests (since we can't make real requests easily)
; ============================================================================

(print "--- Response Helpers (Mock Data) ---")

; Create mock response helper
(def {mock-response} (\ {status body} {
  ; This would normally come from http2/send-async
  ; For testing, we create a simple list structure
  (list
    (list "status" status)
    (list "body" body)
    (list "headers" ())
  )
}))

; Mock response extraction (simplified for testing)
(def {mock-response-status} (\ {resp} {
  (head (tail (head resp)))
}))

(def {mock-response-body} (\ {resp} {
  (head (tail (head (tail resp))))
}))

; Test response helpers with mock
(def {mock-resp} (mock-response 200 "Hello World"))
(assert-eq "mock-response-status extracts status" 200 (mock-response-status mock-resp))
(assert-eq "mock-response-body extracts body" "Hello World" (mock-response-body mock-resp))

; Test response-ok logic
(def {is-200-ok} (if (>= 200 200) {(< 200 300)} {0}))
(assert-eq "response-ok logic for 200" 1 is-200-ok)

(def {is-404-ok} (if (>= 404 200) {(< 404 300)} {0}))
(assert-eq "response-ok logic for 404" 0 is-404-ok)

(def {is-500-ok} (if (>= 500 200) {(< 500 300)} {0}))
(assert-eq "response-ok logic for 500" 0 is-500-ok)

(print "")

; ============================================================================
; PART 3: Middleware Tests
; ============================================================================

(print "--- Middleware Composition ---")

; Test with-auth
(def {auth-mw} (with-auth "Bearer token123"))
(def {authed-req} (auth-mw get-req))
(assert-not-nil "with-auth middleware creates function" auth-mw)
(assert-not-nil "with-auth applies to request" authed-req)

; Test with-user-agent
(def {ua-mw} (with-user-agent "CustomAgent/2.0"))
(def {ua-req} (ua-mw get-req))
(assert-not-nil "with-user-agent middleware creates function" ua-mw)
(assert-not-nil "with-user-agent applies to request" ua-req)

; Test middleware composition
(def {combined-mw} (compose-middleware (list
  (with-auth "Bearer token")
  (with-user-agent "TestAgent/1.0")
)))
(def {combined-req} (combined-mw get-req))
(assert-not-nil "compose-middleware combines multiple middleware" combined-mw)
(assert-not-nil "combined middleware applies to request" combined-req)

(print "")

; ============================================================================
; PART 4: Async Operations Tests
; ============================================================================

(print "--- Async HTTP Operations ---")

; Test that fetch returns an async operation (function)
(def {fetch-op} (fetch "example.com"))
(assert-not-nil "fetch returns async operation" fetch-op)

; Test fetch-text composition
(def {fetch-text-op} (fetch-text "example.com"))
(assert-not-nil "fetch-text returns async operation" fetch-text-op)

; Test fetch-ok composition
(def {fetch-ok-op} (fetch-ok "example.com"))
(assert-not-nil "fetch-ok returns async operation" fetch-ok-op)

; Test http-fetch-async creates async operation
(def {fetch-async-op} (http-fetch-async "example.com" get-req))
(assert-not-nil "http-fetch-async returns async operation" fetch-async-op)

(print "")

; ============================================================================
; PART 5: Batch Operations Tests
; ============================================================================

(print "--- Batch Operations ---")

; Test fetch-all creates async operation
(def {urls} (list "example.com" "google.com" "github.com"))
(def {fetch-all-op} (fetch-all urls))
(assert-not-nil "fetch-all returns async operation" fetch-all-op)

; Test fetch-all-text creates async operation
(def {fetch-all-text-op} (fetch-all-text urls))
(assert-not-nil "fetch-all-text returns async operation" fetch-all-text-op)

; Test health-check
(def {health-op} (health-check "example.com"))
(assert-not-nil "health-check returns async operation" health-op)

; Test health-check-all
(def {health-all-op} (health-check-all urls))
(assert-not-nil "health-check-all returns async operation" health-all-op)

(print "")

; ============================================================================
; PART 6: Pattern Tests
; ============================================================================

(print "--- Common Patterns ---")

; Create mock async operations for testing patterns
(def {mock-async-1} (async-pure 42))
(def {mock-async-2} (async-pure 100))
(def {mock-async-3} (async-pure 200))

; Test parallel
(def {parallel-op} (parallel (list mock-async-1 mock-async-2 mock-async-3)))
(assert-not-nil "parallel returns async operation" parallel-op)

; Test sequential
(def {sequential-op} (sequential (list mock-async-1 mock-async-2 mock-async-3)))
(assert-not-nil "sequential returns async operation" sequential-op)

; Test parallel execution and collection
(def {parallel-result} (run-async parallel-op))
(assert-eq "parallel collects results" (list 42 100 200) parallel-result)

; Test sequential execution
(def {sequential-result} (run-async sequential-op))
(assert-eq "sequential returns last result" 200 sequential-result)

(print "")

; ============================================================================
; PART 7: Route Matching Tests
; ============================================================================

(print "--- Route Matching ---")

; Test route-matches
(assert-eq "route-matches exact match" 1 (route-matches "/api/users" "/api/users"))
(assert-eq "route-matches no match" 0 (route-matches "/api/users" "/api/posts"))

; Test route finding
(def {routes} (list
  (list "GET" "/api/users" "handler1")
  (list "POST" "/api/users" "handler2")
  (list "GET" "/api/posts" "handler3")
))

(def {found-route} (find-route routes "GET" "/api/users"))
(assert-not-nil "find-route finds matching route" found-route)

(print "")

; ============================================================================
; PART 8: Error Handling Tests
; ============================================================================

(print "--- Error Handling ---")

; Test async-try creates async operation
(def {try-op} (async-try mock-async-1 (\ {err} {(async-pure 0)})))
(assert-not-nil "async-try returns async operation" try-op)

; Test async-or-default
(def {default-op} (async-or-default mock-async-1 999))
(assert-not-nil "async-or-default returns async operation" default-op)

; Test that successful operation returns value
(def {try-result} (run-async try-op))
(assert-eq "async-try passes through success" 42 try-result)

(print "")

; ============================================================================
; PART 9: Integration Tests with Mock Async Operations
; ============================================================================

(print "--- Integration Tests ---")

; Simulate fetch operation with mock
(def {mock-fetch} (\ {url} {
  (async-pure (mock-response 200 "Mock response body"))
}))

; Test fetch-like operation
(def {mock-fetch-result} (run-async (mock-fetch "test.com")))
(assert-eq "mock fetch returns response" 200 (mock-response-status mock-fetch-result))

; Test chaining with async-bind
(def {chained-op} (async-bind (mock-fetch "test.com") (\ {resp} {
  (async-pure (mock-response-status resp))
})))
(def {chained-result} (run-async chained-op))
(assert-eq "chained fetch extracts status" 200 chained-result)

; Test multiple chained operations
(def {multi-chain} (async-bind (mock-fetch "test.com") (\ {resp1} {
  (async-bind (mock-fetch "test2.com") (\ {resp2} {
    (async-pure (list
      (mock-response-status resp1)
      (mock-response-status resp2)
    ))
  }))
})))
(def {multi-result} (run-async multi-chain))
(assert-eq "multi-chain combines results" (list 200 200) multi-result)

; Test aggregate pattern with mocks
(def {mock-urls} (list "a.com" "b.com" "c.com"))
(def {mock-fetches} (map mock-fetch mock-urls))
(def {aggregate-op} (async-collect mock-fetches))
(def {aggregate-result} (run-async aggregate-op))
(assert-eq "aggregate collects all responses" 3 (len aggregate-result))

(print "")

; ============================================================================
; PART 10: Pipeline Tests
; ============================================================================

(print "--- Request/Response Pipelines ---")

; Test request transformation pipeline
(def {transform-request} (\ {req} {
  (def {step1} (with-header req "x-step" "1"))
  (def {step2} (with-header step1 "x-step" "2"))
  step2
}))

(def {transformed} (transform-request get-req))
(assert-not-nil "request pipeline transforms request" transformed)

; Test response transformation pipeline
(def {transform-response} (\ {resp} {
  (def {status} (mock-response-status resp))
  (def {body} (mock-response-body resp))
  (list status body)
}))

(def {transformed-resp} (transform-response mock-resp))
(assert-eq "response pipeline extracts data" (list 200 "Hello World") transformed-resp)

; Test async pipeline with async-pipe
(def {double-async} (\ {x} {(\ {k} {(k (* x 2))})}))
(def {add-ten-async} (\ {x} {(\ {k} {(k (+ x 10))})}))

(def {pipeline} (async-pipe 5 (list double-async add-ten-async)))
(def {pipeline-result} (run-async pipeline))
(assert-eq "async-pipe chains transformations" 20 pipeline-result)

(print "")

; ============================================================================
; Test Summary
; ============================================================================

(print "")
(print "=== Test Results ===")
(print "Passed:" passed)
(print "Failed:" failed)

(if (== failed 0)
  {(print "✨ All tests passed! ✨")}
  {(print "⚠ Some tests failed")})

(shutdown 0)
