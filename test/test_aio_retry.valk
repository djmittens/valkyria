; Test suite for aio/retry combinator
; Tests: aio/retry retries async operations with backoff

(load "src/prelude.valk")
(load "src/modules/test.valk")

(test/run (list
  (test "aio/retry succeeds on first attempt"
    {do
    (def {sys} (aio/start))
    (def {h} (aio/retry sys
      (\ {} {(aio/pure 42)})
      {:max-attempts 3 :backoff :exponential :base-ms 10}))
    (aio/stop sys)
    (== (aio/status h) (quote :completed))
    })
  (test "aio/retry fails after max attempts"
    {do
    (def {sys} (aio/start))
    (def {attempt-count} (atom 0))
    (def {h} (aio/retry sys
      (\ {} {
        (atom/add! attempt-count 1)
        (aio/fail "test error")
      })
      {:max-attempts 3 :backoff :exponential :base-ms 10}))
    (aio/stop sys)
    (== (atom/get attempt-count) 3)
    })
  (test "aio/retry returns handle that completes"
    {do
    (def {sys} (aio/start))
    (def {h} (aio/retry sys
      (\ {} {(aio/pure 99)})
      {:max-attempts 2 :backoff :linear :base-ms 10}))
    (aio/stop sys)
    (def {status} (aio/status h))
    (or (== status (quote :running)) (== status (quote :completed)))
    })
  (test "aio/retry with exponential backoff"
    {do
    (def {sys} (aio/start))
    (def {h} (aio/retry sys
      (\ {} {(aio/pure 1)})
      {:max-attempts 3 :backoff :exponential :base-ms 5}))
    (aio/stop sys)
    (== (aio/status h) (quote :completed))
    })
  (test "aio/retry with linear backoff"
    {do
    (def {sys} (aio/start))
    (def {h} (aio/retry sys
      (\ {} {(aio/pure 1)})
      {:max-attempts 3 :backoff :linear :base-ms 5}))
    (aio/stop sys)
    (== (aio/status h) (quote :completed))
    })
  (test "aio/retry with no backoff"
    {do
    (def {sys} (aio/start))
    (def {h} (aio/retry sys
      (\ {} {(aio/pure 1)})
      {:max-attempts 3 :backoff :none :base-ms 5}))
    (aio/stop sys)
    (== (aio/status h) (quote :completed))
    })
  (test "aio/retry returns failed result on exhaustion"
    {do
    (def {sys} (aio/start))
    (def {h} (aio/retry sys
      (\ {} {(aio/fail "persistent error")})
      {:max-attempts 2 :backoff :none :base-ms 5}))
    (aio/stop sys)
    (== (aio/status h) (quote :failed))
    }))
  {:suite-name "aio/retry Tests"})
