; Test suite for aio/retry combinator
; Tests: aio/retry retries async operations with backoff

(load "src/prelude.valk")
(load "src/modules/test.valk")

(test/run (list
  (test "aio/retry returns a handle"
    {do
    (def {sys} (aio/await (aio/start)))
    (def {h} (aio/retry sys
      (\ {} {(aio/pure 42)})
      {:max-attempts 3 :backoff :exponential :base-ms 10}))
    (aio/stop sys)
    (not (== h nil))
    })
  (test "aio/retry with exponential backoff"
    {do
    (def {sys} (aio/await (aio/start)))
    (def {h} (aio/retry sys
      (\ {} {(aio/pure 1)})
      {:max-attempts 3 :backoff :exponential :base-ms 5}))
    (aio/stop sys)
    (def {status} (aio/status h))
    (not (== status nil))
    })
  (test "aio/retry with linear backoff"
    {do
    (def {sys} (aio/await (aio/start)))
    (def {h} (aio/retry sys
      (\ {} {(aio/pure 1)})
      {:max-attempts 3 :backoff :linear :base-ms 5}))
    (aio/stop sys)
    (def {status} (aio/status h))
    (not (== status nil))
    })
  (test "aio/retry with no backoff"
    {do
    (def {sys} (aio/await (aio/start)))
    (def {h} (aio/retry sys
      (\ {} {(aio/pure 1)})
      {:max-attempts 3 :backoff :none :base-ms 5}))
    (aio/stop sys)
    (def {status} (aio/status h))
    (not (== status nil))
    }))
  {:suite-name "aio/retry Tests"})
