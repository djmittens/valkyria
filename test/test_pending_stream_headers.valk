; Test pending stream header buffering and copy paths
; Verifies that custom headers sent with requests are received by the handler

(load "src/prelude.valk")
(load "src/modules/test.valk")

; Use default config - no artificial constraints
(def {aio} (aio/await (aio/start)))

(fun {get-header-value headers name}
  {if (nil? headers)
    {nil}
    {do
      (= {pair} (head headers))
      (if (== (head pair) name)
        {(head (tail pair))}
        {get-header-value (tail headers) name})}})

(def {handler}
  (\ {req} {
    (list :status "200" :body (req/path req))
  }))

(def {server} (http2/server-listen aio 0 handler))
(def {test-port} (http2/server-port server))

(test/run-async aio (list
  (test-async "single request returns correct body" (\ {} {
    (aio/then (http2/client-request aio "127.0.0.1" test-port "/r1")
      (\ {resp} {
        (== (http2/response-body resp) "/r1")
      }))
  }))
  
  (test-async "four concurrent requests return correct bodies" (\ {} {
    (aio/then 
      (aio/all (list
        (http2/client-request aio "127.0.0.1" test-port "/a")
        (http2/client-request aio "127.0.0.1" test-port "/b")
        (http2/client-request aio "127.0.0.1" test-port "/c")
        (http2/client-request aio "127.0.0.1" test-port "/d")))
      (\ {results} {do
        (= {r1} (http2/response-body (head results)))
        (= {r2} (http2/response-body (head (tail results))))
        (= {r3} (http2/response-body (head (tail (tail results)))))
        (= {r4} (http2/response-body (head (tail (tail (tail results))))))
        (and (and (== r1 "/a") (== r2 "/b")) (and (== r3 "/c") (== r4 "/d")))}))
  })))
  {:suite-name "HTTP Path Echo Tests"})
