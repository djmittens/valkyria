(load "src/prelude.valk")
(load "src/modules/test.valk")

(def {aio} (aio/await (aio/start)))

; Start a simple server
(def {server-handler} (\ {req} {
  `{:status "200" :body "OK"}
}))
(def {server} (http2/server-listen aio 0 server-handler))
(def {test-port} (http2/server-port server))
(printf "Server started on port %d\n" test-port)

(printf "Making request\n")
(def {h} (http2/client-request aio "127.0.0.1" test-port "/"))
(printf "Got handle\n")

(aio/then h (\ {resp} {
  (printf "Response: %s\n" (http2/response-status resp))
  (aio/stop aio)
}))

(printf "About to run\n")
(aio/run aio)
(printf "Done\n")
