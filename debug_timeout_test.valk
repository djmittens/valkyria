; Debug timeout test to see what's happening
(load "src/prelude.valk")

; time/now - returns current time in milliseconds
(fun {time/now} {/ (time-us) 1000})

(def {sys} (aio/start))
(def {start-time} (time/now))

; Create slow operation (100ms sleep) with short timeout (10ms) - should timeout in ~10ms
(def {timeout-handle} (aio/within (aio/sleep sys 100) 10))

; Wait synchronously for completion
(aio/wait timeout-handle)

(def {end-time} (time/now))
(def {elapsed-ms} (- end-time start-time))

; Check results
(def {status} (aio/status timeout-handle))
(def {error} (aio/error timeout-handle))

(aio/stop sys)

; Debug output
(printf "Start time: %f ms\n" start-time)
(printf "End time: %f ms\n" end-time)
(printf "Elapsed: %f ms\n" elapsed-ms)
(printf "Status: %s\n" status)
(printf "Error: %s\n" error)
(printf "Test conditions:\n")
(printf "  Status is :failed? %s\n" (if (== status (quote :failed)) "YES" "NO"))
(printf "  Error is :timeout? %s\n" (if (== error (quote :timeout)) "YES" "NO"))
(printf "  Elapsed > 8ms? %s (%f > 8)\n" (if (> elapsed-ms 8) "YES" "NO") elapsed-ms)
(printf "  Elapsed < 50ms? %s (%f < 50)\n" (if (< elapsed-ms 50) "YES" "NO") elapsed-ms)