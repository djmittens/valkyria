
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <header role="banner" aria-label="Dashboard header">
    <div class="logo">
      <div class="logo-icon" aria-hidden="true">V</div>
      <div class="logo-text">Valkyria <span>Dashboard</span></div>
    </div>
    <div class="status-badge" role="status" aria-live="polite" id="global-status" title="Dashboard connection status. Green indicates live metrics streaming. Red indicates connection failure - metrics may be stale.">
      <span class="pulse" aria-hidden="true"></span>
      <span class="status-icon" aria-hidden="true">✓</span>
      <span id="global-status-text">Connecting...</span>
    </div>
    <div class="header-right">
      <div class="header-stat" title="Time since the Valkyria process started. Use to correlate with deployment times or restarts.">
        <div class="header-stat-label">Uptime</div>
        <div class="header-stat-value" id="uptime-value">--</div>
      </div>
      <div class="header-stat" title="Time of last successful metrics fetch. If stale, check network connectivity to the server.">
        <div class="header-stat-label">Last Update</div>
        <div class="header-stat-value" id="timestamp" aria-live="polite">--:--:--</div>
      </div>
    </div>
  </header>

  <main role="main" id="main-content">

    <!-- Error Banner (hidden by default) -->
    <div class="error-banner" role="alert" aria-live="assertive" id="error-banner">
      <span class="error-banner-icon" aria-hidden="true">⚠</span>
      <span class="error-banner-text" id="error-text">Connection lost. Metrics may be stale.</span>
      <button class="error-banner-dismiss" onclick="dismissError()" aria-label="Dismiss">×</button>
    </div>

    <!-- SSE Disconnection Warning -->
    <div class="sse-status-warning" id="sse-warning" role="alert">
      <span>Memory diagnostics stream disconnected. Last update: <span id="sse-last-update">--</span></span>
    </div>

    <!-- Capacity Warning Banner -->
    <div class="capacity-warning-banner" id="capacity-warning-banner" role="alert" aria-live="polite">
      <span class="capacity-warning-icon" aria-hidden="true">!</span>
      <span class="capacity-warning-text">Memory pool(s) approaching capacity</span>
    </div>

    <!-- ==================== HEALTH OVERVIEW (Compact Bar) ==================== -->
    <section class="health-bar-compact" aria-label="System health metrics">
      <div class="health-metric" title="Requests per second across all HTTP servers">
        <div class="health-metric-spark" id="spark-request-rate"></div>
        <span class="health-metric-label">Req/s</span>
        <span class="health-metric-value" id="health-request-rate">--</span>
      </div>
      <div class="health-divider"></div>
      <div class="health-metric" title="Error rate (4xx + 5xx responses)">
        <div class="health-metric-spark" id="spark-error-rate"></div>
        <span class="health-metric-label">Err</span>
        <span class="health-metric-value" id="health-error-rate">--</span>
        <span class="health-metric-unit">%</span>
      </div>
      <div class="health-divider"></div>
      <div class="health-metric" title="Average response latency">
        <div class="health-metric-spark" id="spark-latency"></div>
        <span class="health-metric-label">Lat</span>
        <span class="health-metric-value" id="health-avg-latency">--</span>
        <span class="health-metric-unit">ms</span>
      </div>
      <div class="health-divider"></div>
      <div class="health-metric" title="GC heap memory utilization">
        <div class="health-metric-spark" id="spark-heap"></div>
        <span class="health-metric-label">Heap</span>
        <span class="health-metric-value" id="health-heap-pct">--</span>
        <span class="health-metric-unit">%</span>
      </div>
    </section>

    <!-- ==================== VM METRICS ==================== -->
    <section class="section-group vm-section" aria-labelledby="vm-section-title">
      <div class="section-header">
        <div class="section-icon vm" aria-hidden="true">VM</div>
        <h2 class="section-title" id="vm-section-title">Virtual Machine</h2>
        <span class="section-subtitle">Interpreter, GC, and Memory</span>
        <div class="section-badges" aria-label="Section status">
          <span class="section-badge" id="vm-gc-badge">-- cycles</span>
          <span class="section-badge" id="vm-heap-badge">-- heap</span>
        </div>
      </div>

      <div class="grid-2">
        <!-- GC Panel with collapse support -->
        <article class="panel" aria-labelledby="gc-panel-title" id="gc-panel">
          <div class="panel-header" onclick="togglePanel('gc-panel')" role="button" tabindex="0" aria-expanded="true">
            <div class="panel-icon gc" aria-hidden="true">G</div>
            <h3 class="panel-title" id="gc-panel-title">Garbage Collector</h3>
            <span class="panel-summary" id="gc-summary">-- cycles, --ms max</span>
            <div class="panel-badge" id="gc-cycles-badge" title="Total number of GC cycles since process start">-- cycles</div>
            <span class="expand-icon" aria-hidden="true">▼</span>
          </div>
          <div class="panel-body">
            <div class="gc-timeline" id="gc-timeline" role="img" aria-label="GC pause timeline" title="Timeline showing GC pause durations over the last 60 seconds. Tall bars indicate long stop-the-world pauses that may cause request latency spikes. Yellow bars exceed 10ms, red bars exceed 50ms.">
              <div class="gc-timeline-threshold" style="bottom: 40px;">
                <span class="gc-timeline-threshold-label">10ms</span>
              </div>
              <div class="gc-timeline-axis">
                <span>-60s</span>
                <span>-45s</span>
                <span>-30s</span>
                <span>-15s</span>
                <span>now</span>
              </div>
            </div>
            <div class="gc-stats" role="list" aria-label="GC statistics">
              <div class="gc-stat" role="listitem" title="Total GC cycles since process start. Rapidly increasing cycle count indicates high allocation rate or memory pressure. Compare with heap usage to assess GC efficiency.">
                <div class="gc-stat-value" id="gc-cycles">--</div>
                <div class="gc-stat-label">Cycles</div>
              </div>
              <div class="gc-stat" role="listitem" title="Longest single GC pause observed. Pauses >10ms impact P99 latency. Pauses >100ms may cause connection timeouts. Reduce by lowering heap size or optimizing allocation patterns.">
                <div class="gc-stat-value" id="gc-max-pause">--<span class="unit">ms</span></div>
                <div class="gc-stat-label">Max Pause</div>
              </div>
              <div class="gc-stat" role="listitem" title="Average GC pause duration. Should stay under 5ms for low-latency services. If avg is high but max is similar, GC is consistently slow - consider heap tuning.">
                <div class="gc-stat-value" id="gc-avg-pause">--<span class="unit">ms</span></div>
                <div class="gc-stat-label">Avg Pause</div>
              </div>
              <div class="gc-stat" role="listitem" title="Total memory freed by GC. High reclaim rate with stable heap indicates healthy turnover. Low reclaim with growing heap suggests memory leak - investigate long-lived allocations.">
                <div class="gc-stat-value" id="gc-reclaimed">--<span class="unit">MB</span></div>
                <div class="gc-stat-label">Reclaimed</div>
              </div>
            </div>
          </div>
        </article>

        <!-- Interpreter with collapse support -->
        <article class="panel" aria-labelledby="interp-panel-title" id="interp-panel">
          <div class="panel-header" onclick="togglePanel('interp-panel')" role="button" tabindex="0" aria-expanded="true">
            <div class="panel-icon interp" aria-hidden="true">I</div>
            <h3 class="panel-title" id="interp-panel-title">Interpreter</h3>
            <span class="panel-summary" id="interp-summary">-- evals, -- fn calls</span>
            <span class="expand-icon" aria-hidden="true">▼</span>
          </div>
          <div class="panel-body">
            <div class="metrics-inline">
              <span class="metric-inline" title="Total expression evaluations">
                <span class="metric-inline-label">Evals:</span>
                <span class="metric-inline-value" id="interp-evals">--</span>
              </span>
              <span class="metric-inline-sep">│</span>
              <span class="metric-inline" title="User-defined function calls">
                <span class="metric-inline-label">Fn:</span>
                <span class="metric-inline-value" id="interp-fn-calls">--</span>
              </span>
              <span class="metric-inline-sep">│</span>
              <span class="metric-inline" title="Built-in function calls">
                <span class="metric-inline-label">Builtin:</span>
                <span class="metric-inline-value" id="interp-builtins">--</span>
              </span>
              <span class="metric-inline-sep">│</span>
              <span class="metric-inline" title="Max call stack depth">
                <span class="metric-inline-label">Stack:</span>
                <span class="metric-inline-value" id="interp-stack-depth">--</span>
              </span>
              <span class="metric-inline-sep">│</span>
              <span class="metric-inline" title="Closures created">
                <span class="metric-inline-label">Closures:</span>
                <span class="metric-inline-value" id="interp-closures">--</span>
              </span>
              <span class="metric-inline-sep">│</span>
              <span class="metric-inline" title="Environment lookups">
                <span class="metric-inline-label">Lookups:</span>
                <span class="metric-inline-value" id="interp-env-lookups">--</span>
              </span>
            </div>
          </div>
        </article>
      </div>

      <!-- VM Memory (Consolidated) -->
      <div class="subsection-header">
        <h3 class="subsection-title">VM Memory</h3>
        <div class="section-badges">
          <span class="section-badge">
            <span class="sse-dot"></span> Live
          </span>
        </div>
      </div>

      <div class="vm-memory-consolidated">
        <!-- Scratch Arena -->
        <div class="memory-block scratch-block">
          <div class="memory-block-header">
            <div class="memory-block-title">
              <span class="memory-icon scratch">S</span>
              Scratch Arena
            </div>
            <div class="memory-block-summary">
              <span class="pct" id="scratch-pct">0%</span>
              <span class="usage-detail" id="scratch-usage">0B / 0B</span>
            </div>
          </div>
          <div class="memory-block-body">
            <div class="arena-gauge" data-arena="scratch"
                 role="progressbar"
                 aria-valuenow="0"
                 aria-valuemin="0"
                 aria-valuemax="100"
                 aria-label="Scratch Arena: 0% used">
              <div class="arena-track">
                <div class="arena-bar healthy" style="width: 0%;"></div>
                <div class="arena-hwm" style="left: 0%;"></div>
              </div>
            </div>
            <div class="memory-legend-inline">
              <div class="legend-item"><div class="legend-dot hwm"></div><span>HWM: <span id="scratch-hwm">--</span></span></div>
              <div class="legend-item" id="scratch-overflow-item" style="display:none"><span class="overflow-label">Overflow: <span id="scratch-overflow">0</span></span></div>
            </div>
          </div>
        </div>

        <!-- GC Heap (LVAL Slab) -->
        <div class="memory-block gc-heap-block">
          <div class="memory-block-header">
            <div class="memory-block-title">
              <span class="memory-icon gc">GC</span>
              GC Heap (LVAL Objects)
            </div>
            <div class="memory-block-summary">
              <span class="usage-pct" id="heap-gauge-value">--</span>% used
              <span class="usage-detail">(<span id="heap-used">--</span> / <span id="heap-total">--</span>)</span>
            </div>
          </div>
          <div class="memory-block-body">
            <div class="slab-with-legend">
              <div class="memory-slab-panel wide" id="lval-panel">
                <div class="slab-header">
                  <span class="slab-name">LVAL Slab</span>
                  <span class="slab-type-badge">Slab</span>
                  <span class="slab-badge">0% used</span>
                </div>
                <div class="slab-canvas">
                  <div class="slab-grid" id="lval-grid"
                       role="img"
                       aria-label="LVAL Object Slab: loading..."
                       aria-live="polite"></div>
                </div>
                <div class="slab-stats">
                  <span><span class="used-count">0</span> / 262,144 slots</span>
                  <span class="overflow-warning" style="display:none"></span>
                </div>
              </div>
              <!-- Inline legend for this visualization -->
              <div class="memory-legend-inline">
                <div class="legend-item"><div class="legend-dot free"></div><span>Free</span></div>
                <div class="legend-item"><div class="legend-dot used"></div><span>Used</span></div>
                <div class="legend-item"><div class="legend-dot flash"></div><span>Changed</span></div>
              </div>
            </div>
            <!-- Heap details -->
            <div class="heap-details-row">
              <div class="heap-gauge-mini" role="img" aria-label="Heap memory usage" title="Visual gauge of heap utilization. Yellow zone (70-90%) indicates GC pressure. Red zone (>90%) indicates critical memory pressure with risk of OOM.">
                <svg viewBox="0 0 100 100" aria-hidden="true">
                  <circle class="gauge-bg" cx="50" cy="50" r="40"/>
                  <circle class="gauge-threshold warning" cx="50" cy="50" r="40"
                          stroke-dasharray="251.2" stroke-dashoffset="75.4"/>
                  <circle class="gauge-threshold critical" cx="50" cy="50" r="40"
                          stroke-dasharray="251.2" stroke-dashoffset="25.1"/>
                  <circle class="gauge-fill" id="heap-gauge-fill" cx="50" cy="50" r="40"
                          stroke-dasharray="251.2" stroke-dashoffset="251.2"/>
                </svg>
              </div>
              <div class="heap-metrics">
                <div class="metric-row" title="Cumulative memory freed by GC since process start. Compare rate of reclamation vs allocation to assess memory efficiency.">
                  <span class="metric-label">Reclaimed</span>
                  <span class="metric-value" id="heap-reclaimed">--</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== AIO SYSTEMS ==================== -->
    <!-- Phase 2: HTTP Servers and Clients are now nested under their parent AIO system -->
    <section class="section-group aio-section" aria-labelledby="aio-section-title">
      <div class="section-header">
        <div class="section-icon aio" aria-hidden="true">AIO</div>
        <h2 class="section-title" id="aio-section-title">Async I/O System</h2>
        <span class="section-subtitle">Event Loop, Resources, Servers & Clients</span>
        <div class="section-badges">
          <span class="section-badge" id="aio-systems-badge" title="Number of independent AIO event loop systems. Each system has its own connection pool and buffers.">-- systems</span>
          <span class="section-badge" id="aio-conns-badge" title="Total active connections across all AIO systems. High connection count may indicate connection leaks or slow clients.">-- conns</span>
          <span class="section-badge" id="http-servers-count" title="Number of HTTP server endpoints listening for requests.">-- servers</span>
          <span class="section-badge" id="http-total-rate" title="Combined request rate across all HTTP servers.">-- req/s</span>
        </div>
      </div>

      <div id="aio-systems-container">
        <!-- AIO system panels will be dynamically populated here -->
        <!-- Each panel now contains: Event Loop, Shared Pools, HTTP Servers, HTTP Clients -->
        <div class="panel" id="aio-no-systems">
          <div class="panel-body" style="text-align: center; color: var(--text-muted); padding: var(--space-xl);">
            No AIO systems registered
          </div>
        </div>
      </div>
    </section>

  </main>
  <script>
