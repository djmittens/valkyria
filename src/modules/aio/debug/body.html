
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <header role="banner" aria-label="Dashboard header">
    <div class="header-left">
      <div class="logo">
        <div class="logo-icon" aria-hidden="true">V</div>
        <div class="logo-text">Valkyria <span>Dashboard</span></div>
      </div>
      <div class="status-indicator" role="status" aria-live="polite" id="global-status" title="Connection status">
        <span class="status-dot" aria-hidden="true"></span>
      </div>
    </div>
    <div class="header-metrics" aria-label="System health metrics">
      <div class="header-metric" title="Requests per second">
        <div class="header-metric-spark" id="spark-request-rate"></div>
        <span class="header-metric-value" id="health-request-rate">--</span>
        <span class="header-metric-label">req/s</span>
      </div>
      <div class="header-metric" title="Error rate">
        <div class="header-metric-spark" id="spark-error-rate"></div>
        <span class="header-metric-value" id="health-error-rate">--</span>
        <span class="header-metric-label">% err</span>
      </div>
      <div class="header-metric" title="Average latency">
        <div class="header-metric-spark" id="spark-latency"></div>
        <span class="header-metric-value" id="health-avg-latency">--</span>
        <span class="header-metric-label">ms</span>
      </div>
      <div class="header-metric" title="Heap usage">
        <div class="header-metric-spark" id="spark-heap"></div>
        <span class="header-metric-value" id="health-heap-pct">--</span>
        <span class="header-metric-label">% heap</span>
      </div>
    </div>
  </header>

  <main role="main" id="main-content">

    <!-- Error Banner (hidden by default) -->
    <div class="error-banner" role="alert" aria-live="assertive" id="error-banner">
      <span class="error-banner-icon" aria-hidden="true">⚠</span>
      <span class="error-banner-text" id="error-text">Connection lost. Metrics may be stale.</span>
      <button class="error-banner-dismiss" onclick="dismissError()" aria-label="Dismiss">×</button>
    </div>

    <!-- SSE Disconnection Warning -->
    <div class="sse-status-warning" id="sse-warning" role="alert">
      <span>Memory diagnostics stream disconnected. Last update: <span id="sse-last-update">--</span></span>
    </div>

    <!-- Capacity Warning Banner -->
    <div class="capacity-warning-banner" id="capacity-warning-banner" role="alert" aria-live="polite">
      <span class="capacity-warning-icon" aria-hidden="true">!</span>
      <span class="capacity-warning-text">Memory pool(s) approaching capacity</span>
    </div>

    <!-- ==================== RUNTIME METRICS ==================== -->
    <section class="section-group runtime-section" aria-labelledby="runtime-section-title">
      <div class="section-header">
        <div class="section-icon runtime" aria-hidden="true">RT</div>
        <h2 class="section-title" id="runtime-section-title">Runtime</h2>
        <span class="section-subtitle">Interpreter, GC, and Memory</span>
        <div class="section-badges" aria-label="Section status">
          <span class="section-badge" id="vm-gc-badge">-- cycles</span>
          <span class="section-badge" id="vm-heap-badge">-- heap</span>
        </div>
      </div>

      <div class="grid-2">
        <!-- GC Panel with collapse support -->
        <article class="panel" aria-labelledby="gc-panel-title" id="gc-panel">
          <div class="panel-header" onclick="togglePanel('gc-panel')" role="button" tabindex="0" aria-expanded="true">
            <div class="panel-icon gc" aria-hidden="true">G</div>
            <h3 class="panel-title" id="gc-panel-title">Garbage Collector</h3>
            <span class="panel-summary" id="gc-summary">-- cycles, --ms max</span>
            <div class="panel-badge" id="gc-cycles-badge" title="Total number of GC cycles since process start">-- cycles</div>
            <span class="expand-icon" aria-hidden="true">▼</span>
          </div>
          <div class="panel-body">
            <div class="gc-timeline" id="gc-timeline" role="img" aria-label="GC pause timeline" title="Timeline showing GC pause durations over the last 60 seconds. Tall bars indicate long stop-the-world pauses that may cause request latency spikes. Yellow bars exceed 10ms, red bars exceed 50ms.">
              <div class="gc-timeline-threshold" style="bottom: 40px;">
                <span class="gc-timeline-threshold-label">10ms</span>
              </div>
              <div class="gc-timeline-axis">
                <span>-60s</span>
                <span>-45s</span>
                <span>-30s</span>
                <span>-15s</span>
                <span>now</span>
              </div>
            </div>
            <div class="gc-stats" role="list" aria-label="GC statistics">
              <div class="gc-stat" role="listitem" title="Total GC cycles since process start. Rapidly increasing cycle count indicates high allocation rate or memory pressure. Compare with heap usage to assess GC efficiency.">
                <div class="gc-stat-value" id="gc-cycles">--</div>
                <div class="gc-stat-label">Cycles</div>
              </div>
              <div class="gc-stat" role="listitem" title="Longest single GC pause observed. Pauses >10ms impact P99 latency. Pauses >100ms may cause connection timeouts. Reduce by lowering heap size or optimizing allocation patterns.">
                <div class="gc-stat-value" id="gc-max-pause">--<span class="unit">ms</span></div>
                <div class="gc-stat-label">Max Pause</div>
              </div>
              <div class="gc-stat" role="listitem" title="Average GC pause duration. Should stay under 5ms for low-latency services. If avg is high but max is similar, GC is consistently slow - consider heap tuning.">
                <div class="gc-stat-value" id="gc-avg-pause">--<span class="unit">ms</span></div>
                <div class="gc-stat-label">Avg Pause</div>
              </div>
              <div class="gc-stat" role="listitem" title="Total memory freed by GC. High reclaim rate with stable heap indicates healthy turnover. Low reclaim with growing heap suggests memory leak - investigate long-lived allocations.">
                <div class="gc-stat-value" id="gc-reclaimed">--<span class="unit">MB</span></div>
                <div class="gc-stat-label">Reclaimed</div>
              </div>
            </div>
          </div>
        </article>

        <!-- Interpreter with collapse support -->
        <article class="panel" aria-labelledby="interp-panel-title" id="interp-panel">
          <div class="panel-header" onclick="togglePanel('interp-panel')" role="button" tabindex="0" aria-expanded="true">
            <div class="panel-icon interp" aria-hidden="true">I</div>
            <h3 class="panel-title" id="interp-panel-title">Interpreter</h3>
            <span class="panel-summary" id="interp-summary">-- evals, -- fn calls</span>
            <span class="expand-icon" aria-hidden="true">▼</span>
          </div>
          <div class="panel-body">
            <div class="metrics-inline">
              <span class="metric-inline" title="Total expression evaluations">
                <span class="metric-inline-label">Evals:</span>
                <span class="metric-inline-value" id="interp-evals">--</span>
              </span>
              <span class="metric-inline-sep">│</span>
              <span class="metric-inline" title="User-defined function calls">
                <span class="metric-inline-label">Fn:</span>
                <span class="metric-inline-value" id="interp-fn-calls">--</span>
              </span>
              <span class="metric-inline-sep">│</span>
              <span class="metric-inline" title="Built-in function calls">
                <span class="metric-inline-label">Builtin:</span>
                <span class="metric-inline-value" id="interp-builtins">--</span>
              </span>
              <span class="metric-inline-sep">│</span>
              <span class="metric-inline" title="Max call stack depth">
                <span class="metric-inline-label">Stack:</span>
                <span class="metric-inline-value" id="interp-stack-depth">--</span>
              </span>
              <span class="metric-inline-sep">│</span>
              <span class="metric-inline" title="Closures created">
                <span class="metric-inline-label">Closures:</span>
                <span class="metric-inline-value" id="interp-closures">--</span>
              </span>
              <span class="metric-inline-sep">│</span>
              <span class="metric-inline" title="Environment lookups">
                <span class="metric-inline-label">Lookups:</span>
                <span class="metric-inline-value" id="interp-env-lookups">--</span>
              </span>
            </div>
          </div>
        </article>
      </div>

      <!-- Runtime Memory (Consolidated) -->
      <div class="subsection-header memory-subsection-header" id="memory-subsection">
        <h3 class="subsection-title">Memory</h3>
        <div class="process-memory-overview">
          <div class="process-gauge-inline" title="Memory pressure: RSS as % of system RAM">
            <div class="process-gauge-bar">
              <div class="process-gauge-fill" id="process-gauge-fill"></div>
            </div>
          </div>
          <span class="process-memory-stats">
            <span class="process-stat">RSS: <span id="process-rss-text">--</span></span>
            <span class="process-stat-sep">/</span>
            <span class="process-stat">VMS: <span id="process-vms-text">--</span></span>
          </span>
          <button class="breakdown-toggle" onclick="toggleBreakdown()" aria-expanded="false" aria-controls="process-breakdown" title="Show memory breakdown">
            <span class="breakdown-toggle-icon">▼</span>
          </button>
        </div>
      </div>

      <!-- Collapsible Process Breakdown -->
      <div class="process-breakdown collapsed" id="process-breakdown">
        <!-- Stacked bar: segment width = capacity, inner fill = used -->
        <div class="stacked-bar">
          <div class="stacked-segment gc-heap" id="segment-gc-heap" title="GC Heap">
            <div class="segment-fill" id="fill-gc-heap"></div>
          </div>
          <div class="stacked-segment scratch" id="segment-scratch" title="Scratch Arena">
            <div class="segment-fill" id="fill-scratch"></div>
          </div>
          <div class="stacked-segment aio" id="segment-aio" title="AIO Slabs">
            <div class="segment-fill" id="fill-aio"></div>
          </div>
          <div class="stacked-segment metrics" id="segment-metrics" title="Metrics Registry">
            <div class="segment-fill" id="fill-metrics"></div>
          </div>
          <div class="stacked-segment untracked" id="segment-untracked" title="Untracked">
            <div class="segment-fill" id="fill-untracked"></div>
          </div>
        </div>

        <!-- Legend: shows used / capacity per subsystem -->
        <!-- Box diagonal: solid (bottom-right) = resident, muted (top-left) = reserved -->
        <div class="breakdown-legend">
          <div class="legend-item">
            <span class="legend-dot gc-heap"><span class="legend-dot-fill"></span></span>
            <span class="legend-label">GC Heap</span>
            <span class="legend-value" id="breakdown-gc-heap-value">--</span>
            <span class="legend-cap">/ <span id="breakdown-gc-heap-cap">--</span></span>
            <span class="legend-pct" id="breakdown-gc-heap-pct">(--%)</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot scratch"><span class="legend-dot-fill"></span></span>
            <span class="legend-label">Scratch</span>
            <span class="legend-value" id="breakdown-scratch-value">--</span>
            <span class="legend-cap">/ <span id="breakdown-scratch-cap">--</span></span>
            <span class="legend-pct" id="breakdown-scratch-pct">(--%)</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot aio"><span class="legend-dot-fill"></span></span>
            <span class="legend-label">AIO</span>
            <span class="legend-value" id="breakdown-aio-value">--</span>
            <span class="legend-cap">/ <span id="breakdown-aio-cap">--</span></span>
            <span class="legend-pct" id="breakdown-aio-pct">(--%)</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot metrics"><span class="legend-dot-fill"></span></span>
            <span class="legend-label">Metrics</span>
            <span class="legend-value" id="breakdown-metrics-value">--</span>
            <span class="legend-cap">/ <span id="breakdown-metrics-cap">--</span></span>
            <span class="legend-pct" id="breakdown-metrics-pct">(--%)</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot untracked"><span class="legend-dot-fill"></span></span>
            <span class="legend-label">Untracked</span>
            <span class="legend-value" id="breakdown-untracked-value">--</span>
            <span class="legend-cap">/ <span id="breakdown-untracked-cap">--</span></span>
            <span class="legend-pct" id="breakdown-untracked-pct">(--%)</span>
          </div>
        </div>

        <!-- GC Heap sub-breakdown -->
        <div class="gc-sub-breakdown">
          <span class="gc-sub-label">GC breakdown:</span>
          <span class="gc-sub-item"><span class="legend-dot lval"></span>LVAL <span id="breakdown-gc-lval-value">--</span></span>
          <span class="gc-sub-item"><span class="legend-dot lenv"></span>LENV <span id="breakdown-gc-lenv-value">--</span></span>
          <span class="gc-sub-item"><span class="legend-dot malloc"></span>Malloc <span id="breakdown-gc-malloc-value">--</span></span>
        </div>

        <!-- Footer stats -->
        <div class="breakdown-footer">
          <span>VMS: <span id="process-vms">--</span></span>
          <span class="sep">•</span>
          <span>Page Faults: <span id="process-pf-minor">--</span> minor / <span id="process-pf-major">--</span> major</span>
        </div>
      </div>

      <div class="vm-memory-consolidated">
        <!-- Arenas (dynamically populated from server data) -->
        <div class="memory-block arenas-block">
          <div class="memory-block-header">
            <div class="memory-block-title">
              <span class="memory-icon arena">A</span>
              Arenas
            </div>
          </div>
          <div class="memory-block-body">
            <div class="arena-tiers" id="arenas-container">
              <!-- Arena PoolWidgets initialized dynamically from SSE data -->
            </div>
          </div>
        </div>

        <!-- GC Heap (Tiered: LVAL Slab + LENV Slab + Malloc) -->
        <div class="memory-block gc-heap-block">
          <div class="memory-block-header">
            <div class="memory-block-title">
              <span class="memory-icon gc">GC</span>
              GC Heap
            </div>
            <div class="memory-block-summary">
              <span class="usage-pct" id="heap-gauge-value">--</span>% used
              <span class="usage-detail">(<span id="heap-used">--</span> / <span id="heap-total">--</span>)</span>
            </div>
          </div>
          <div class="memory-block-body">
            <!-- Tiered heap: LVAL Slab (values) + LENV Slab (environments) + Malloc (overflow) -->
            <div class="heap-tiers" id="heap-tiers-container">
              <!-- LVAL Slab, LENV Slab, and Malloc PoolWidgets initialized by JS -->
            </div>
            <!-- Shared legend for all tiers -->
            <div class="pool-widget-legend" id="heap-legend">
              <span class="pool-widget-legend-item"><span class="pool-widget-legend-bar" style="background: linear-gradient(90deg, var(--color-cyan), var(--color-warning))"></span>current</span>
              <span class="pool-widget-legend-item"><span class="pool-widget-legend-marker" style="background: var(--color-info)"></span>high water mark</span>
              <span class="pool-widget-legend-item"><span class="pool-widget-legend-marker" style="background: var(--color-error)"></span>gc threshold</span>
              <span class="pool-widget-legend-item" style="margin-left: auto; font-family: var(--font-mono);">reclaimed: <span id="heap-reclaimed">--</span></span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== AIO SYSTEMS ==================== -->
    <!-- Phase 2: HTTP Servers and Clients are now nested under their parent AIO system -->
    <section class="section-group aio-section" aria-labelledby="aio-section-title">
      <div class="section-header">
        <div class="section-icon aio" aria-hidden="true">AIO</div>
        <h2 class="section-title" id="aio-section-title">Async I/O System</h2>
        <span class="section-subtitle">Event Loop, Resources, Servers & Clients</span>
        <div class="section-badges">
          <span class="section-badge" id="aio-systems-badge" title="Number of independent AIO event loop systems. Each system has its own connection pool and buffers.">-- systems</span>
          <span class="section-badge" id="aio-conns-badge" title="Total active connections across all AIO systems. High connection count may indicate connection leaks or slow clients.">-- conns</span>
          <span class="section-badge" id="http-servers-count" title="Number of HTTP server endpoints listening for requests.">-- servers</span>
          <span class="section-badge" id="http-total-rate" title="Combined request rate across all HTTP servers.">-- req/s</span>
        </div>
      </div>

      <div id="aio-systems-container">
        <!-- AIO system panels will be dynamically populated here -->
        <!-- Each panel now contains: Event Loop, Shared Pools, HTTP Servers, HTTP Clients -->
        <div class="panel" id="aio-no-systems">
          <div class="panel-body" style="text-align: center; color: var(--text-muted); padding: var(--space-xl);">
            No AIO systems registered
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== METRICS SYSTEM ==================== -->
    <section class="section-group metrics-section" aria-labelledby="metrics-section-title">
      <div class="section-header">
        <div class="section-icon metrics" aria-hidden="true">M</div>
        <h2 class="section-title" id="metrics-section-title">Metrics Registry</h2>
        <span class="section-subtitle">Counters, Gauges, Histograms & String Pool</span>
        <div class="section-badges">
          <span class="section-badge" id="metrics-total-badge" title="Total active metrics in registry">-- metrics</span>
          <span class="section-badge" id="metrics-strings-badge" title="Interned strings for metric names and labels">-- strings</span>
        </div>
      </div>

      <div class="registry-content">
        <div class="registry-stats-grid">
          <!-- Counters -->
          <div class="registry-stat-card" title="Counter metrics track monotonically increasing values like total requests or bytes processed">
            <div class="registry-stat-header">
              <span class="registry-stat-icon counter">C</span>
              <span class="registry-stat-label">Counters</span>
            </div>
            <div class="registry-stat-bar">
              <div class="registry-stat-fill" id="registry-counters-bar" style="width: 0%"></div>
            </div>
            <div class="registry-stat-values">
              <span class="registry-stat-active" id="registry-counters-active">--</span>
              <span class="registry-stat-sep">/</span>
              <span class="registry-stat-capacity" id="registry-counters-capacity">--</span>
              <span class="registry-stat-detail">(<span id="registry-counters-free">--</span> free)</span>
            </div>
          </div>
          <!-- Gauges -->
          <div class="registry-stat-card" title="Gauge metrics track values that can go up or down like active connections or memory usage">
            <div class="registry-stat-header">
              <span class="registry-stat-icon gauge">G</span>
              <span class="registry-stat-label">Gauges</span>
            </div>
            <div class="registry-stat-bar">
              <div class="registry-stat-fill" id="registry-gauges-bar" style="width: 0%"></div>
            </div>
            <div class="registry-stat-values">
              <span class="registry-stat-active" id="registry-gauges-active">--</span>
              <span class="registry-stat-sep">/</span>
              <span class="registry-stat-capacity" id="registry-gauges-capacity">--</span>
              <span class="registry-stat-detail">(<span id="registry-gauges-free">--</span> free)</span>
            </div>
          </div>
          <!-- Histograms -->
          <div class="registry-stat-card" title="Histogram metrics track distributions like request latency with configurable buckets">
            <div class="registry-stat-header">
              <span class="registry-stat-icon histogram">H</span>
              <span class="registry-stat-label">Histograms</span>
            </div>
            <div class="registry-stat-bar">
              <div class="registry-stat-fill" id="registry-histograms-bar" style="width: 0%"></div>
            </div>
            <div class="registry-stat-values">
              <span class="registry-stat-active" id="registry-histograms-active">--</span>
              <span class="registry-stat-sep">/</span>
              <span class="registry-stat-capacity" id="registry-histograms-capacity">--</span>
              <span class="registry-stat-detail">(<span id="registry-histograms-free">--</span> free)</span>
            </div>
          </div>
          <!-- String Pool -->
          <div class="registry-stat-card" title="Interned strings for metric names and labels - reused across metrics for memory efficiency">
            <div class="registry-stat-header">
              <span class="registry-stat-icon strings">S</span>
              <span class="registry-stat-label">String Pool</span>
            </div>
            <div class="registry-stat-bar">
              <div class="registry-stat-fill" id="registry-strings-bar" style="width: 0%"></div>
            </div>
            <div class="registry-stat-values">
              <span class="registry-stat-active" id="registry-strings-used">--</span>
              <span class="registry-stat-sep">/</span>
              <span class="registry-stat-capacity" id="registry-strings-capacity">--</span>
            </div>
          </div>
        </div>
        <!-- Eviction Stats -->
        <div class="registry-eviction-stats" title="Stale metrics are automatically evicted to free registry slots. High eviction counts may indicate metric cardinality explosion.">
          <span class="registry-eviction-label">Evictions:</span>
          <span class="registry-eviction-value" id="registry-evictions-total">--</span>
          <span class="registry-eviction-breakdown">
            (C: <span id="registry-evictions-counters">--</span>,
             G: <span id="registry-evictions-gauges">--</span>,
             H: <span id="registry-evictions-histograms">--</span>)
          </span>
          <span class="registry-collect-time">
            collect: <span id="registry-collect-time">--</span>μs
          </span>
        </div>
      </div>
    </section>

  </main>
  <script>
